-- Encapsulamos toda tu consulta principal en una CTE llamada BASE
WITH 
CORREOS_UNIFICADOS AS (
  SELECT 
    n.numero_documento AS numero_documento,
    n.tipdoc_codigo AS tipo_documento,
    MIN(mcn.descripcion) AS correo_unificado
  FROM naturales n
  JOIN medios_comunicacion mcn 
    ON mcn.nat_secuencia = n.secuencia
  JOIN tipos_medios_comunicacion tmcn 
    ON tmcn.secuencia = mcn.tipmedcom_codigo
  WHERE tmcn.descripcion LIKE '%EMAIL%'
    AND mcn.descripcion LIKE '%@%'
  GROUP BY n.numero_documento, n.tipdoc_codigo

  UNION

  SELECT 
    j.numero_documento AS numero_documento,
    j.tipdoc_codigo AS tipo_documento,
    MIN(mcj.descripcion) AS correo_unificado
  FROM juridicos j
  JOIN medios_comunicacion mcj 
    ON mcj.jur_secuencia = j.secuencia
  JOIN tipos_medios_comunicacion tmcj 
    ON tmcj.secuencia = mcj.tipmedcom_codigo
  WHERE tmcj.descripcion LIKE '%EMAIL%'
    AND mcj.descripcion LIKE '%@%'
  GROUP BY j.numero_documento, j.tipdoc_codigo
),

POLIZA_UNICA AS (
  SELECT *
  FROM (
    SELECT 
      a.COD_CIA,
      a.tdoc_tercero,
      a.nro_documto,
      a.NUM_POL1,
      a.cod_ramo,
      a.COD_SECC,
      a.FECHA_VENC_POL,
      ROW_NUMBER() OVER (
        PARTITION BY a.COD_CIA, a.tdoc_tercero, a.nro_documto 
        ORDER BY a.FECHA_VENC_POL ASC NULLS LAST
      ) AS rn
    FROM A2000030 a
    WHERE a.FECHA_VENC_POL >= SYSDATE
  )
  WHERE rn = 1 AND COD_RAMO != 315
),

CELULAR_UNIFICADO AS (
  SELECT *
  FROM (
    SELECT 
      j.numero_documento AS numero_documento,
      j.tipdoc_codigo AS tipo_documento,
      CASE
        WHEN REGEXP_LIKE(TRIM(mcn.descripcion), '^[0-9]{10}$') THEN TRIM(mcn.descripcion)
        WHEN REGEXP_LIKE(TRIM(mcj.descripcion), '^[0-9]{10}$') THEN TRIM(mcj.descripcion)
        ELSE NULL
      END AS celular_unificado,
      ROW_NUMBER() OVER (
        PARTITION BY j.tipdoc_codigo, j.numero_documento
        ORDER BY j.numero_documento
      ) AS rn
    FROM juridicos j
    JOIN naturales n
      ON n.numero_documento = j.numero_documento_representante
     AND n.tipdoc_codigo = j.tipdoc_codigo_identificado_por
    JOIN medios_comunicacion mcn
      ON mcn.nat_secuencia = n.secuencia
    JOIN tipos_medios_comunicacion tmcn
      ON tmcn.secuencia = mcn.tipmedcom_codigo
    JOIN medios_comunicacion mcj
      ON mcj.jur_secuencia = j.secuencia
    JOIN tipos_medios_comunicacion tmcj
      ON tmcj.secuencia = mcj.tipmedcom_codigo
    WHERE (tmcn.descripcion LIKE '%CELULAR%' OR tmcj.descripcion LIKE '%CELULAR%')

    UNION ALL

    SELECT 
      n.numero_documento,
      n.tipdoc_codigo,
      CASE 
        WHEN REGEXP_LIKE(TRIM(mcn.descripcion), '^[0-9]{10}$') THEN TRIM(mcn.descripcion)
        ELSE NULL
      END AS celular_unificado,
      ROW_NUMBER() OVER (
        PARTITION BY n.tipdoc_codigo, n.numero_documento
        ORDER BY n.numero_documento
      ) AS rn
    FROM naturales n
    JOIN medios_comunicacion mcn ON mcn.nat_secuencia = n.secuencia
    JOIN tipos_medios_comunicacion tmcn ON tmcn.secuencia = mcn.tipmedcom_codigo
    WHERE tmcn.descripcion LIKE '%CELULAR%'
  )
  WHERE rn = 1
),

BASE AS (
  SELECT 
    m.exrf_cod_cia AS codigo_compania,
    m.exrf_cod_tipo_persona AS tipo_persona,
    m.exrf_cod_tip_doc AS cod_tipo_doc,  
    m.exrf_num_id_cliente AS num_id,

    REPLACE(TRIM(m.exrf_nombre_cli_razon_social), '-', '') AS nombre,

    CASE 
      WHEN TRUNC(m.exrf_fecha_nacim) = TO_DATE('01/01/1900','dd/mm/yyyy') THEN NULL
      ELSE TO_CHAR(m.exrf_fecha_nacim, 'dd/mm/yyyy')
    END AS fecha_nacimiento,

    CASE 
      WHEN cu2.celular_unificado IS NOT NULL THEN cu2.celular_unificado
      ELSE NULLIF(TRIM(m.exrf_telefono_residencia), '')
    END AS telefono_contacto,

    NULLIF(TRIM(cu.correo_unificado), '') AS correo,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 
           AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_activos 
    END AS vlr_activos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 
           AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_pasivos 
    END AS vlr_pasivos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 
           AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_ingresos 
    END AS vlr_ingresos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 
           AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_egresos 
    END AS vlr_egresos,

    TO_CHAR(
      NVL(m.exrf_fecha_creacion_terc, TO_DATE('01/01/1900','dd/mm/yyyy')), 
      'dd/mm/yyyy'
    ) AS fecha_vinculacion_cliente,

    p.NUM_POL1,
    p.cod_ramo AS COD_PROD,
    p.COD_SECC AS COD_RAMO,
    TO_CHAR(p.FECHA_VENC_POL, 'dd/mm/yyyy') AS fecha_venc_pol

  FROM dc_ext_revisoria_fiscal m

  LEFT JOIN CORREOS_UNIFICADOS cu 
    ON cu.numero_documento = m.exrf_num_id_cliente
   AND cu.tipo_documento = m.exrf_cod_tip_doc

  LEFT JOIN POLIZA_UNICA p
    ON p.COD_CIA = m.exrf_cod_cia
   AND p.tdoc_tercero = m.exrf_cod_tip_doc
   AND p.nro_documto = m.exrf_num_id_cliente

  LEFT JOIN CELULAR_UNIFICADO cu2
    ON cu2.numero_documento = m.exrf_num_id_cliente
   AND cu2.tipo_documento = m.exrf_cod_tip_doc

  WHERE 
    m.exrf_cod_tipo_persona IS NOT NULL
    AND m.exrf_cod_tip_doc IS NOT NULL
    AND (
      m.exrf_cod_cia IN (1, 2)
      OR (m.exrf_cod_cia = 3 AND p.COD_RAMO IS NOT NULL)
    )
),

CONSISTENCIA AS (
  SELECT 
    codigo_compania,
    SUM(NVL(vlr_activos, 0)) AS sum_activos,
    SUM(NVL(vlr_pasivos, 0)) AS sum_pasivos,
    SUM(NVL(vlr_ingresos, 0)) AS sum_ingresos,
    SUM(NVL(vlr_egresos, 0)) AS sum_egresos,
    SUM(ABS(NVL(vlr_activos, 0) - NVL(vlr_pasivos, 0))) AS desv_activos,
    SUM(ABS(NVL(vlr_ingresos, 0) - NVL(vlr_egresos, 0))) AS desv_ingresos
  FROM BASE
  GROUP BY codigo_compania
)

-- Consulta final con completitud + consistencia
SELECT 
  b.codigo_compania,
  COUNT(*) AS total_registros,

  ROUND(1 - (SUM(CASE WHEN nombre IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_nombre,
  ROUND(1 - (SUM(CASE WHEN fecha_nacimiento IS NULL OR TRIM(fecha_nacimiento) = '' THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_fecha_nacimiento,
  ROUND(1 - (SUM(CASE WHEN telefono_contacto IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_telefono,
  ROUND(1 - (SUM(CASE WHEN correo IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_correo,
  ROUND(1 - (SUM(CASE WHEN vlr_activos IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_vlr_activos,
  ROUND(1 - (SUM(CASE WHEN vlr_pasivos IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_vlr_pasivos,
  ROUND(1 - (SUM(CASE WHEN vlr_ingresos IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_vlr_ingresos,
  ROUND(1 - (SUM(CASE WHEN vlr_egresos IS NULL THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_vlr_egresos,
  ROUND(1 - (SUM(CASE WHEN fecha_vinculacion_cliente IS NULL OR TRIM(fecha_vinculacion_cliente) = '' THEN 1 ELSE 0 END) * 1.0 / COUNT(*)), 2) AS completitud_fecha_vinculacion,

  -- Consistencias a√±adidas
  CASE WHEN c.sum_activos = 0 THEN NULL
       ELSE ROUND(1 - (c.desv_activos / c.sum_activos), 3)
  END AS consistencia_activos,

  CASE WHEN c.sum_ingresos = 0 THEN NULL
       ELSE ROUND(1 - (c.desv_ingresos / c.sum_ingresos), 3)
  END AS consistencia_ingresos

FROM BASE b
LEFT JOIN CONSISTENCIA c ON b.codigo_compania = c.codigo_compania
GROUP BY b.codigo_compania, c.sum_activos, c.desv_activos, c.sum_ingresos, c.desv_ingresos
ORDER BY b.codigo_compania;
