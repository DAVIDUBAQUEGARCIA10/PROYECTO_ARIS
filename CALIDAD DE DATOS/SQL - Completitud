WITH CORREOS_UNIFICADOS AS (
  SELECT 
    n.numero_documento AS numero_documento,
    n.tipdoc_codigo AS tipo_documento,
    MIN(mcn.descripcion) AS correo_unificado
  FROM naturales n
  JOIN medios_comunicacion mcn ON mcn.nat_secuencia = n.secuencia
  JOIN tipos_medios_comunicacion tmcn ON tmcn.secuencia = mcn.tipmedcom_codigo
  WHERE tmcn.descripcion LIKE '%EMAIL%' AND mcn.descripcion LIKE '%@%'
  GROUP BY n.numero_documento, n.tipdoc_codigo

  UNION

  SELECT 
    j.numero_documento AS numero_documento,
    j.tipdoc_codigo AS tipo_documento,
    MIN(mcj.descripcion) AS correo_unificado
  FROM juridicos j
  JOIN medios_comunicacion mcj ON mcj.jur_secuencia = j.secuencia
  JOIN tipos_medios_comunicacion tmcj ON tmcj.secuencia = mcj.tipmedcom_codigo
  WHERE tmcj.descripcion LIKE '%EMAIL%' AND mcj.descripcion LIKE '%@%'
  GROUP BY j.numero_documento, j.tipdoc_codigo
),

POLIZA_UNICA AS (
  SELECT *
  FROM (
    SELECT 
      a.COD_CIA,
      a.tdoc_tercero,
      a.nro_documto,
      a.NUM_POL1,
      a.cod_ramo,
      a.COD_SECC,
      a.FECHA_VENC_POL,
      ROW_NUMBER() OVER (
        PARTITION BY a.COD_CIA, a.tdoc_tercero, a.nro_documto 
        ORDER BY a.FECHA_VENC_POL ASC NULLS LAST
      ) AS rn
    FROM A2000030 a
    WHERE a.FECHA_VENC_POL >= SYSDATE
  )
  WHERE rn = 1 AND COD_RAMO != 315
),

BASE_DATOS AS (
  SELECT 
    m.exrf_cod_cia AS codigo_compania,
    m.exrf_telefono_residencia,
    m.exrf_fecha_nacim,
    cu.correo_unificado AS correo,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_activos 
    END AS vlr_activos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_pasivos 
    END AS vlr_pasivos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_ingresos 
    END AS vlr_ingresos,

    CASE 
      WHEN m.exrf_vlr_activos = 0 AND m.exrf_vlr_pasivos = 0 AND m.exrf_vlr_ingresos = 0 AND m.exrf_vlr_egresos = 0 
      THEN NULL ELSE m.exrf_vlr_egresos 
    END AS vlr_egresos

  FROM dc_ext_revisoria_fiscal m
  LEFT JOIN CORREOS_UNIFICADOS cu 
    ON cu.numero_documento = m.exrf_num_id_cliente
    AND cu.tipo_documento = m.exrf_cod_tip_doc
  LEFT JOIN POLIZA_UNICA p
    ON p.COD_CIA = m.exrf_cod_cia
    AND p.tdoc_tercero = m.exrf_cod_tip_doc
    AND p.nro_documto = m.exrf_num_id_cliente
  WHERE 
    m.exrf_cod_tipo_persona IS NOT NULL
    AND m.exrf_cod_tip_doc IS NOT NULL
    AND (
      m.exrf_cod_cia IN (1, 2)
      OR (m.exrf_cod_cia = 3 AND p.COD_RAMO IS NOT NULL)
    )
)

SELECT 
  codigo_compania,
  COUNT(*) AS total_registros,
  ROUND(1 - (SUM(CASE WHEN correo IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_correo,
  ROUND(1 - (SUM(CASE WHEN exrf_telefono_residencia IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_telefono,
  ROUND(1 - (SUM(CASE WHEN exrf_fecha_nacim IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_fecha_nacim,
  ROUND(1 - (SUM(CASE WHEN vlr_activos IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_activos,
  ROUND(1 - (SUM(CASE WHEN vlr_pasivos IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_pasivos,
  ROUND(1 - (SUM(CASE WHEN vlr_ingresos IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_ingresos,
  ROUND(1 - (SUM(CASE WHEN vlr_egresos IS NULL THEN 1 ELSE 0 END) / COUNT(*)), 4) AS completitud_egresos
FROM BASE_DATOS
GROUP BY codigo_compania
ORDER BY codigo_compania;
