-- ===========================
-- BLOQUE 1: PERSONAS JURÍDICAS
-- ===========================
SELECT 
    j.SECUENCIA,
    j.NUMERO_DOCUMENTO                      AS NUMERO_DOCUMENTO,
    j.TIPDOC_CODIGO                         AS TIPDOC_CODIGO,
    j.RAZON_SOCIAL                          AS NOMBRE_COMPLETO,
    j.DIGITO_CHEQUEO,
    NULL                                    AS FECHA_NACIMIENTO,
    j.FECHA_CREACION,
    'JURIDICA'                              AS TIPO_PERSONA,

    -- Representante legal
    n.NUMERO_DOCUMENTO                      AS NUMERO_DOCUMENTO_REP,
    n.TIPDOC_CODIGO                         AS TIPO_DOCUMENTO_REP,
    CONCAT(
        COALESCE(n.PRIMER_NOMBRE, ''), ' ',
        COALESCE(n.SEGUNDO_NOMBRE, ''), ' ',
        COALESCE(n.PRIMER_APELLIDO, ''), ' ',
        COALESCE(n.SEGUNDO_APELLIDO, '')
    ) AS NOMBRES_REP,
    n.FECHA_NACIMIENTO                      AS FECHA_NACIMIENTO_REP,

    -- Medios de comunicación del representante
    mcn.TIPMEDCOM_CODIGO                    AS COD_MEDIO_COMUNICA_REP,
    tmcn.DESCRIPCION                        AS DESC_TIPO_MEDIO_COMUNICA_REP,
    mcn.DESCRIPCION                         AS DESC_MEDIO_COMUNICA_REP,

    -- Medios de comunicación de la empresa
    mcj.TIPMEDCOM_CODIGO                    AS COD_MEDIO_COMUNICA_JUR,
    tmcj.DESCRIPCION                        AS DESC_TIPO_MEDIO_COMUNICA_JUR,
    mcj.DESCRIPCION                         AS DESC_MEDIO_COMUNICA_JUR,

    -- Estado financiero más reciente
    ef.*

FROM JURIDICOS j
JOIN NATURALES n
    ON n.NUMERO_DOCUMENTO = j.NUMERO_DOCUMENTO_REPRESENTANTE
   AND n.TIPDOC_CODIGO = j.TIPDOC_CODIGO_IDENTIFICADO_POR
LEFT JOIN MEDIOS_COMUNICACION mcn
    ON mcn.NAT_SECUENCIA = n.SECUENCIA
LEFT JOIN TIPOS_MEDIOS_COMUNICACION tmcn
    ON tmcn.SECUENCIA = mcn.TIPMEDCOM_CODIGO
LEFT JOIN MEDIOS_COMUNICACION mcj
    ON mcj.JUR_SECUENCIA = j.SECUENCIA
LEFT JOIN TIPOS_MEDIOS_COMUNICACION tmcj
    ON tmcj.SECUENCIA = mcj.TIPMEDCOM_CODIGO
LEFT JOIN ESTADOS_FINANCIEROS ef
    ON ef.JUR_SECUENCIA = j.SECUENCIA
   AND ef.SECUENCIA = (
        SELECT MAX(ef1.SECUENCIA)
        FROM ESTADOS_FINANCIEROS ef1
        WHERE ef1.JUR_SECUENCIA = j.SECUENCIA
    )

-- ===========================
UNION ALL
-- ===========================

-- ===========================
-- BLOQUE 2: PERSONAS NATURALES
-- ===========================
SELECT 
    n.SECUENCIA,
    n.NUMERO_DOCUMENTO,
    n.TIPDOC_CODIGO,
    CONCAT(
        COALESCE(n.PRIMER_NOMBRE, ''), ' ',
        COALESCE(n.SEGUNDO_NOMBRE, ''), ' ',
        COALESCE(n.PRIMER_APELLIDO, ''), ' ',
        COALESCE(n.SEGUNDO_APELLIDO, '')
    ) AS NOMBRE_COMPLETO,
    n.DIGITO_CHEQUEO,
    n.FECHA_NACIMIENTO,
    n.FECHA_CREACION,
    'NATURAL' AS TIPO_PERSONA,

    NULL AS NUMERO_DOCUMENTO_REP,
    NULL AS TIPO_DOCUMENTO_REP,
    NULL AS NOMBRES_REP,
    NULL AS FECHA_NACIMIENTO_REP,

    -- Medios de comunicación del natural
    mcn.TIPMEDCOM_CODIGO                    AS COD_MEDIO_COMUNICA_REP,
    tmcn.DESCRIPCION                        AS DESC_TIPO_MEDIO_COMUNICA_REP,
    mcn.DESCRIPCION                         AS DESC_MEDIO_COMUNICA_REP,

    -- Campos vacíos para jurídicos
    NULL AS COD_MEDIO_COMUNICA_JUR,
    NULL AS DESC_TIPO_MEDIO_COMUNICA_JUR,
    NULL AS DESC_MEDIO_COMUNICA_JUR,

    -- Estado financiero más reciente
    ef.*

FROM NATURALES n
LEFT JOIN MEDIOS_COMUNICACION mcn
    ON mcn.NAT_SECUENCIA = n.SECUENCIA
LEFT JOIN TIPOS_MEDIOS_COMUNICACION tmcn
    ON tmcn.SECUENCIA = mcn.TIPMEDCOM_CODIGO
LEFT JOIN ESTADOS_FINANCIEROS ef 
    ON ef.NAT_SECUENCIA = n.SECUENCIA
   AND ef.SECUENCIA = (
        SELECT MAX(ef1.SECUENCIA)
        FROM ESTADOS_FINANCIEROS ef1
        WHERE ef1.NAT_SECUENCIA = n.SECUENCIA
    );
