select *
from   contactos c
where  c.jur_secuencia = 140089  --(ejemplo de la secuencia del juridico que se obtiene de la tabla juridicos
  and  c.porcentaje_participacion is not null
  and  c.secuencia = (select max(c1.secuencia)
                      from   contactos c1
                      where  c1.jur_secuencia = c.jur_secuencia
                        and  c1.numero_documento = c.numero_documento
                        and  c1.tipdoc_codigo = c.tipdoc_codigo)
  and  c.marca_activo = 'A'


---


SELECT 
    j.NUMERO_DOCUMENTO,
    j.TIPDOC_CODIGO,
    j.RAZON_SOCIAL,
    j.NUMERO_DOCUMENTO,
   j.OBSERVACIONES,
    j.FECHA_MODIFICACION,    
    j.MANEJA_MONEDA_EXTRANJERA,       
    j.OPERACIONES_INTERNACIONALES, 
    j.PUBLICAMENTE_EXPUESTA, 
    c."TIPDOC_CODIGO",    
    c.NUMERO_DOCUMENTO as NUM_DOCUMENTO_CONTACTO,
    c."NOMBRE_CONTACTO",
    c."CARGO_CONTACTO",
    c."USUARIO_CREACION",
    c."FECHA_CREACION",
    c."USUARIO_MODIFICACION",
    c."FECHA_MODIFICACION" AS "FECHA_MODIFICACION_CONTACTO",
    c."PORCENTAJE_PARTICIPACION",
    c."PUBLICAMENTE_EXPUESTA",
    c."COTIZA_BOLSA",
    c."MARCA_ACTIVO"
FROM 
    contactos c
JOIN 
    juridicos j ON j."SECUENCIA" = c."JUR_SECUENCIA"
WHERE  
    c."PORCENTAJE_PARTICIPACION" IS NOT NULL
    AND c."SECUENCIA" = (
        SELECT MAX(c1."SECUENCIA")
        FROM contactos c1
        WHERE c1."JUR_SECUENCIA" = c."JUR_SECUENCIA"
        AND c1."NUMERO_DOCUMENTO" = c."NUMERO_DOCUMENTO"
        AND c1."TIPDOC_CODIGO" = c."TIPDOC_CODIGO"
    )
    AND c."MARCA_ACTIVO" = 'A'


------

Para % de beneficiario final 


SELECT 
    j.NUMERO_DOCUMENTO,
    j.TIPDOC_CODIGO,
    c.NUMERO_DOCUMENTO as NUM_DOCUMENTO_CONTACTO,        
    c."TIPDOC_CODIGO",    
    c."PORCENTAJE_PARTICIPACION",
    c."FECHA_MODIFICACION" AS "FECHA_MODIFICACION_CONTACTO",
    c."MARCA_ACTIVO"
FROM 
    contactos c
JOIN 
    juridicos j ON j."SECUENCIA" = c."JUR_SECUENCIA"
WHERE  
    c."PORCENTAJE_PARTICIPACION" IS NOT NULL
    AND c."SECUENCIA" = (
        SELECT MAX(c1."SECUENCIA")
        FROM contactos c1
        WHERE c1."JUR_SECUENCIA" = c."JUR_SECUENCIA"
        AND c1."NUMERO_DOCUMENTO" = c."NUMERO_DOCUMENTO"
        AND c1."TIPDOC_CODIGO" = c."TIPDOC_CODIGO"
    )
    AND c."MARCA_ACTIVO" = 'A'



------------------------------------
Cuantificacion de poblamiento en core de beneficiario final 



/* ================================================================
   TABLA DINÁMICA FINAL: Clasificación × USUARIO_CREACION
   Reglas:
   - Mantiene USRDAVIVIENDA, USRINFORMACOLOM, USRSARLAFT
   - Agrupa nulos o vacíos como OTRO
   - Solo deja 'N/A' cuando la clasificación es 'SIN ACCIONISTAS'
   ================================================================ */

WITH
MAIN AS (
  SELECT DISTINCT exrf_num_id_cliente AS NIT
  FROM dc_ext_revisoria_fiscal
  WHERE exrf_cod_tipo_persona = 'J'
    AND exrf_cod_tip_doc IS NOT NULL
    AND exrf_nombre_cli_razon_social IS NOT NULL
    AND (:P_NIT IS NULL OR exrf_num_id_cliente = :P_NIT)
),
CONTACTO_ULTIMO AS (
  SELECT DISTINCT *
  FROM (
    SELECT DISTINCT
      c."JUR_SECUENCIA",
      c."TIPDOC_CODIGO",
      c."NUMERO_DOCUMENTO",
      c."NOMBRE_CONTACTO",
      c."CARGO_CONTACTO",
      c."USUARIO_CREACION",
      c."FECHA_CREACION",
      c."USUARIO_MODIFICACION",
      c."FECHA_MODIFICACION",
      c."PORCENTAJE_PARTICIPACION",
      c."PUBLICAMENTE_EXPUESTA",
      c."COTIZA_BOLSA",
      c."MARCA_ACTIVO",
      ROW_NUMBER() OVER (
        PARTITION BY c."JUR_SECUENCIA", c."TIPDOC_CODIGO", c."NUMERO_DOCUMENTO"
        ORDER BY c."SECUENCIA" DESC
      ) AS rn
    FROM contactos c
    WHERE c."MARCA_ACTIVO" = 'A'
      AND c."PORCENTAJE_PARTICIPACION" IS NOT NULL
  )
  WHERE rn = 1
),
SUM_PARTICIPACION AS (
  /* ---- Cálculo de la sumatoria por NIT ---- */
  SELECT
      j.NUMERO_DOCUMENTO                                      AS NIT,
      SUM(c."PORCENTAJE_PARTICIPACION")                       AS SUMA_RAW,
      COUNT(c."PORCENTAJE_PARTICIPACION")                     AS CNT_CON_PCT,
      CASE
          WHEN COUNT(c."PORCENTAJE_PARTICIPACION") = 0
               THEN 'SIN ACCIONISTAS'
          WHEN SUM(c."PORCENTAJE_PARTICIPACION") < 80
               THEN 'Menor a 80%'
          WHEN SUM(c."PORCENTAJE_PARTICIPACION") BETWEEN 80 AND 100
               THEN 'Entre 80% y 100%'
          WHEN SUM(c."PORCENTAJE_PARTICIPACION") > 100
               THEN 'Mayor a 100%'
          ELSE 'SIN ACCIONISTAS'
      END AS CLASIFICACION_PARTICIPACION
  FROM juridicos j
  LEFT JOIN CONTACTO_ULTIMO c
    ON c."JUR_SECUENCIA" = j."SECUENCIA"
  GROUP BY j.NUMERO_DOCUMENTO
),
NIT_USUARIO AS (
  SELECT DISTINCT
    j.NUMERO_DOCUMENTO AS NIT,
    cu."USUARIO_CREACION" AS USUARIO_CREACION
  FROM juridicos j
  JOIN MAIN m
    ON m.NIT = j.NUMERO_DOCUMENTO
  LEFT JOIN CONTACTO_ULTIMO cu
    ON cu."JUR_SECUENCIA" = j."SECUENCIA"
),
BASE_USUARIO AS (
  SELECT
    sp.CLASIFICACION_PARTICIPACION,
    CASE
      WHEN nu.USUARIO_CREACION IN ('USRDAVIVIENDA','USRINFORMACOLOM','USRSARLAFT')
        THEN nu.USUARIO_CREACION
      WHEN (nu.USUARIO_CREACION IS NULL OR TRIM(nu.USUARIO_CREACION) = '')
           AND sp.CLASIFICACION_PARTICIPACION = 'SIN ACCIONISTAS'
        THEN 'N/A'
      ELSE 'OTRO'  -- Agrupa nulos, vacíos o diferentes
    END AS USUARIO_CREACION,
    sp.NIT
  FROM SUM_PARTICIPACION sp
  LEFT JOIN NIT_USUARIO nu
    ON nu.NIT = sp.NIT
  JOIN MAIN m
    ON m.NIT = sp.NIT
),
CLASIF_USUARIO AS (
  SELECT
    CLASIFICACION_PARTICIPACION,
    USUARIO_CREACION,
    COUNT(DISTINCT NIT) AS NITS_UNICOS
  FROM BASE_USUARIO
  GROUP BY CLASIFICACION_PARTICIPACION, USUARIO_CREACION
),
TOTALES_USUARIO AS (
  SELECT USUARIO_CREACION, SUM(NITS_UNICOS) AS TOTAL_NITS_USUARIO
  FROM CLASIF_USUARIO
  GROUP BY USUARIO_CREACION
),
TOTAL_GLOBAL AS (
  SELECT SUM(NITS_UNICOS) AS TOTAL_NITS_GLOBAL FROM CLASIF_USUARIO
)
SELECT
  cu.CLASIFICACION_PARTICIPACION,
  cu.USUARIO_CREACION,
  cu.NITS_UNICOS,
  ROUND(100 * cu.NITS_UNICOS / NULLIF(tu.TOTAL_NITS_USUARIO, 0), 2) AS "%_SOBRE_TOTAL_USUARIO",
  ROUND(100 * cu.NITS_UNICOS / NULLIF(tg.TOTAL_NITS_GLOBAL, 0), 2)   AS "%_SOBRE_TOTAL_GLOBAL"
FROM CLASIF_USUARIO cu
LEFT JOIN TOTALES_USUARIO tu
  ON tu.USUARIO_CREACION = cu.USUARIO_CREACION
CROSS JOIN TOTAL_GLOBAL tg
ORDER BY
  CASE cu.CLASIFICACION_PARTICIPACION
    WHEN 'SIN ACCIONISTAS'  THEN 1
    WHEN 'Menor a 80%'      THEN 2
    WHEN 'Entre 80% y 100%' THEN 3
    WHEN 'Mayor a 100%'     THEN 4
    ELSE 5
  END,
  cu.USUARIO_CREACION;
