WITH AgentesOrdenados AS (
    SELECT FECHA_CORTE,
           CLAVE_AGENTE,
           TIPO_DOCUMENTO,
           KEY_ID,
           CODIGO_LOCALIDAD,
           LOCALIDAD,
           FECHA_INGRESO,
           FECHA_RETIRO,
           CODIGO_CARGO,
           NOMBRE_CARGO,
           CLAVE_JEFE,
           PRIMER_NOMBRE,
           SEGUNDO_NOMBRE,
           PRIMER_APELLIDO,
           SEGUNDO_APELLIDO,
           FECHA_NACIMIENTO,
           EDAD,
           GENERO,
           ESTADO_CIVIL,
           SALARIO,
           ROW_NUMBER() OVER (PARTITION BY TIPO_DOCUMENTO, KEY_ID ORDER BY FECHA_CORTE DESC) AS rn
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_param_agentes_empleados
)
SELECT a.FECHA_CORTE,
       a.CLAVE_AGENTE,
       a.TIPO_DOCUMENTO,
       a.KEY_ID,
       c.NUMERO_DOCUMENTO,       
       a.CODIGO_LOCALIDAD,
       a.LOCALIDAD,
       a.FECHA_INGRESO,
       a.FECHA_RETIRO,
       a.CODIGO_CARGO,
       a.NOMBRE_CARGO,
       a.CLAVE_JEFE,
       a.PRIMER_NOMBRE,
       a.SEGUNDO_NOMBRE,
       a.PRIMER_APELLIDO,
       a.SEGUNDO_APELLIDO,
       a.FECHA_NACIMIENTO,
       a.EDAD,
       a.GENERO,
       a.ESTADO_CIVIL,
       a.SALARIO,
       t.CODIGO_RESTRICCION,
       t.DESCRIPCION,
       c.NIVEL_DE_RIESGO
FROM AgentesOrdenados a
JOIN `sb-ecosistemaanalitico-lago.seguros_bolivar.t_terceros_restringidos` t
    ON a.TIPO_DOCUMENTO = t.TIPO_DOCUMENTO_TERCERO
    AND a.KEY_ID = t.KEY_ID
JOIN `sb-sandbox-usuarios.sandbox_cumplimiento.t_terceros_clientes` c
    ON a.TIPO_DOCUMENTO = c.TIPO_DOCUMENTO
    AND a.KEY_ID = c.KEY_ID
WHERE a.rn = 1
ORDER BY a.FECHA_CORTE DESC;
