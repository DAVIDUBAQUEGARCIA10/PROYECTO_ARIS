CREATE OR REPLACE TABLE
  `sb-ecosistemaanalitico-lago.cumplimiento_normativo_prod.cap_0014_prod` AS

  WITH historico AS (
  SELECT
    TIPO_DOCUMENTO,
    KEY_ID,
    FECHA_CREACION,
    VALOR_INGRESOS,
    LAG(VALOR_INGRESOS) OVER (
      PARTITION BY TIPO_DOCUMENTO, KEY_ID
      ORDER BY FECHA_CREACION
    ) AS ingreso_anterior,
    LAG(FECHA_CREACION) OVER (
      PARTITION BY TIPO_DOCUMENTO, KEY_ID
      ORDER BY FECHA_CREACION
    ) AS fecha_anterior
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_historico_estados_financieras`
),

evaluado AS (
  SELECT
    *,
    (VALOR_INGRESOS - ingreso_anterior) AS diferencia_ingresos,
    SAFE_DIVIDE(VALOR_INGRESOS - ingreso_anterior, ingreso_anterior) AS variacion_relativa,
    DATE_DIFF(
      DATE(FECHA_CREACION),      
      DATE(fecha_anterior),      
      YEAR
    ) AS diferencia_anios
  FROM historico
  WHERE ingreso_anterior IS NOT NULL
)

SELECT
  TIPO_DOCUMENTO,
  KEY_ID,
  FECHA_CREACION,
  VALOR_INGRESOS,
  ingreso_anterior,
  diferencia_ingresos,
  variacion_relativa,
  diferencia_anios,
  FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
  CURRENT_DATE()                        AS FECHA_ALERTA
FROM evaluado
WHERE diferencia_ingresos > 15000000          -- diferencia > $5M
  AND variacion_relativa > 0.5               -- incremento > 50%
  AND diferencia_anios <= 1                  -- periodo reciente (<= 2 aÃ±os)
  AND DATE(FECHA_CREACION) > DATE('2025-11-01');   -- evitar alertas viejas




INSERT INTO `sb-ecosistemaanalitico-lago.cumplimiento_normativo_prod.cap_0014_prod` (
  TIPO_DOCUMENTO,
  KEY_ID,
  FECHA_CREACION,
  VALOR_INGRESOS,
  ingreso_anterior,
  diferencia_ingresos,
  variacion_relativa,
  diferencia_anios,
  FECHA_ALERTA_MES
)

WITH historico AS (
  SELECT
    TIPO_DOCUMENTO,
    KEY_ID,
    FECHA_CREACION,
    VALOR_INGRESOS,
    LAG(VALOR_INGRESOS) OVER (
      PARTITION BY TIPO_DOCUMENTO, KEY_ID
      ORDER BY FECHA_CREACION
    ) AS ingreso_anterior,
    LAG(FECHA_CREACION) OVER (
      PARTITION BY TIPO_DOCUMENTO, KEY_ID
      ORDER BY FECHA_CREACION
    ) AS fecha_anterior
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_historico_estados_financieras`
),

evaluado AS (
  SELECT
    *,
    (VALOR_INGRESOS - ingreso_anterior) AS diferencia_ingresos,
    SAFE_DIVIDE(VALOR_INGRESOS - ingreso_anterior, ingreso_anterior) AS variacion_relativa,
    DATE_DIFF(
      DATE(FECHA_CREACION),
      DATE(fecha_anterior),
      YEAR
    ) AS diferencia_anios
  FROM historico
  WHERE ingreso_anterior IS NOT NULL
)

SELECT
  d.TIPO_DOCUMENTO,
  d.KEY_ID,
  d.FECHA_CREACION,
  d.VALOR_INGRESOS,
  d.ingreso_anterior,
  d.diferencia_ingresos,
  d.variacion_relativa,
  d.diferencia_anios,
  FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES
FROM evaluado d
WHERE d.diferencia_ingresos > 15000000
  AND d.variacion_relativa > 0.5
  AND d.diferencia_anios <= 1
  AND DATE(d.FECHA_CREACION) > DATE('2025-11-01')
  AND NOT EXISTS (
      SELECT 1
      FROM `sb-ecosistemaanalitico-lago.cumplimiento_normativo_prod.cap_0014_prod` t
      WHERE t.KEY_ID           = d.KEY_ID
        AND t.FECHA_ALERTA_MES = FORMAT_DATE('%Y-%m', CURRENT_DATE())
  );










