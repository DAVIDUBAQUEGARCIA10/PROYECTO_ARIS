SELECT 
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_TITULO,
    FECHA_TRANSACCION,
    CODIGO_TIPO_MOVIMIENTO,
    NUMERO_TRANSACCION,
    VALOR_TRANSACCION,
    CODIGO_AGENCIA,
    AGRUPAMIENTO_CODIGO,
    SIGNO_MOVIMIENTO,
    DESCRIPCION_TIPO_MOVIMIENTO,
    ABREVIATURA_TIPO_MOVIMIENTO,
    VALOR_CUOTA_ACTUAL,
    VALOR_CUOTA_INICIAL,
    CODIGO_PLAN,
    FECHA_MODIFICACION,
    FECHA_CREACION,
    FECHA_BLOQUEO,
    FECHA_CANCELACION
FROM 
    sb-ecosistemaanalitico-lago.capitalizadora.t_movimientos_capitalizadora
WHERE 
    FECHA_TRANSACCION >= '2024-01-01'
    AND SIGNO_MOVIMIENTO = '+'
    AND VALOR_TRANSACCION > VALOR_CUOTA_INICIAL
    AND FECHA_TRANSACCION <= DATE_ADD(FECHA_CREACION, INTERVAL 90 DAY);


CREATE -----
create or replace table sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0009_VISOR_TRANS AS
SELECT 
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_TITULO,
    FECHA_TRANSACCION,
    CODIGO_TIPO_MOVIMIENTO,
    NUMERO_TRANSACCION,
    VALOR_TRANSACCION,
    CODIGO_AGENCIA,
    AGRUPAMIENTO_CODIGO,
    SIGNO_MOVIMIENTO,
    DESCRIPCION_TIPO_MOVIMIENTO,
    ABREVIATURA_TIPO_MOVIMIENTO,
    VALOR_CUOTA_ACTUAL,
    VALOR_CUOTA_INICIAL,
    CODIGO_PLAN,
    FECHA_MODIFICACION,
    FECHA_CREACION,
    FECHA_BLOQUEO,
    FECHA_CANCELACION,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES, 
    CURRENT_DATE() AS FECHA_ALERTA
FROM 
    sb-ecosistemaanalitico-lago.capitalizadora.t_movimientos_capitalizadora
WHERE 
    FECHA_TRANSACCION >= '2024-01-01'
    AND SIGNO_MOVIMIENTO = '+'
    AND VALOR_TRANSACCION > VALOR_CUOTA_INICIAL
    AND FECHA_TRANSACCION <= DATE_ADD(FECHA_CREACION, INTERVAL 90 DAY);


INSER ----
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0009_VISOR_TRANS (
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_TITULO,
    FECHA_TRANSACCION,
    CODIGO_TIPO_MOVIMIENTO,
    NUMERO_TRANSACCION,
    VALOR_TRANSACCION,
    CODIGO_AGENCIA,
    AGRUPAMIENTO_CODIGO,
    SIGNO_MOVIMIENTO,
    DESCRIPCION_TIPO_MOVIMIENTO,
    ABREVIATURA_TIPO_MOVIMIENTO,
    VALOR_CUOTA_ACTUAL,
    VALOR_CUOTA_INICIAL,
    CODIGO_PLAN,
    FECHA_MODIFICACION,
    FECHA_CREACION,
    FECHA_BLOQUEO,
    FECHA_CANCELACION,
    FECHA_ALERTA_MES,
    FECHA_ALERTA
)
SELECT 
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_TITULO,
    FECHA_TRANSACCION,
    CODIGO_TIPO_MOVIMIENTO,
    NUMERO_TRANSACCION,
    VALOR_TRANSACCION,
    CODIGO_AGENCIA,
    AGRUPAMIENTO_CODIGO,
    SIGNO_MOVIMIENTO,
    DESCRIPCION_TIPO_MOVIMIENTO,
    ABREVIATURA_TIPO_MOVIMIENTO,
    VALOR_CUOTA_ACTUAL,
    VALOR_CUOTA_INICIAL,
    CODIGO_PLAN,
    FECHA_MODIFICACION,
    FECHA_CREACION,
    FECHA_BLOQUEO,
    FECHA_CANCELACION,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES, 
    CURRENT_DATE() AS FECHA_ALERTA
FROM 
    sb-ecosistemaanalitico-lago.capitalizadora.t_movimientos_capitalizadora source
WHERE 
    FECHA_TRANSACCION >= '2024-01-01'
    AND SIGNO_MOVIMIENTO = '+'
    AND VALOR_TRANSACCION > VALOR_CUOTA_INICIAL
    AND FECHA_TRANSACCION <= DATE_ADD(FECHA_CREACION, INTERVAL 90 DAY)
    AND NOT EXISTS (
        SELECT 1
        FROM sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0009_VISOR_TRANS target
        WHERE target.CODIGO_COMPANIA = source.CODIGO_COMPANIA
          AND target.TIPO_DOCUMENTO = source.TIPO_DOCUMENTO
          AND target.KEY_ID_TOMADOR = source.KEY_ID_TOMADOR
          AND target.NUMERO_TITULO = source.NUMERO_TITULO
        AND target.FECHA_TRANSACCION = source.FECHA_TRANSACCION
        AND target.FECHA_CREACION = source.FECHA_CREACION
        AND target.VALOR_TRANSACCION = source.VALOR_TRANSACCION
    );
