CREATE OR REPLACE TABLE `sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0012_VISOR_TRANS` AS
WITH param AS (
  -- factor_cuota = 1 → pago estrictamente mayor a la cuota pactada
  SELECT 1.0 AS factor_cuota
),

-- 0) Cuota pactada por título (VALOR_CUOTA)
cuota_pactada AS (
  SELECT
    NUMERO_TITULO,
    -- Si hay varias filas por título, se toma la mayor cuota (ajustable según negocio)
    MAX(VALOR_CUOTA) AS VALOR_CUOTA
  FROM `sb-ecosistemaanalitico-lago.capitalizadora.t_historico_titulos_capitalizacion`
  GROUP BY NUMERO_TITULO
),

-- 1) Base de movimientos con joins de cliente y cuota pactada
base AS (
  SELECT
    DATE(m.FECHA_TRANSACCION)              AS FECHA_TRANSACCION,
    m.NUMERO_TITULO,
    m.VALOR_TRANSACCION,
    m.DESCRIPCION_TIPO_MOVIMIENTO,
    m.CODIGO_AGENCIA,
    m.CODIGO_COMPANIA,
    m.NUMERO_TRANSACCION,

    c.KEY_ID_BENEFICIARIO                  AS KEY_ID,
    c.TIPO_DOCUMENTO,

    t2.PUBLICAMENTE_EXPUESTA,
    q.VALOR_CUOTA,

    FORMAT_DATE('%Y-%m', CURRENT_DATE())   AS FECHA_ALERTA_MES,
    CURRENT_DATE()                         AS FECHA_ALERTA

  FROM `sb-ecosistemaanalitico-lago.capitalizadora.t_movimientos_capitalizadora` m

  JOIN `sb-ecosistemaanalitico-lago.capitalizadora.t_clientes_por_titulo_capitalizadora` c
    ON m.NUMERO_TITULO = c.TITULO

  LEFT JOIN (
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales`
    UNION ALL
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos`
  ) AS t2
    ON c.KEY_ID_BENEFICIARIO = t2.KEY_ID
   AND c.TIPO_DOCUMENTO      = t2.TIPO_DOCUMENTO

  LEFT JOIN cuota_pactada q
    ON m.NUMERO_TITULO = q.NUMERO_TITULO

  WHERE
    m.SIGNO_MOVIMIENTO = '+'
    AND DATE(m.FECHA_TRANSACCION) >= DATE '2025-01-01'
    AND m.DESCRIPCION_TIPO_MOVIMIENTO IN (
      'N.D. REVERSION SALDO A FAVOR',
      'REC.REINTE.UNID CJAS.BOLIVAR',
      'SALDO FAVOR CLIENTE ANULACION SORTEO',
      'APLIC. RECAUDOS DABUENAVIDA DEPTO TITULO',
      'REC.CUOT.INIC.TRANSF.DAVIV',
      'REC.REINTE.UNID CJAS.DAVIVIENDA',
      'TRASL APLI UNID DE SALD FAVOR',
      'REC.SOBRANTE EFECT.CAJEROS',
      'CAUSAC VTO INT DEPOSITO',
      'N.D. REVERS CTA ADEL PER ACTUAL',
      'REC.CUOT.INIC.DATAFONOS',
      'TRASL REVERS CUOT INI APLI',
      'CORREC. INCONS. REINTEGRO',
      'APLIC CTAS INIC DE SALD FAVOR',
      'CORREC. INCONS. CUOTA INICIAL',
      'CORREC. INCONS. CUOTA POSTER.',
      'REC. CTAS POST TRANSF DAVIV',
      'ANULACION DEVOLUCION GASTOS SORTEO',
      'SALDO FAVOR CLIENTE NOTA DEBITO',
      'REC. CTAS INIC TRASL AUTOMA',
      'REC.CUOT.INIC.DEB.CONVENIOS',
      'REC.CUOT.POST.CJAS.BOLIVAR',
      'TRASL REVERS POST APLIC CONVEN',
      'TRASL REVERS POST ADELA CONVEN',
      'APLIC CTAS POST DE SALD FAVOR',
      'REC.INIC.BOTON DE PAGOS',
      'ANULACION RETIRO PARCIAL',
      'TRASL AUTOM CTAS AL V.N.A.',
      'REC.CUOT.POST.DEB.AUTOMATICO',
      'TRASL AUTOM REVERS SALDO',
      'APLICAC UNID DEPTO TITULOS',
      'REC.CUOT.POST.CJAS DAVIVIENDA',
      'TRASLADO REVERS CUOT ADEL AUTOM',
      'APLICACION CTAS POST DEPTO TITULOS',
      'REC.CUOT.INIC.DEB.CORPORATIVO',
      'RECAUDO CUOTAS EXTRAORDINARIAS',
      'TRASL REVERS CUOT POS APLI',
      'RECAUDO CUOTAS TELEFONO ROJO',
      'ANULAC.PAG.SALDO FAV.CLIENTE',
      'TRASL REVERS CUOT INI ADEL',
      'REVERSION REINTEGRO DEPTO TITULOS',
      'REVER CUOTA ADEL A SALDO FAV',
      'RECAUDO BOTON DE PAGOS',
      'TRASL APLIC  SALDO A FAVOR',
      'TRASLADO REVERS SALDO FAVOR',
      'REC.CUOT.POST.LIBRANZA',
      'N.D. RETIRO UNIDADES',
      'DEVOLUCION GASTOS SORTEO',
      'INCONSISTENCIAS CUOTAS POST CICS',
      'N.D. REVERS CTA POSTERIOR',
      'REC. CUOTAS POSTERIORES GANALEASING',
      'TRASL APLIC  CUOT POST',
      'TRASL APLIC  CUOT INIC',
      'APLICACION CTAS INIC DEPTO TITULOS',
      'APLIC. CUOTA EXTRAORD. DABUENAVIDA TITUL',
      'TRASL REVERS CUOT POS ADEL',
      'TRASLADO REVERS INT SALDO',
      'N.D. REVERS CTA INICIAL',
      'REC.CUOT.INIC.CJAS.BOLIVAR',
      'TRASL AUTOM REVERS CTAS ADEL',
      'REC. CUOTAS INICIALES GANALEASING',
      'REC INICIALES ESTRAORD',
      'ANULACION VENCIMIENTOS',
      'SALDO FAVOR POR ANUL RETIRO',
      'TRASL REVERS INIC APLIC CONVEN'
    )
),

-- 2) Filtrado de casos que incumplen cuota y deduplicación
u AS (
  SELECT
    b.*,
    ROW_NUMBER() OVER (
      PARTITION BY b.CODIGO_COMPANIA, b.KEY_ID, b.NUMERO_TITULO, b.FECHA_TRANSACCION
      ORDER BY b.NUMERO_TRANSACCION DESC
    ) AS rn
  FROM base b
  CROSS JOIN param p
  WHERE
    b.VALOR_CUOTA IS NOT NULL
    AND b.VALOR_TRANSACCION > p.factor_cuota * b.VALOR_CUOTA
)

-- 3) Inserción final solo con las columnas requeridas
SELECT
  u.FECHA_TRANSACCION,
  u.NUMERO_TITULO,
  u.VALOR_TRANSACCION,
  u.DESCRIPCION_TIPO_MOVIMIENTO,
  u.CODIGO_AGENCIA,
  u.KEY_ID,
  u.TIPO_DOCUMENTO,
  u.PUBLICAMENTE_EXPUESTA,
  u.VALOR_CUOTA AS CUOTA_ACTUAL,
  u.FECHA_ALERTA_MES,
  u.FECHA_ALERTA
FROM u
WHERE u.rn = 1
 AND  FECHA_TRANSACCION >= '2025-11-01';




