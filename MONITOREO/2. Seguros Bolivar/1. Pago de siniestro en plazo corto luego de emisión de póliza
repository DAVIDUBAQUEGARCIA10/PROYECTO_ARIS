WITH RankedData AS (
    SELECT
        FECHA_EMISION_ENDOSO_CANCELACION,
        FECHA_INICIO_VIGENCIA_ENDOSO,
        FECHA_VENCIMIENTO_ENDOSO,
        FECHA_INICIO_VIGENCIA_POLIZA,
        FECHA_FIN_VIGENCIA_POLIZA,
        FECHA_ANULACION_POLIZA,
        CODIGO_COMPANIA,
        CODIGO_LOCALIDAD,
        CODIGO_RAMO_EMISION,
        CODIGO_PRODUCTO,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        DOCUMENTO_TOMADOR,
        NUMERO_ENDOSO,
        CODIGO_ENDOSO,
        SUB_CODIGO_ENDOSO,
        FECHA_CANCELACION_DEF,
        RANK() OVER (PARTITION BY DOCUMENTO_TOMADOR ORDER BY FECHA_EMISION_ENDOSO_CANCELACION) AS rank
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_cancelaciones`
    WHERE
        DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_POLIZA), DAY) <= 90
        AND DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_POLIZA), DAY) >= 3
        AND RIGHT(CAST(NUMERO_POLIZA AS STRING), 2) = '01'
        AND FECHA_INICIO_VIGENCIA_POLIZA >= "2024-01-01"
        AND FECHA_INICIO_VIGENCIA_ENDOSO >= "2024-01-01"
        AND DOCUMENTO_TOMADOR NOT IN (860034313, 830053700)
        AND MARCA_CANCELACION_DEFINITIVA = "S"
        AND CODIGO_COMPANIA = '2'
        AND CODIGO_RAMO_EMISION NOT IN (33, 34,23,21)
        AND FORMA_COBRO NOT IN ('DB', 'DB')
        AND ALTURA_POLIZA IN ('01', '01')
        AND DESCRIPCION_ENDOSO != 'ANULACION POR FONDOS INSUFICIENTES (PAT)'
        AND AGRUPACION_DESCRIPCION_ENDOSO_CANCELACION != 'CANCELACION MUERTE'
)

SELECT
    FECHA_EMISION_ENDOSO_CANCELACION,
    FECHA_INICIO_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    FECHA_INICIO_VIGENCIA_POLIZA,
    FECHA_FIN_VIGENCIA_POLIZA,
    FECHA_ANULACION_POLIZA,
    CODIGO_COMPANIA,
    CODIGO_LOCALIDAD,
    CODIGO_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    DOCUMENTO_TOMADOR,
    NUMERO_ENDOSO,
    CODIGO_ENDOSO,
    SUB_CODIGO_ENDOSO,
    FECHA_CANCELACION_DEF
FROM RankedData
WHERE rank = 1;
