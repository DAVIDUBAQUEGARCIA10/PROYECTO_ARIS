SELECT DISTINCT
    a.CODIGO_COMPANIA,
    a.CODIGO_RAMO_EMISION,
    a.NOMBRE_RAMO_EMISION,
    a.CODIGO_PRODUCTO,
    a.NOMBRE_PRODUCTO,
    a.NUMERO_POLIZA,
    a.TIPO_DOCUMENTO_TOMADOR,
    a.KEY_ID_TOMADOR,    
    a.COD_MOTIVO_CANCELACION_POLIZA,
    a.DES_MOTIVO_CANCELACION_POLIZA,
    CAST(a.FECHA_EMISION_ENDOSO AS DATE) AS FECHA_EMISION_ENDOSO,
    CAST(a.FECHA_INICIO_ENDOSO AS DATE) AS FECHA_INICIO_ENDOSO,
    CAST(a.FECHA_FIN_ENDOSO AS DATE) AS FECHA_FIN_ENDOSO,
    CAST(a.FECHA_INICIO_POLIZA AS DATE) AS FECHA_INICIO_POLIZA,
    CAST(a.FECHA_FIN_POLIZA AS DATE) AS FECHA_FIN_POLIZA,
    a.TIPO_ENDOSO,
    a.DESCRIPCION_ENDOSO,
    CAST(a.FECHA_ORIGEN AS DATE) AS FECHA_ORIGEN,
    b.COD_MOTIVO_CANCELACION_POLIZA AS COD_MOTIVO_CANCELACION_POLIZA_B,
    b.DES_MOTIVO_CANCELACION_POLIZA AS DES_MOTIVO_CANCELACION_POLIZA_B,
    b.TIPO_ENDOSO AS TIPO_ENDOSO_B,
    b.DESCRIPCION_ENDOSO AS DESCRIPCION_ENDOSO_B
FROM 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos a
LEFT JOIN 
    (
        SELECT DISTINCT
            NUMERO_POLIZA,
            TIPO_DOCUMENTO_TOMADOR,
            KEY_ID_TOMADOR,    
            COD_MOTIVO_CANCELACION_POLIZA,
            DES_MOTIVO_CANCELACION_POLIZA,
            FECHA_EMISION_ENDOSO,
            FECHA_INICIO_ENDOSO,
            FECHA_FIN_ENDOSO,
            FECHA_INICIO_POLIZA,
            FECHA_FIN_POLIZA,
            TIPO_ENDOSO,
            DESCRIPCION_ENDOSO,
            FECHA_PROCESO
        FROM 
            sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos
        WHERE 
            CAST(FECHA_FIN_POLIZA AS DATE) > '2024-12-31' 
            AND CAST(FECHA_FIN_ENDOSO AS DATE) > '2024-12-31' 
            AND CAST(FECHA_EMISION_ENDOSO AS DATE) > '2024-01-01' 
            AND CAST(FECHA_INICIO_ENDOSO AS DATE) > '2024-01-01' 
            AND TIPO_ENDOSO LIKE '%AT%'
            AND CODIGO_COMPANIA = 2
    ) b
    ON a.NUMERO_POLIZA = b.NUMERO_POLIZA
    AND a.KEY_ID_TOMADOR = b.KEY_ID_TOMADOR
WHERE 
    CAST(a.FECHA_FIN_POLIZA AS DATE) > '2024-12-31' 
    AND CAST(a.FECHA_FIN_ENDOSO AS DATE) > '2024-12-31' 
    AND CAST(a.FECHA_EMISION_ENDOSO AS DATE) > '2024-01-01' 
    AND CAST(a.FECHA_INICIO_ENDOSO AS DATE) > '2024-01-01' 
    AND CAST(b.FECHA_PROCESO AS DATE) IS NOT NULL
    AND CODIGO_COMPANIA = 2
    --AND FECHA_ORIGEN >= '2024-01-01'
    AND (a.DESCRIPCION_ENDOSO LIKE '%BENEFICIARIO%')
    AND (a.DESCRIPCION_ENDOSO NOT LIKE '%DESVINCU%') 
    AND (b.DESCRIPCION_ENDOSO NOT LIKE '%FACTURA%')         
    AND (a.DESCRIPCION_ENDOSO LIKE '%INCLUSION%' OR 
         a.DESCRIPCION_ENDOSO LIKE '%MODIFICA%' OR
         a.DESCRIPCION_ENDOSO LIKE '%ACTUALIZA%' OR
         a.DESCRIPCION_ENDOSO LIKE '%VINCULACION%' OR
         a.DESCRIPCION_ENDOSO LIKE '%CAMBIO%' OR
         a.DESCRIPCION_ENDOSO LIKE '%ADICION%' OR
         a.DESCRIPCION_ENDOSO LIKE '%CAMBIO%')
