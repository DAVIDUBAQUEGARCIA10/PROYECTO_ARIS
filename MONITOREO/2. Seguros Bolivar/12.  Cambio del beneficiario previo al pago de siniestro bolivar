CREATE -----
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0005_VISOR_REPO AS

-- CTE (Common Table Expression) para estructurar y filtrar los registros relevantes
WITH registros_ordenados AS (
    SELECT DISTINCT
        -- Información básica de la póliza y producto
        t1.CODIGO_COMPANIA,
        t1.CODIGO_RAMO_EMISION,
        t1.NOMBRE_RAMO_EMISION,
        t1.CODIGO_PRODUCTO,
        t1.NOMBRE_PRODUCTO,
        t1.NUMERO_POLIZA,

        -- Datos del tomador
        t1.TIPO_DOCUMENTO_TOMADOR,
        t1.KEY_ID_TOMADOR,    

        -- Información del endoso y su motivo
        t1.COD_MOTIVO_CANCELACION_POLIZA,
        t1.DES_MOTIVO_CANCELACION_POLIZA,
        CAST(t1.FECHA_EMISION_ENDOSO AS DATE) AS FECHA_EMISION_ENDOSO,
        CAST(t1.FECHA_INICIO_ENDOSO AS DATE) AS FECHA_INICIO_ENDOSO,
        CAST(t1.FECHA_FIN_ENDOSO AS DATE) AS FECHA_FIN_ENDOSO,
        CAST(t1.FECHA_INICIO_POLIZA AS DATE) AS FECHA_INICIO_POLIZA,
        CAST(t1.FECHA_FIN_POLIZA AS DATE) AS FECHA_FIN_POLIZA,
        t1.TIPO_ENDOSO,
        t1.DESCRIPCION_ENDOSO,
        CAST(t1.FECHA_ORIGEN AS DATE) AS FECHA_ORIGEN,

        -- Datos del siniestro relacionados con la póliza
        t2.FECHA_SUSCRIPCION,
        t2.FECHA_SINIESTRO,
        t2.LIQUIDADO_BOLIVAR,
        t2.FECHA_ORDEN_PAGO,

        -- Días entre la fecha del endoso y la orden de pago
        DATE_DIFF(CAST(t2.FECHA_ORDEN_PAGO AS DATE), CAST(t1.FECHA_EMISION_ENDOSO AS DATE), DAY) AS DIFERENCIA_DIAS,

        -- Enumeración de filas por póliza y tomador (para quedarnos con un único registro por caso)
        ROW_NUMBER() OVER (
            PARTITION BY t1.NUMERO_POLIZA, t1.KEY_ID_TOMADOR, t2.LIQUIDADO_BOLIVAR 
            ORDER BY t2.LIQUIDADO_BOLIVAR DESC
        ) AS fila

    FROM 
        -- Fuente de pólizas y endosos
        sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t1

    -- Relación con tabla de siniestros
    LEFT JOIN sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros t2
        ON t1.NUMERO_POLIZA = t2.NUMERO_POLIZA 
        AND t1.KEY_ID_TOMADOR = t2.KEY_ID_TOMADOR

    -- Filtros para seleccionar registros relevantes
    WHERE 
        CAST(t1.FECHA_FIN_POLIZA AS DATE) > '2024-12-31' AND
        CAST(t1.FECHA_FIN_ENDOSO AS DATE) > '2024-12-31' AND
        CAST(t1.FECHA_EMISION_ENDOSO AS DATE) > '2024-01-01' AND
        CAST(t1.FECHA_INICIO_ENDOSO AS DATE) > '2024-01-01' AND
        t1.CODIGO_COMPANIA = 2 AND
        t2.CODIGO_COMPANIA = 2 AND
        t2.FECHA_ORDEN_PAGO IS NOT NULL AND
        t2.FECHA_ORDEN_PAGO >= '2024-01-01' AND

        -- Solo casos donde el pago ocurrió después del endoso y dentro de 90 días
        DATE_DIFF(CAST(t2.FECHA_ORDEN_PAGO AS DATE), CAST(t1.FECHA_INICIO_ENDOSO AS DATE), DAY) > 0 AND
        DATE_DIFF(CAST(t2.FECHA_ORDEN_PAGO AS DATE), CAST(t1.FECHA_INICIO_ENDOSO AS DATE), DAY) <= 90 AND

        -- Solo pólizas principales (ALTURA_POLIZA = '01')
        t1.ALTURA_POLIZA = '01' AND

        -- Endosos relacionados con beneficiarios (tipos específicos)
        t1.DESCRIPCION_ENDOSO LIKE '%BENEFICIARIO%' AND (
            t1.DESCRIPCION_ENDOSO LIKE '%INCLUSION%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%MODIFICA%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%ACTUALIZA%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%VINCULACION%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%CAMBIO%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%ADICION%'
        )
)

-- Selección final de la fila más relevante (por póliza)
SELECT
    CODIGO_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,    
    COD_MOTIVO_CANCELACION_POLIZA,
    DES_MOTIVO_CANCELACION_POLIZA,
    FECHA_EMISION_ENDOSO,
    FECHA_INICIO_ENDOSO,
    FECHA_FIN_ENDOSO,
    FECHA_INICIO_POLIZA,
    FECHA_FIN_POLIZA,
    TIPO_ENDOSO,
    DESCRIPCION_ENDOSO,
    FECHA_ORIGEN,
    FECHA_SUSCRIPCION,
    FECHA_SINIESTRO,
    LIQUIDADO_BOLIVAR,
    FECHA_ORDEN_PAGO,
    DIFERENCIA_DIAS,

    -- Información de alerta
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA

FROM registros_ordenados

-- Se selecciona solo la fila más representativa por grupo (la de mayor valor liquidado)
WHERE fila = 1

-- Ordenamiento por monto liquidado, de mayor a menor
ORDER BY LIQUIDADO_BOLIVAR DESC;







INSERT -----
-- Inserta en la tabla SEG_0005_VISOR_REPO únicamente los registros que aún no existen,
-- con base en una combinación clave: NUMERO_POLIZA, KEY_ID_TOMADOR y FECHA_ORDEN_PAGO.

INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0005_VISOR_REPO
(
    CODIGO_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,    
    COD_MOTIVO_CANCELACION_POLIZA,
    DES_MOTIVO_CANCELACION_POLIZA,
    FECHA_EMISION_ENDOSO,
    FECHA_INICIO_ENDOSO,
    FECHA_FIN_ENDOSO,
    FECHA_INICIO_POLIZA,
    FECHA_FIN_POLIZA,
    TIPO_ENDOSO,
    DESCRIPCION_ENDOSO,
    FECHA_ORIGEN,
    FECHA_SUSCRIPCION,
    FECHA_SINIESTRO,
    LIQUIDADO_BOLIVAR,
    FECHA_ORDEN_PAGO,
    DIFERENCIA_DIAS,    
    FECHA_ALERTA_MES,
    FECHA_ALERTA
)

-- CTE que organiza los registros base con filtros, cálculo de días y numeración
WITH registros_ordenados AS (
    SELECT DISTINCT
        -- Información de la póliza y del producto contratado
        t1.CODIGO_COMPANIA,
        t1.CODIGO_RAMO_EMISION,
        t1.NOMBRE_RAMO_EMISION,
        t1.CODIGO_PRODUCTO,
        t1.NOMBRE_PRODUCTO,
        t1.NUMERO_POLIZA,
        t1.TIPO_DOCUMENTO_TOMADOR,
        t1.KEY_ID_TOMADOR,    
        t1.COD_MOTIVO_CANCELACION_POLIZA,
        t1.DES_MOTIVO_CANCELACION_POLIZA,
        CAST(t1.FECHA_EMISION_ENDOSO AS DATE) AS FECHA_EMISION_ENDOSO,
        CAST(t1.FECHA_INICIO_ENDOSO AS DATE) AS FECHA_INICIO_ENDOSO,
        CAST(t1.FECHA_FIN_ENDOSO AS DATE) AS FECHA_FIN_ENDOSO,
        CAST(t1.FECHA_INICIO_POLIZA AS DATE) AS FECHA_INICIO_POLIZA,
        CAST(t1.FECHA_FIN_POLIZA AS DATE) AS FECHA_FIN_POLIZA,
        t1.TIPO_ENDOSO,
        t1.DESCRIPCION_ENDOSO,
        CAST(t1.FECHA_ORIGEN AS DATE) AS FECHA_ORIGEN,

        -- Información del siniestro relacionado a la póliza
        t2.FECHA_SUSCRIPCION,
        t2.FECHA_SINIESTRO,
        t2.LIQUIDADO_BOLIVAR,
        t2.FECHA_ORDEN_PAGO,

        -- Cálculo de la diferencia entre la orden de pago y la fecha de emisión del endoso
        DATE_DIFF(
            CAST(t2.FECHA_ORDEN_PAGO AS DATE),
            CAST(t1.FECHA_EMISION_ENDOSO AS DATE),
            DAY
        ) AS DIFERENCIA_DIAS,

        -- Enumeración para quedarse con la fila prioritaria por combinación clave
        ROW_NUMBER() OVER (
            PARTITION BY t1.NUMERO_POLIZA, t1.KEY_ID_TOMADOR, t2.LIQUIDADO_BOLIVAR
            ORDER BY t2.LIQUIDADO_BOLIVAR DESC
        ) AS fila

    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t1

    -- Asociación con la tabla de siniestros para cada póliza y tomador
    LEFT JOIN sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros t2
        ON t1.NUMERO_POLIZA = t2.NUMERO_POLIZA 
        AND t1.KEY_ID_TOMADOR = t2.KEY_ID_TOMADOR

    -- Filtros específicos para identificar casos de riesgo:
    WHERE 
        -- Fechas válidas y actuales
        CAST(t1.FECHA_FIN_POLIZA AS DATE) > '2024-12-31' AND
        CAST(t1.FECHA_FIN_ENDOSO AS DATE) > '2024-12-31' AND
        CAST(t1.FECHA_EMISION_ENDOSO AS DATE) > '2024-01-01' AND
        CAST(t1.FECHA_INICIO_ENDOSO AS DATE) > '2024-01-01' AND

        -- Endosos que mencionen beneficiarios pero sin indicar fallecimiento
        t1.DESCRIPCION_ENDOSO LIKE '%BENEFICIARIO%' AND
        t1.DESCRIPCION_ENDOSO NOT LIKE '%FALLE%' AND

        -- Solo registros de la compañía 2
        t1.CODIGO_COMPANIA = 2 AND
        t2.CODIGO_COMPANIA = 2 AND

        -- Solo siniestros con orden de pago reciente y válida
        t2.FECHA_ORDEN_PAGO IS NOT NULL AND
        t2.FECHA_ORDEN_PAGO >= '2024-01-01' AND

        -- Días entre orden de pago y endoso deben estar entre 1 y 90 días
        DATE_DIFF(CAST(t2.FECHA_ORDEN_PAGO AS DATE), CAST(t1.FECHA_INICIO_ENDOSO AS DATE), DAY) > 0 AND
        DATE_DIFF(CAST(t2.FECHA_ORDEN_PAGO AS DATE), CAST(t1.FECHA_INICIO_ENDOSO AS DATE), DAY) <= 90 AND

        -- Solo pólizas madre (ALTURA_POLIZA = '01') y sin ramo 34
        t1.ALTURA_POLIZA = '01' AND
        t1.CODIGO_RAMO_EMISION != 34 AND

        -- Se filtran los endosos de tipo modificación/inclusión/cambio beneficiario
        (
            t1.DESCRIPCION_ENDOSO LIKE '%INCLUSION%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%MODIFICA%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%ACTUALIZA%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%VINCULACION%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%CAMBIO%' OR
            t1.DESCRIPCION_ENDOSO LIKE '%ADICION%'
        ) AND

        -- Se considera un valor mínimo significativo del siniestro
        t2.LIQUIDADO_BOLIVAR > 780000.0
)

-- Selección de los registros que pasarán al INSERT final
SELECT
    r.CODIGO_COMPANIA,
    r.CODIGO_RAMO_EMISION,
    r.NOMBRE_RAMO_EMISION,
    r.CODIGO_PRODUCTO,
    r.NOMBRE_PRODUCTO,
    r.NUMERO_POLIZA,
    r.TIPO_DOCUMENTO_TOMADOR,
    r.KEY_ID_TOMADOR,    
    r.COD_MOTIVO_CANCELACION_POLIZA,
    r.DES_MOTIVO_CANCELACION_POLIZA,
    r.FECHA_EMISION_ENDOSO,
    r.FECHA_INICIO_ENDOSO,
    r.FECHA_FIN_ENDOSO,
    r.FECHA_INICIO_POLIZA,
    r.FECHA_FIN_POLIZA,
    r.TIPO_ENDOSO,
    r.DESCRIPCION_ENDOSO,
    r.FECHA_ORIGEN,
    r.FECHA_SUSCRIPCION,
    r.FECHA_SINIESTRO,
    r.LIQUIDADO_BOLIVAR,
    r.FECHA_ORDEN_PAGO,
    r.DIFERENCIA_DIAS,

    -- Fecha de ejecución del proceso como alerta
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA

-- Se filtran los registros para no insertar duplicados
FROM registros_ordenados r
LEFT JOIN sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0005_VISOR_REPO t
    ON r.NUMERO_POLIZA = t.NUMERO_POLIZA
    AND r.KEY_ID_TOMADOR = t.KEY_ID_TOMADOR
    AND r.FECHA_ORDEN_PAGO = t.FECHA_ORDEN_PAGO

-- Se queda únicamente con la fila principal y los registros no existentes
WHERE 
    r.fila = 1 AND
    t.NUMERO_POLIZA IS NULL  -- Esta condición garantiza que el registro no está ya insertado

ORDER BY r.LIQUIDADO_BOLIVAR DESC;  -- Prioriza los valores más altos de pago para revisión
