WITH ranked_data AS (
    SELECT
        CODIGO_COMPANIA,
        TIPO_DOCUMENTO,
        KEY_ID_TOMADOR,
        NUMERO_POLIZA,
        CODIGO_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        CODIGO_LOCALIDAD,
        VALOR_RETIRO,
        VALOR_GIRADO,
        ESTADO_REGISTRO,
        ESTADO_GIRO,
        ORDEN_PAGO,
        FECHA_ULT_MODIFICACION,
        FECHA_EMISION_POLIZA,
        FECHA_EMISION_ENDOSO,
        FECHA_FIN_POLIZA,
        MCA_ANULACION_POLIZA,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR ORDER BY FECHA_ULT_MODIFICACION DESC) AS rn
    FROM
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_ordenes_pago_vida_retiros`
    WHERE
        VALOR_RETIRO > 25000000 
        AND FECHA_EMISION_POLIZA >= '2024-01-01'
        AND FECHA_EMISION_ENDOSO >= '2024-01-01'
        AND FECHA_FIN_POLIZA >= '2024-10-31'
)
SELECT
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    CODIGO_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    CODIGO_LOCALIDAD,
    VALOR_RETIRO,
    VALOR_GIRADO,
    ESTADO_REGISTRO,
    ESTADO_GIRO,
    ORDEN_PAGO,
    FECHA_ULT_MODIFICACION,
    FECHA_EMISION_POLIZA,
    FECHA_EMISION_ENDOSO,
    FECHA_FIN_POLIZA,
    MCA_ANULACION_POLIZA
FROM
    ranked_data
WHERE
    rn = 1;

CREATE ----



-- Crear o reemplazar la tabla SEG_0002_VISOR_REPO y agregar la columna FECHA_ALERTA
create or replace table sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0002_VISOR_REPO AS
WITH ranked_data AS (
    SELECT
        CODIGO_COMPANIA,
        TIPO_DOCUMENTO,
        KEY_ID_TOMADOR,
        NUMERO_POLIZA,
        CODIGO_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        CODIGO_LOCALIDAD,
        VALOR_RETIRO,
        VALOR_GIRADO,
        ESTADO_REGISTRO,
        ESTADO_GIRO,
        ORDEN_PAGO,
        FECHA_ULT_MODIFICACION,
        FECHA_EMISION_POLIZA,
        FECHA_EMISION_ENDOSO,
        FECHA_FIN_POLIZA,
        MCA_ANULACION_POLIZA,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR ORDER BY FECHA_ULT_MODIFICACION DESC) AS rn
    FROM
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_ordenes_pago_vida_retiros`
    WHERE
        VALOR_RETIRO > 25000000 
        AND FECHA_EMISION_POLIZA >= '2024-01-01'
        AND FECHA_EMISION_ENDOSO >= '2024-01-01'
        AND FECHA_FIN_POLIZA >= '2024-10-31'
)
SELECT
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    CODIGO_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    CODIGO_LOCALIDAD,
    VALOR_RETIRO,
    VALOR_GIRADO,
    ESTADO_REGISTRO,
    ESTADO_GIRO,
    ORDEN_PAGO,
    FECHA_ULT_MODIFICACION,
    FECHA_EMISION_POLIZA,
    FECHA_EMISION_ENDOSO,
    FECHA_FIN_POLIZA,
    MCA_ANULACION_POLIZA,
    CURRENT_DATE() AS FECHA_ALERTA
FROM ranked_data
WHERE rn = 1;



INSERT ---

-- Insertar solo los registros nuevos en la tabla SEG_0002_VISOR_REPO
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0002_VISOR_REPO
(
    CODIGO_COMPANIA,
    TIPO_DOCUMENTO,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    CODIGO_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    CODIGO_LOCALIDAD,
    VALOR_RETIRO,
    VALOR_GIRADO,
    ESTADO_REGISTRO,
    ESTADO_GIRO,
    ORDEN_PAGO,
    FECHA_ULT_MODIFICACION,
    FECHA_EMISION_POLIZA,
    FECHA_EMISION_ENDOSO,
    FECHA_FIN_POLIZA,
    MCA_ANULACION_POLIZA,
    FECHA_ALERTA
)
WITH ranked_data AS (
    SELECT
        CODIGO_COMPANIA,
        TIPO_DOCUMENTO,
        KEY_ID_TOMADOR,
        NUMERO_POLIZA,
        CODIGO_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        CODIGO_LOCALIDAD,
        VALOR_RETIRO,
        VALOR_GIRADO,
        ESTADO_REGISTRO,
        ESTADO_GIRO,
        ORDEN_PAGO,
        FECHA_ULT_MODIFICACION,
        FECHA_EMISION_POLIZA,
        FECHA_EMISION_ENDOSO,
        FECHA_FIN_POLIZA,
        MCA_ANULACION_POLIZA,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR ORDER BY FECHA_ULT_MODIFICACION DESC) AS rn
    FROM
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_ordenes_pago_vida_retiros`
    WHERE
        VALOR_RETIRO > 25000000 
        AND FECHA_EMISION_POLIZA >= '2024-01-01'
        AND FECHA_EMISION_ENDOSO >= '2024-01-01'
        AND FECHA_FIN_POLIZA >= '2024-10-31'
)
SELECT
    f.CODIGO_COMPANIA,
    f.TIPO_DOCUMENTO,
    f.KEY_ID_TOMADOR,
    f.NUMERO_POLIZA,
    f.CODIGO_RAMO_CONTABLE,
    f.CODIGO_PRODUCTO,
    f.CODIGO_LOCALIDAD,
    f.VALOR_RETIRO,
    f.VALOR_GIRADO,
    f.ESTADO_REGISTRO,
    f.ESTADO_GIRO,
    f.ORDEN_PAGO,
    f.FECHA_ULT_MODIFICACION,
    f.FECHA_EMISION_POLIZA,
    f.FECHA_EMISION_ENDOSO,
    f.FECHA_FIN_POLIZA,
    f.MCA_ANULACION_POLIZA,
    CURRENT_DATE() AS FECHA_ALERTA
FROM ranked_data f
LEFT JOIN sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0002_VISOR_REPO existing
    ON f.KEY_ID_TOMADOR = existing.KEY_ID_TOMADOR
    AND f.NUMERO_POLIZA = existing.NUMERO_POLIZA
WHERE f.rn = 1
  AND existing.KEY_ID_TOMADOR IS NULL;

