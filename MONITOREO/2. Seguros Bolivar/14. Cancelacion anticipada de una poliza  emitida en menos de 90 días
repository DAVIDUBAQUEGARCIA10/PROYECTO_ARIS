SELECT 
    FECHA_EMISION_ENDOSO_CANCELACION,
    FECHA_INICIO_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    FECHA_INICIO_VIGENCIA_POLIZA,
    FECHA_FIN_VIGENCIA_POLIZA,
    FECHA_ANULACION_POLIZA,
    CODIGO_COMPANIA,
    CODIGO_LOCALIDAD,
    CODIGO_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    DOCUMENTO_TOMADOR,
    NUMERO_ENDOSO,
    CODIGO_ENDOSO,
    SUB_CODIGO_ENDOSO,
    FECHA_CANCELACION_DEF
FROM 
    `sb-ecosistemaanalitico-lago.datamart.t_cancelaciones`
WHERE
    -- Condición para pólizas cuya anulación es dentro de los primeros 90 días
    DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_ENDOSO), DAY) <= 90
    AND DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_ENDOSO), DAY) >= 3
    AND -- Filtrar pólizas cuyo número termina en "01"
    RIGHT(CAST(NUMERO_POLIZA AS STRING), 2) = '01'
    AND FECHA_INICIO_VIGENCIA_POLIZA >= "2024-01-01"
    AND FECHA_INICIO_VIGENCIA_ENDOSO >= "2024-01-01"
    AND DOCUMENTO_TOMADOR NOT IN (860034313, 830053700)
    AND MARCA_CANCELACION_DEFINITIVA = "S"
    AND CODIGO_COMPANIA = '2'
GROUP BY
    FECHA_EMISION_ENDOSO_CANCELACION,
    FECHA_INICIO_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    FECHA_INICIO_VIGENCIA_POLIZA,
    FECHA_FIN_VIGENCIA_POLIZA,
    FECHA_ANULACION_POLIZA,
    CODIGO_COMPANIA,
    CODIGO_LOCALIDAD,
    CODIGO_RAMO_EMISION,
    CODIGO_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    CODIGO_SUBPRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    DOCUMENTO_TOMADOR,
    NUMERO_ENDOSO,
    CODIGO_ENDOSO,
    SUB_CODIGO_ENDOSO,
    FECHA_CANCELACION_DEF;
