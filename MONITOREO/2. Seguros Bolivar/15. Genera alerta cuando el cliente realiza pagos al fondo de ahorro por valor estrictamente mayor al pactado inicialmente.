WITH RankedPolizas AS (
    SELECT distinct
        a.TIPO_REGISTRO,
        a.CODIGO_COMPANIA,
        a.NOMBRE_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_RAMO_CONTABLE,
        a.NOMBRE_RAMO_CONTABLE,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.NUMERO_POLIZA,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.NUMERO_POLIZA_CLIENTE,
        a.FECHA_RECAUDO,
        a.VALOR_RECAUDO_MES,
        a.FORMA_COBRO,
        a.CODIGO_CANAL_DESCUENTO,
        a.CANAL_DESCUENTO,
        b.PRIMA_EMITIDA_CEDIDA,
        b.PRIMA_EMITIDA_RETENIDA,
        b.PRIMA_EMITIDA_FACULTATIVO,
        b.PRIMA_EMITIDA_CEDIDA_ACUMU,
        (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) AS prima_inicial,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR ORDER BY a.FECHA_EMISION_POLIZA ASC) AS row_num
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos` b
        ON a.NUMERO_POLIZA = b.NUMERO_POLIZA
    WHERE 
        a.TIPO_REGISTRO = 'RECAUDO'
        AND a.CODIGO_COMPANIA = 2
        AND a.FECHA_EMISION_POLIZA >= '2024-01-01'
        AND a.FECHA_VIGENCIA_POLIZA >= '2024-01-01'
        AND a.FECHA_VENCIMIENTO_POLIZA >= '2024-10-31'
        AND a.FECHA_RECAUDO >= '2024-01-01'
        AND a.VALOR_RECAUDO_MES > 0
        AND a.FORMA_COBRO NOT IN ('CONVENIO')
        AND b.PRIMA_EMITIDA_RETENIDA > 0
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        AND a.VALOR_RECAUDO_MES > (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) * 2
)
-- Seleccionamos solo el primer registro por NUMERO_DOCUMENTO_TOMADOR
SELECT *
FROM RankedPolizas
WHERE row_num = 1
