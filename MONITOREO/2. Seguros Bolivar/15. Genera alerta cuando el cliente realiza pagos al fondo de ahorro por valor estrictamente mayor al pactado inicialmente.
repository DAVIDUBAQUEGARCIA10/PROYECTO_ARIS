WITH RankedPolizas AS (
    SELECT distinct
        a.TIPO_REGISTRO,
        a.CODIGO_COMPANIA,
        a.NOMBRE_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_RAMO_CONTABLE,
        a.NOMBRE_RAMO_CONTABLE,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.NUMERO_POLIZA,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.PERIODICIDAD_PAGO,
        a.FECHA_RECAUDO,
        (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) AS VALOR_INICIAL,
        a.VALOR_RECAUDO_MES,
        a.VALOR_PRIMA_ANUAL,
        a.FORMA_COBRO,
        a.CODIGO_CANAL_DESCUENTO,
        a.CANAL_DESCUENTO,
        b.PRIMA_EMITIDA_CEDIDA,
        b.PRIMA_EMITIDA_RETENIDA,
        b.PRIMA_EMITIDA_FACULTATIVO,
        b.PRIMA_EMITIDA_CEDIDA_ACUMU,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR ORDER BY a.FECHA_EMISION_POLIZA ASC) AS row_num
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos` b
        ON a.NUMERO_POLIZA = b.NUMERO_POLIZA
    WHERE 
        a.TIPO_REGISTRO = 'RECAUDO'
        AND a.CODIGO_COMPANIA = 2
        AND a.FECHA_EMISION_POLIZA >= '2024-01-01'
        AND a.FECHA_VIGENCIA_POLIZA >= '2024-01-01'
        AND a.FECHA_VENCIMIENTO_POLIZA >= '2024-10-31'
        AND a.FECHA_RECAUDO >= '2024-01-01'
        AND a.VALOR_RECAUDO_MES > 0
        AND a.FORMA_COBRO NOT IN ('CONVENIO')
        AND b.PRIMA_EMITIDA_RETENIDA > 0
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        --AND a.VALOR_RECAUDO_MES > (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) * 2
        AND a.VALOR_RECAUDO_MES > (VALOR_PRIMA_ANUAL)
        AND a.CODIGO_LOCALIDAD != 3551
        AND a.TIPO_ENDOSO != 'AT'
        AND a.NUMERO_FACTURA = 1
        AND a.CANAL_DESCUENTO != 'LIBRANZA'
        AND a.FORMA_COBRO != 'CONVENIO'
)
-- Seleccionamos solo el primer registro por NUMERO_DOCUMENTO_TOMADOR
SELECT *
FROM RankedPolizas
WHERE row_num = 1



CREATE ---------------

-- Crear o reemplazar la tabla SEG_0062_VISOR_REPO con la fecha de alerta
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0062_VISOR_REPO AS
WITH RankedPolizas AS (
    SELECT distinct
        a.TIPO_REGISTRO,
        a.CODIGO_COMPANIA,
        a.NOMBRE_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_RAMO_CONTABLE,
        a.NOMBRE_RAMO_CONTABLE,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.NUMERO_POLIZA,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.PERIODICIDAD_PAGO,
        a.FECHA_RECAUDO,
        (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) AS VALOR_INICIAL,
        a.VALOR_RECAUDO_MES,
        a.VALOR_PRIMA_ANUAL,
        a.FORMA_COBRO,
        a.CODIGO_CANAL_DESCUENTO,
        a.CANAL_DESCUENTO,
        b.PRIMA_EMITIDA_CEDIDA,
        b.PRIMA_EMITIDA_RETENIDA,
        b.PRIMA_EMITIDA_FACULTATIVO,
        b.PRIMA_EMITIDA_CEDIDA_ACUMU,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR ORDER BY a.FECHA_EMISION_POLIZA ASC) AS row_num
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos` b
        ON a.NUMERO_POLIZA = b.NUMERO_POLIZA
    WHERE 
        a.TIPO_REGISTRO = 'RECAUDO'
        AND a.CODIGO_COMPANIA = 2
        AND a.FECHA_EMISION_POLIZA >= '2024-01-01'
        AND a.FECHA_VIGENCIA_POLIZA >= '2024-01-01'
        AND a.FECHA_VENCIMIENTO_POLIZA >= '2024-10-31'
        AND a.FECHA_RECAUDO >= '2024-01-01'
        AND a.VALOR_RECAUDO_MES > 0
        AND a.FORMA_COBRO NOT IN ('CONVENIO')
        AND b.PRIMA_EMITIDA_RETENIDA > 0
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        AND a.VALOR_RECAUDO_MES > (VALOR_PRIMA_ANUAL)
        AND a.CODIGO_LOCALIDAD != 3551
        AND a.TIPO_ENDOSO != 'AT'
        AND a.NUMERO_FACTURA = 1
        AND a.CANAL_DESCUENTO != 'LIBRANZA'
        AND a.FORMA_COBRO != 'CONVENIO'
)
-- Seleccionamos solo el primer registro por NUMERO_DOCUMENTO_TOMADOR y agregamos FECHA_ALERTA
SELECT 
    TIPO_REGISTRO,
    CODIGO_COMPANIA,
    NOMBRE_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_RAMO_CONTABLE,
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_POLIZA,
    FECHA_EMISION_POLIZA,
    FECHA_VIGENCIA_POLIZA,
    FECHA_VENCIMIENTO_POLIZA,
    FECHA_CANCELACION_POLIZA,
    FECHA_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    TIPO_DOCUMENTO_TOMADOR,
    NUMERO_DOCUMENTO_TOMADOR,
    PERIODICIDAD_PAGO,
    FECHA_RECAUDO,
    VALOR_INICIAL,
    VALOR_RECAUDO_MES,
    VALOR_PRIMA_ANUAL,
    FORMA_COBRO,
    CODIGO_CANAL_DESCUENTO,
    CANAL_DESCUENTO,
    PRIMA_EMITIDA_CEDIDA,
    PRIMA_EMITIDA_RETENIDA,
    PRIMA_EMITIDA_FACULTATIVO,
    PRIMA_EMITIDA_CEDIDA_ACUMU,
     FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,    
    CURRENT_DATE() AS FECHA_ALERTA -- Agregar la fecha de alerta
FROM RankedPolizas
WHERE row_num = 1
ORDER BY FECHA_EMISION_POLIZA ASC;



INSERT ---------------

-- Insertar solo registros nuevos en la tabla SEG_0062_VISOR_REPO
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0062_VISOR_REPO
WITH RankedPolizas AS (
    SELECT distinct
        a.TIPO_REGISTRO,
        a.CODIGO_COMPANIA,
        a.NOMBRE_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_RAMO_CONTABLE,
        a.NOMBRE_RAMO_CONTABLE,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.NUMERO_POLIZA,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.PERIODICIDAD_PAGO,
        a.FECHA_RECAUDO,
        (b.PRIMA_EMITIDA_CEDIDA + b.PRIMA_EMITIDA_RETENIDA) AS VALOR_INICIAL,
        a.VALOR_RECAUDO_MES,
        a.VALOR_PRIMA_ANUAL,
        a.FORMA_COBRO,
        a.CODIGO_CANAL_DESCUENTO,
        a.CANAL_DESCUENTO,
        b.PRIMA_EMITIDA_CEDIDA,
        b.PRIMA_EMITIDA_RETENIDA,
        b.PRIMA_EMITIDA_FACULTATIVO,
        b.PRIMA_EMITIDA_CEDIDA_ACUMU,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR ORDER BY a.FECHA_EMISION_POLIZA ASC) AS row_num
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos` b
        ON a.NUMERO_POLIZA = b.NUMERO_POLIZA
    WHERE 
        a.TIPO_REGISTRO = 'RECAUDO'
        AND a.CODIGO_COMPANIA = 2
        AND a.FECHA_EMISION_POLIZA >= '2024-01-01'
        AND a.FECHA_VIGENCIA_POLIZA >= '2024-01-01'
        AND a.FECHA_VENCIMIENTO_POLIZA >= '2024-10-31'
        AND a.FECHA_RECAUDO >= '2024-01-01'
        AND a.VALOR_RECAUDO_MES > 0
        AND a.FORMA_COBRO NOT IN ('CONVENIO')
        AND b.PRIMA_EMITIDA_RETENIDA > 0
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        AND a.VALOR_RECAUDO_MES > (VALOR_PRIMA_ANUAL)
        AND a.CODIGO_LOCALIDAD != 3551
        AND a.TIPO_ENDOSO != 'AT'
        AND a.NUMERO_FACTURA = 1
        AND a.CANAL_DESCUENTO != 'LIBRANZA'
        AND a.FORMA_COBRO != 'CONVENIO'
)
-- Insertar solo registros nuevos
SELECT 
    TIPO_REGISTRO,
    CODIGO_COMPANIA,
    NOMBRE_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_RAMO_CONTABLE,
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_POLIZA,
    FECHA_EMISION_POLIZA,
    FECHA_VIGENCIA_POLIZA,
    FECHA_VENCIMIENTO_POLIZA,
    FECHA_CANCELACION_POLIZA,
    FECHA_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    TIPO_DOCUMENTO_TOMADOR,
    NUMERO_DOCUMENTO_TOMADOR,
    PERIODICIDAD_PAGO,
    FECHA_RECAUDO,
    VALOR_INICIAL,
    VALOR_RECAUDO_MES,
    VALOR_PRIMA_ANUAL,
    FORMA_COBRO,
    CODIGO_CANAL_DESCUENTO,
    CANAL_DESCUENTO,
    PRIMA_EMITIDA_CEDIDA,
    PRIMA_EMITIDA_RETENIDA,
    PRIMA_EMITIDA_FACULTATIVO,
    PRIMA_EMITIDA_CEDIDA_ACUMU,
     FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,    
    CURRENT_DATE() AS FECHA_ALERTA -- Agregar la fecha de alerta
FROM RankedPolizas
WHERE row_num = 1
  AND NOT EXISTS (
      SELECT 1
      FROM sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0062_VISOR_REPO existing
      WHERE existing.NUMERO_DOCUMENTO_TOMADOR = RankedPolizas.NUMERO_DOCUMENTO_TOMADOR
        AND existing.NUMERO_POLIZA = RankedPolizas.NUMERO_POLIZA
  )
ORDER BY FECHA_EMISION_POLIZA ASC;
