CREATE ---
-- Crear o reemplazar la tabla SEG_0101B_VISOR_REPO con siniestros relevantes
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0101B_VISOR_REPO AS 
WITH SiniestrosConFila AS (
    SELECT
        CODIGO_COMPANIA, 
        CODIGO_RAMO_CONTABLE, 
        NOMBRE_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        NOMBRE_PRODUCTO,
        NUMERO_SECUENCIA_POLIZA,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        KEY_ID_TOMADOR,
        KEY_ID_ASEGURADO,
        KEY_ID_BENEFICIARIO,          
        FECHA_SINIESTRO,
        FECHA_SUSCRIPCION,
        ESTADO_SINIESTRO,
        FECHA_ORDEN_PAGO,
        LIQUIDADO_BOLIVAR,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR,LIQUIDADO_BOLIVAR ORDER BY FECHA_SUSCRIPCION) AS fila
    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE 
        DATE(FECHA_SUSCRIPCION) >= '2025-01-01'
        AND DATE_DIFF(DATE(FECHA_SINIESTRO), DATE(FECHA_SUSCRIPCION), DAY) <= 90
        AND CODIGO_COMPANIA = 2
        AND DATE(FECHA_SINIESTRO) >= '2025-01-01'
        AND CODIGO_RAMO_CONTABLE NOT IN (45, 34)
        AND LIQUIDADO_BOLIVAR > 50000000
        AND FECHA_ORDEN_PAGO IS NOT NULL
        AND LENGTH(KEY_ID_BENEFICIARIO) > 10
        AND CODIGO_PRODUCTO != 948
        AND KEY_ID_BENEFICIARIO NOT IN (
            '860002964', '860007738', '860002962', '890903937', '890903938', '860051705',
            '860051135', '860050930', '860050750', '860003020', '860007660', '860034594',
            '891500015', '860050923', '890300279', '860506648', '860047549', '800149923',
            '860007335', '860031629', '860034921', '800240382', '860034313', '860035827',
            '860034133', '890913341', '860038717', '860005247', '890100375', '890800186',
            '890903852', '890300653', '860021978', '899999088', '860509022', '830010945',
            '800235426', '890927034', '860065913', '890200756', '860045057', '860006797',
            '860054531', '890921129', '860068182', '800019807', '860051175', '890926749',
            '800115324', '800120184', '800103498', '800073493', '860079174', '860071562',
            '890938637', '800155645', '860000185', '860009934', '890905375', '800128735',
            '890931609', '800149768', '860503748', '830118120', '800173489', '830006366',
            '800169496', '800079742', '800039146', '805011494', '805001015', '800163076',
            '800188178', '800149452', '830063708', '800149496', '800148514'
        )
        AND KEY_ID_TOMADOR NOT IN (
            '860002964', '860007738', '860002962', '890903937', '890903938', '860051705',
            '860051135', '860050930', '860050750', '860003020', '860007660', '860034594',
            '891500015', '860050923', '890300279', '860506648', '860047549', '800149923',
            '860007335', '860031629', '860034921', '800240382', '860034313', '860035827',
            '860034133', '890913341', '860038717', '860005247', '890100375', '890800186',
            '890903852', '890300653', '860021978', '899999088', '860509022', '830010945',
            '800235426', '890927034', '860065913', '890200756', '860045057', '860006797',
            '860054531', '890921129', '860068182', '800019807', '860051175', '890926749',
            '800115324', '800120184', '800103498', '800073493', '860079174', '860071562',
            '890938637', '800155645', '860000185', '860009934', '890905375', '800128735',
            '890931609', '800149768', '860503748', '830118120', '800173489', '830006366',
            '800169496', '800079742', '800039146', '805011494', '805001015', '800163076',
            '800188178', '800149452', '830063708', '800149496', '800148514'
        )
)
SELECT 
    CODIGO_COMPANIA, 
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,     
    FECHA_SINIESTRO,
    FECHA_SUSCRIPCION,
    ESTADO_SINIESTRO,
    FECHA_ORDEN_PAGO,
    LIQUIDADO_BOLIVAR,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,    
    CURRENT_DATE() AS FECHA_ALERTA
FROM 
    SiniestrosConFila
WHERE 
    fila = 1;




















INSERT ----
-- Insertar solo registros nuevos
-- Insertar solo registros nuevos
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0101B_VISOR_REPO 
(
    CODIGO_COMPANIA,  -- Código de la compañía aseguradora
    CODIGO_RAMO_CONTABLE,  -- Código contable del ramo
    NOMBRE_RAMO_CONTABLE,  -- Nombre del ramo contable
    CODIGO_PRODUCTO,  -- Código del producto asegurado
    NOMBRE_PRODUCTO,  -- Nombre del producto asegurado
    NUMERO_SECUENCIA_POLIZA,  -- Secuencia interna de la póliza
    NUMERO_POLIZA,  -- Número de póliza
    TIPO_DOCUMENTO_TOMADOR,  -- Tipo de documento del tomador
    KEY_ID_TOMADOR,  -- Identificador único del tomador
    KEY_ID_ASEGURADO,  -- Identificador único del asegurado
    KEY_ID_BENEFICIARIO,  -- Identificador único del beneficiario
    FECHA_SINIESTRO,  -- Fecha del siniestro
    FECHA_SUSCRIPCION,  -- Fecha de suscripción de la póliza
    ESTADO_SINIESTRO,  -- Estado actual del siniestro
    FECHA_ORDEN_PAGO,  -- Fecha en la que se ordenó el pago
    LIQUIDADO_BOLIVAR,  -- Valor del siniestro liquidado en pesos
    FECHA_ALERTA_MES,  -- Mes de generación de la alerta
    FECHA_ALERTA  -- Fecha actual como fecha de alerta
)
WITH SiniestrosConFila AS (
    SELECT
        CODIGO_COMPANIA, 
        CODIGO_RAMO_CONTABLE, 
        NOMBRE_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        NOMBRE_PRODUCTO,
        NUMERO_SECUENCIA_POLIZA,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        KEY_ID_TOMADOR,
        KEY_ID_ASEGURADO,
        KEY_ID_BENEFICIARIO,          
        FECHA_SINIESTRO,
        FECHA_SUSCRIPCION,
        ESTADO_SINIESTRO,
        FECHA_ORDEN_PAGO,
        LIQUIDADO_BOLIVAR,
        ROW_NUMBER() OVER (
            PARTITION BY KEY_ID_TOMADOR, LIQUIDADO_BOLIVAR 
            ORDER BY FECHA_SUSCRIPCION
        ) AS fila  -- Asigna número de fila para quedarnos con el primer registro por tomador y monto
    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE 
        DATE(FECHA_SUSCRIPCION) >= '2025-01-01'  -- Pólizas suscritas desde el 2025
        AND DATE_DIFF(DATE(FECHA_SINIESTRO), DATE(FECHA_SUSCRIPCION), DAY) <= 90  -- Siniestro dentro de los 90 días desde la suscripción
        AND CODIGO_COMPANIA = 2  -- Compañía específica
        AND DATE(FECHA_SINIESTRO) >= '2025-01-01'  -- Siniestros desde 2025
        AND CODIGO_RAMO_CONTABLE NOT IN (45, 34)  -- Exclusión de ciertos ramos contables
        AND LIQUIDADO_BOLIVAR > 50000000  -- Siniestros con valor superior a 50 millones
        AND FECHA_ORDEN_PAGO IS NOT NULL  -- Que tengan orden de pago
        AND LENGTH(KEY_ID_BENEFICIARIO) > 10  -- Que el identificador del beneficiario sea válido
        AND CODIGO_PRODUCTO != 948  -- Exclusión de productos financieros obligatorios
        AND KEY_ID_BENEFICIARIO NOT IN (
            '860002964', '860007738', '860002962', '890903937', '890903938', '860051705',
            '860051135', '860050930', '860050750', '860003020', '860007660', '860034594',
            '891500015', '860050923', '890300279', '860506648', '860047549', '800149923',
            '860007335', '860031629', '860034921', '800240382', '860034313', '860035827',
            '860034133', '890913341', '860038717', '860005247', '890100375', '890800186',
            '890903852', '890300653', '860021978', '899999088', '860509022', '830010945',
            '800235426', '890927034', '860065913', '890200756', '860045057', '860006797',
            '860054531', '890921129', '860068182', '800019807', '860051175', '890926749',
            '800115324', '800120184', '800103498', '800073493', '860079174', '860071562',
            '890938637', '800155645', '860000185', '860009934', '890905375', '800128735',
            '890931609', '800149768', '860503748', '830118120', '800173489', '830006366',
            '800169496', '800079742', '800039146', '805011494', '805001015', '800163076',
            '800188178', '800149452', '830063708', '800149496', '800148514'
        )
        AND KEY_ID_TOMADOR NOT IN (
            '860002964', '860007738', '860002962', '890903937', '890903938', '860051705',
            '860051135', '860050930', '860050750', '860003020', '860007660', '860034594',
            '891500015', '860050923', '890300279', '860506648', '860047549', '800149923',
            '860007335', '860031629', '860034921', '800240382', '860034313', '860035827',
            '860034133', '890913341', '860038717', '860005247', '890100375', '890800186',
            '890903852', '890300653', '860021978', '899999088', '860509022', '830010945',
            '800235426', '890927034', '860065913', '890200756', '860045057', '860006797',
            '860054531', '890921129', '860068182', '800019807', '860051175', '890926749',
            '800115324', '800120184', '800103498', '800073493', '860079174', '860071562',
            '890938637', '800155645', '860000185', '860009934', '890905375', '800128735',
            '890931609', '800149768', '860503748', '830118120', '800173489', '830006366',
            '800169496', '800079742', '800039146', '805011494', '805001015', '800163076',
            '800188178', '800149452', '830063708', '800149496', '800148514'
        )
)

SELECT 
    CODIGO_COMPANIA, 
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,     
    FECHA_SINIESTRO,
    FECHA_SUSCRIPCION,
    ESTADO_SINIESTRO,
    FECHA_ORDEN_PAGO,
    LIQUIDADO_BOLIVAR,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,  -- Mes de alerta
    CURRENT_DATE() AS FECHA_ALERTA  -- Fecha exacta de alerta
FROM 
    SiniestrosConFila
WHERE 
    fila = 1  -- Se selecciona el registro más antiguo por tomador y monto liquidado
    AND NOT EXISTS (
        -- Evita insertar registros duplicados
        SELECT 1
        FROM sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0101B_VISOR_REPO existing
        WHERE existing.NUMERO_POLIZA = SiniestrosConFila.NUMERO_POLIZA
        AND existing.KEY_ID_TOMADOR = SiniestrosConFila.KEY_ID_TOMADOR
    );


