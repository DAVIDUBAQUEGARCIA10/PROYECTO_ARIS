CREATE ----
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0102B_VISOR_REPO AS
WITH SiniestrosConFila AS (
    SELECT
        CODIGO_COMPANIA, 
        CODIGO_RAMO_CONTABLE, 
        NOMBRE_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        NOMBRE_PRODUCTO,
        NUMERO_SECUENCIA_POLIZA,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        KEY_ID_TOMADOR,
        KEY_ID_ASEGURADO,
        KEY_ID_BENEFICIARIO,          
        FECHA_SINIESTRO,
        FECHA_SUSCRIPCION,
        ESTADO_SINIESTRO,
        FECHA_ORDEN_PAGO,
        LIQUIDADO_BOLIVAR,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR,LIQUIDADO_BOLIVAR ORDER BY FECHA_SUSCRIPCION) AS fila
    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE 
        DATE(FECHA_SINIESTRO) >= '2024-01-01'  -- Convertir FECHA_SUSCRIPCION a DATE
        AND DATE_DIFF(DATE(FECHA_SINIESTRO), DATE(FECHA_SUSCRIPCION), DAY) <= 90 -- En menos de 3 meses de emitida la póliza
        AND CODIGO_COMPANIA = 2 -- Filtro para solo Seguros Bolívar
        AND CODIGO_RAMO_CONTABLE NOT IN (45, 34) -- Excluir ramos de Salud y otros
        AND LIQUIDADO_BOLIVAR > 100000000 -- Siniestros mayores a este monto
        AND FECHA_ORDEN_PAGO IS NOT NULL -- Los cuales ya están pagados
        --AND TIPO_DOCUMENTO_TOMADOR IN ('NT', 'NE')  -- Incluir solo Jurídicos
        AND LENGTH(KEY_ID_BENEFICIARIO) < 10
        AND KEY_ID_BENEFICIARIO NOT IN ('860002964', '860007738', '860002962', '890903937', '890903938', '860051705', '860051135', '860050930', '860050750', '860003020', '860007660', '860034594', '891500015', '860050923', '890300279', '860506648', '860047549', '800149923', '860007335', '860031629', '860034921', '800240382', '860034313', '860035827', '860034133', '890913341', '860038717', '860005247', '890100375', '890800186', '890903852', '890300653', '860021978', '899999088', '860509022', '830010945', '800235426', '890927034', '860065913', '890200756', '860045057', '860006797', '860054531', '890921129', '860068182', '800019807', '860051175', '890926749', '800115324', '800120184', '800103498', '800073493', '860079174', '860071562', '890938637', '800155645', '860000185', '860009934', '890905375', '800128735', '890931609', '800149768', '860503748', '830118120', '800173489', '830006366', '800169496', '800079742', '800039146', '805011494', '805001015', '800163076', '800188178', '800149452', '830063708','800149496',"800148514")
        AND KEY_ID_TOMADOR NOT IN ('860002964', '860007738', '860002962', '890903937', '890903938', '860051705', '860051135', '860050930', '860050750', '860003020', '860007660', '860034594', '891500015', '860050923', '890300279', '860506648', '860047549', '800149923', '860007335', '860031629', '860034921', '800240382', '860034313', '860035827', '860034133', '890913341', '860038717', '860005247', '890100375', '890800186', '890903852', '890300653', '860021978', '899999088', '860509022', '830010945', '800235426', '890927034', '860065913', '890200756', '860045057', '860006797', '860054531', '890921129', '860068182', '800019807', '860051175', '890926749', '800115324', '800120184', '800103498', '800073493', '860079174', '860071562', '890938637', '800155645', '860000185', '860009934', '890905375', '800128735', '890931609', '800149768', '860503748', '830118120', '800173489', '830006366', '800169496', '800079742', '800039146', '805011494', '805001015', '800163076', '800188178', '800149452', '830063708','800149496',"800148514")
)
SELECT 
    CODIGO_COMPANIA, 
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,     
    FECHA_SINIESTRO,
    FECHA_SUSCRIPCION,
    ESTADO_SINIESTRO,
    FECHA_ORDEN_PAGO,
    LIQUIDADO_BOLIVAR,
     FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA -- Se agrega la columna FECHA_ALERTA con la fecha de ejecución
FROM 
    SiniestrosConFila
WHERE 
    fila = 1;  -- Solo selecciona la primera fila de cada KEY_ID_TOMADOR


INSERT --
-- INSERTAR NUEVOS REGISTROS Y AGREGAR LA COLUMNA FECHA_ALERTA
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0102B_VISOR_REPO 
(
    CODIGO_COMPANIA, 
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,     
    FECHA_SINIESTRO,
    FECHA_SUSCRIPCION,
    ESTADO_SINIESTRO,
    FECHA_ORDEN_PAGO,
    LIQUIDADO_BOLIVAR,
    FECHA_ALERTA_MES,
    FECHA_ALERTA
)
WITH SiniestrosConFila AS (
    SELECT
        CODIGO_COMPANIA, 
        CODIGO_RAMO_CONTABLE, 
        NOMBRE_RAMO_CONTABLE,
        CODIGO_PRODUCTO,
        NOMBRE_PRODUCTO,
        NUMERO_SECUENCIA_POLIZA,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        KEY_ID_TOMADOR,
        KEY_ID_ASEGURADO,
        KEY_ID_BENEFICIARIO,          
        FECHA_SINIESTRO,
        FECHA_SUSCRIPCION,
        ESTADO_SINIESTRO,
        FECHA_ORDEN_PAGO,
        LIQUIDADO_BOLIVAR,
        ROW_NUMBER() OVER (PARTITION BY KEY_ID_TOMADOR,LIQUIDADO_BOLIVAR ORDER BY FECHA_SUSCRIPCION) AS fila
    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE 
        DATE(FECHA_SINIESTRO) >= '2024-01-01'  -- Convertir FECHA_SUSCRIPCION a DATE
        AND DATE_DIFF(DATE(FECHA_SINIESTRO), DATE(FECHA_SUSCRIPCION), DAY) <= 90 -- En menos de 3 meses de emitida la póliza
        AND CODIGO_COMPANIA = 2 -- Filtro para solo Seguros Bolívar
        AND CODIGO_RAMO_CONTABLE NOT IN (45, 34) -- Excluir ramos de Salud y otros
        AND LIQUIDADO_BOLIVAR > 100000000 -- Siniestros mayores a este monto
        AND FECHA_ORDEN_PAGO IS NOT NULL -- Los cuales ya están pagados
        --AND TIPO_DOCUMENTO_TOMADOR IN ('NT', 'NE')  -- Incluir solo Jurídicos
        AND LENGTH(KEY_ID_BENEFICIARIO) < 10
        AND KEY_ID_BENEFICIARIO NOT IN ('860002964', '860007738', '860002962', '890903937', '890903938', '860051705', '860051135', '860050930', '860050750', '860003020', '860007660', '860034594', '891500015', '860050923', '890300279', '860506648', '860047549', '800149923', '860007335', '860031629', '860034921', '800240382', '860034313', '860035827', '860034133', '890913341', '860038717', '860005247', '890100375', '890800186', '890903852', '890300653', '860021978', '899999088', '860509022', '830010945', '800235426', '890927034', '860065913', '890200756', '860045057', '860006797', '860054531', '890921129', '860068182', '800019807', '860051175', '890926749', '800115324', '800120184', '800103498', '800073493', '860079174', '860071562', '890938637', '800155645', '860000185', '860009934', '890905375', '800128735', '890931609', '800149768', '860503748', '830118120', '800173489', '830006366', '800169496', '800079742', '800039146', '805011494', '805001015', '800163076', '800188178', '800149452', '830063708','800149496',"800148514")
        AND KEY_ID_TOMADOR NOT IN ('860002964', '860007738', '860002962', '890903937', '890903938', '860051705', '860051135', '860050930', '860050750', '860003020', '860007660', '860034594', '891500015', '860050923', '890300279', '860506648', '860047549', '800149923', '860007335', '860031629', '860034921', '800240382', '860034313', '860035827', '860034133', '890913341', '860038717', '860005247', '890100375', '890800186', '890903852', '890300653', '860021978', '899999088', '860509022', '830010945', '800235426', '890927034', '860065913', '890200756', '860045057', '860006797', '860054531', '890921129', '860068182', '800019807', '860051175', '890926749', '800115324', '800120184', '800103498', '800073493', '860079174', '860071562', '890938637', '800155645', '860000185', '860009934', '890905375', '800128735', '890931609', '800149768', '860503748', '830118120', '800173489', '830006366', '800169496', '800079742', '800039146', '805011494', '805001015', '800163076', '800188178', '800149452', '830063708','800149496',"800148514")
)
SELECT 
    CODIGO_COMPANIA, 
    CODIGO_RAMO_CONTABLE, 
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,     
    FECHA_SINIESTRO,
    FECHA_SUSCRIPCION,
    ESTADO_SINIESTRO,
    FECHA_ORDEN_PAGO,
    LIQUIDADO_BOLIVAR,
     FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA -- Se agrega la fecha de alerta con la fecha de ejecución
FROM 
    SiniestrosConFila
WHERE 
    fila = 1  -- Solo selecciona la primera fila de cada KEY_ID_TOMADOR
    AND NOT EXISTS ( -- Verifica si el registro no existe ya en la tabla de destino
        SELECT 1
        FROM sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0102B_VISOR_REPO t
        WHERE t.KEY_ID_TOMADOR = SiniestrosConFila.KEY_ID_TOMADOR
          AND t.NUMERO_POLIZA = SiniestrosConFila.NUMERO_POLIZA
    );
