WITH polizas_filtro AS (
    SELECT 
        t1.CODIGO_COMPANIA,
        t1.CODIGO_RAMO_EMISION,
        t1.NOMBRE_RAMO_EMISION,
        t1.CODIGO_PRODUCTO,
        t1.NOMBRE_PRODUCTO,
        t1.CODIGO_SUBPRODUCTO,
        t1.NOMBRE_SUBPRODUCTO,
        t1.NUMERO_POLIZA_ANTERIOR,
        t1.NUMERO_POLIZA,
        t1.TIPO_DOCUMENTO_TOMADOR,
        t1.KEY_ID_TOMADOR,
        t1.TIPO_DOCUMENTO_ASEGURADO,
        t1.KEY_ID_ASEGURADO,
        CAST(t1.FECHA_FIN_ENDOSO AS DATE) AS FECHA_FIN_ENDOSO,
        CAST(t1.FECHA_FIN_POLIZA AS DATE) AS FECHA_FIN_POLIZA,
        t1.VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA,
        t1.COD_MOTIVO_CANCELACION_POLIZA,
        t1.DES_MOTIVO_CANCELACION_POLIZA
    FROM 
        sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t1
    WHERE 
        t1.VALOR_ASEGURADO > 1.75 * t1.VALOR_ASEGURADO
        AND CAST(t1.FECHA_FIN_ENDOSO AS DATE) > CURRENT_DATE()
        AND CAST(t1.FECHA_FIN_POLIZA AS DATE) > CURRENT_DATE()
        AND t1.CODIGO_COMPANIA = 2
)

SELECT 
    p1.*,
    t2.VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA_ANTERIOR,
    t2.NUMERO_POLIZA_ANTERIOR AS NUMERO_POLIZA_ANTERIOR
FROM 
    polizas_filtro p1
INNER JOIN 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t2
    ON p1.NUMERO_POLIZA_ANTERIOR = t2.NUMERO_POLIZA
;
