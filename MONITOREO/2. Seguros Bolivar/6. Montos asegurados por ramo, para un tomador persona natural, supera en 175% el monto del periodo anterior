SELECT DISTINCT 
    t1.CODIGO_COMPANIA,
    t1.CODIGO_RAMO_EMISION,
    t1.NOMBRE_RAMO_EMISION,
    t1.CODIGO_PRODUCTO,
    t1.NOMBRE_PRODUCTO,
    t1.CODIGO_SUBPRODUCTO,
    t1.NOMBRE_SUBPRODUCTO,
    t1.NUMERO_POLIZA_ANTERIOR,
    t2.SUM_VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA_ANTERIOR, 
    t1.NUMERO_POLIZA  AS NUMERO_POLIZA_ACTUAL,
    t1.SUM_VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA_ACTUAL,    
    t1.TIPO_DOCUMENTO_TOMADOR,
    t1.KEY_ID_TOMADOR,
    t1.TIPO_DOCUMENTO_ASEGURADO,
    t1.KEY_ID_ASEGURADO,
    t1.FECHA_INICIO_POLIZA,
    t1.FECHA_FIN_ENDOSO,
    t1.FECHA_FIN_POLIZA
FROM 
    (
        SELECT 
            CODIGO_COMPANIA,
            CODIGO_RAMO_EMISION,
            NOMBRE_RAMO_EMISION,
            CODIGO_PRODUCTO,
            NOMBRE_PRODUCTO,
            CODIGO_SUBPRODUCTO,
            NOMBRE_SUBPRODUCTO,
            NUMERO_POLIZA_ANTERIOR,
            NUMERO_POLIZA,
            TIPO_DOCUMENTO_TOMADOR,
            KEY_ID_TOMADOR,
            TIPO_DOCUMENTO_ASEGURADO,
            KEY_ID_ASEGURADO,
            FECHA_INICIO_POLIZA,
            FECHA_FIN_ENDOSO,
            FECHA_FIN_POLIZA,
            SUM(VALOR_ASEGURADO) AS SUM_VALOR_ASEGURADO
        FROM 
            sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos
        WHERE FECHA_EMISION_ENDOSO >= "2024-01-01"
            AND FECHA_EMISION_ENDOSO <= "2024-11-30"
            AND FECHA_FIN_ENDOSO > "2024-11-30"
            AND TIPO_DOCUMENTO_TOMADOR NOT IN ('NT', 'NE')
            AND CODIGO_RAMO_EMISION NOT IN (18, 20, 22, 24, 26, 29, 30, 33, 34, 42, 69, 70, 118, 10,12,66, 310)
            AND NUMERO_POLIZA_ANTERIOR IS NOT NULL 
            AND ALTURA_POLIZA != "1"
            AND CODIGO_COMPANIA = 2
            AND NUMERO_ENDOSO = 0 
            AND CODIGO_RIESGO = 1
        GROUP BY
            CODIGO_COMPANIA,
            CODIGO_RAMO_EMISION,
            NOMBRE_RAMO_EMISION,
            CODIGO_PRODUCTO,
            NOMBRE_PRODUCTO,
            CODIGO_SUBPRODUCTO,
            NOMBRE_SUBPRODUCTO,
            NUMERO_POLIZA_ANTERIOR,
            NUMERO_POLIZA,
            TIPO_DOCUMENTO_TOMADOR,
            KEY_ID_TOMADOR,
            TIPO_DOCUMENTO_ASEGURADO,
            KEY_ID_ASEGURADO,
            FECHA_INICIO_POLIZA,
            FECHA_FIN_ENDOSO,
            FECHA_FIN_POLIZA
    ) t1
LEFT JOIN 
    (
        SELECT 
            CODIGO_COMPANIA,
            CODIGO_RAMO_EMISION,
            NOMBRE_RAMO_EMISION,
            CODIGO_PRODUCTO,
            NOMBRE_PRODUCTO,
            CODIGO_SUBPRODUCTO,
            NOMBRE_SUBPRODUCTO,
            NUMERO_POLIZA_ANTERIOR,
            NUMERO_POLIZA,
            TIPO_DOCUMENTO_TOMADOR,
            KEY_ID_TOMADOR,
            TIPO_DOCUMENTO_ASEGURADO,
            KEY_ID_ASEGURADO,
            FECHA_INICIO_POLIZA,
            FECHA_FIN_ENDOSO,
            FECHA_FIN_POLIZA,
            SUM(VALOR_ASEGURADO) AS SUM_VALOR_ASEGURADO
        FROM 
            sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos
        WHERE TIPO_DOCUMENTO_TOMADOR NOT IN ('NT', 'NE')
            AND CODIGO_RAMO_EMISION NOT IN (18, 20, 22, 24, 26, 29, 30, 33, 34, 42, 69, 70, 118, 10,12,66, 310)
            AND CODIGO_COMPANIA = 2
            AND NUMERO_ENDOSO = 0 
            AND CODIGO_RIESGO = 1
        GROUP BY
            CODIGO_COMPANIA,
            CODIGO_RAMO_EMISION,
            NOMBRE_RAMO_EMISION,
            CODIGO_PRODUCTO,
            NOMBRE_PRODUCTO,
            CODIGO_SUBPRODUCTO,
            NOMBRE_SUBPRODUCTO,
            NUMERO_POLIZA_ANTERIOR,
            NUMERO_POLIZA,
            TIPO_DOCUMENTO_TOMADOR,
            KEY_ID_TOMADOR,
            TIPO_DOCUMENTO_ASEGURADO,
            KEY_ID_ASEGURADO,
            FECHA_INICIO_POLIZA,
            FECHA_FIN_ENDOSO,
            FECHA_FIN_POLIZA
    ) t2 
ON t1.NUMERO_POLIZA_ANTERIOR = t2.NUMERO_POLIZA 
   AND t1.KEY_ID_ASEGURADO = t2.KEY_ID_ASEGURADO
WHERE t1.SUM_VALOR_ASEGURADO > 1.75 * t2.SUM_VALOR_ASEGURADO
  AND RIGHT(CAST(t1.NUMERO_POLIZA_ANTERIOR AS STRING), 2) = RIGHT(CAST(t1.NUMERO_POLIZA AS STRING), 2);
