CREATE -----

# Crear o reemplazar tabla que consolida alertas por tomadores en lista restrictiva
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0311_VISOR_REPO AS

# ---------------------------
# CTE: PolizasConFila
# Se selecciona la última póliza vigente por tomador de lista 23
# ---------------------------
WITH PolizasConFila AS (
    SELECT 
        # Datos generales de la póliza
        p.CODIGO_COMPANIA, p.CODIGO_RAMO_EMISION, p.NOMBRE_RAMO_EMISION,
        p.CODIGO_PRODUCTO, p.NOMBRE_PRODUCTO, p.CLAVE_AGENTE,
        p.CODIGO_LOCALIDAD, p.NOMBRE_LOCALIDAD, p.CODIGO_CANAL, p.NOMBRE_CANAL,
        p.NUMERO_POLIZA, p.NUMERO_POLIZA_MADRE, p.TIPO_DOCUMENTO_TOMADOR,
        p.KEY_ID_TOMADOR, p.FECHA_INICIO_POLIZA, p.FECHA_FIN_POLIZA,
        p.FECHA_CORTE, p.FECHA_EMISION_ENDOSO, p.FECHA_EMISION_ORIGINAL,

        # Datos de lista restrictiva
        l.NOMBRES, l.OBSERVACIONES, l.CODIGO_LISTA, l.NOMBRE_LISTA,

        # Marca si es PEP
        tcn.PUBLICAMENTE_EXPUESTA,

        # Número de fila para seleccionar la más reciente por tomador
        ROW_NUMBER() OVER (
            PARTITION BY CAST(p.KEY_ID_TOMADOR AS STRING), CAST(p.TIPO_DOCUMENTO_TOMADOR AS STRING)
            ORDER BY p.FECHA_EMISION_ENDOSO DESC
        ) AS fila,

        # Metadatos de fecha
        FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES, 
        CURRENT_DATE() AS FECHA_ALERTA

    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas` p
    
    INNER JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_lista_restrictivas` l
        ON p.TIPO_DOCUMENTO_TOMADOR = l.TIPO_DOCUMENTO
        AND p.KEY_ID_TOMADOR = l.KEY_ID
        AND l.CODIGO_LISTA = '23'
    
    INNER JOIN (
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales
    
    UNION ALL
    
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos) tcn
        ON p.TIPO_DOCUMENTO_TOMADOR = tcn.TIPO_DOCUMENTO
        AND p.KEY_ID_TOMADOR = tcn.KEY_ID
    
    WHERE 
        p.FECHA_FIN_POLIZA > CURRENT_TIMESTAMP()   # Vigentes
        AND p.CODIGO_COMPANIA = 2                  # Solo compañía 2
        AND p.FECHA_INICIO_POLIZA >= "2025-01-01" 
        AND tcn.PUBLICAMENTE_EXPUESTA != 'S'     # Clientes recientes
)

# ---------------------------
# Selección final para la tabla
# Incluye unión de personas naturales y jurídicas para validar PEPs
# ---------------------------
SELECT 
    p.CODIGO_COMPANIA, p.CODIGO_RAMO_EMISION, p.NOMBRE_RAMO_EMISION,
    p.CODIGO_PRODUCTO, p.NOMBRE_PRODUCTO, p.CLAVE_AGENTE,
    p.CODIGO_LOCALIDAD, p.NOMBRE_LOCALIDAD, p.CODIGO_CANAL, p.NOMBRE_CANAL,
    p.NUMERO_POLIZA, p.NUMERO_POLIZA_MADRE, p.TIPO_DOCUMENTO_TOMADOR,
    p.KEY_ID_TOMADOR, p.FECHA_INICIO_POLIZA, p.FECHA_FIN_POLIZA,
    p.FECHA_CORTE, p.FECHA_EMISION_ENDOSO, p.FECHA_EMISION_ORIGINAL,
    l.NOMBRES, l.OBSERVACIONES, l.CODIGO_LISTA, l.NOMBRE_LISTA,
    tcn.PUBLICAMENTE_EXPUESTA,
    FECHA_ALERTA_MES,
    p.FECHA_ALERTA

FROM 
    PolizasConFila p

# Unión con personas naturales y jurídicas
INNER JOIN (
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales
   
    UNION ALL
    
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos) tcn
    ON p.TIPO_DOCUMENTO_TOMADOR = tcn.TIPO_DOCUMENTO
    AND p.KEY_ID_TOMADOR = tcn.KEY_ID

INNER JOIN 
    `sb-ecosistemaanalitico-lago.seguros_bolivar.t_lista_restrictivas` l
    ON p.TIPO_DOCUMENTO_TOMADOR = l.TIPO_DOCUMENTO
    AND p.KEY_ID_TOMADOR = l.KEY_ID

WHERE 
    p.fila = 1                             # Solo la última póliza por tomador
    AND l.CODIGO_LISTA = '23'              # Lista restrictiva 23
    AND tcn.PUBLICAMENTE_EXPUESTA != 'S'   # Excluir PEPs
    AND p.FECHA_FIN_POLIZA > CURRENT_TIMESTAMP()
    AND p.CODIGO_COMPANIA = 2
    AND p.FECHA_INICIO_POLIZA >= "2025-01-01"  

ORDER BY 
    p.FECHA_CORTE DESC;                    # Más reciente primero


INSERT ----
# Crear o reemplazar tabla que consolida alertas por tomadores en lista restrictiva
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0311_VISOR_REPO AS

# ---------------------------
# CTE: PolizasConFila
# Se selecciona la última póliza vigente por tomador de lista 23
# ---------------------------
WITH PolizasConFila AS (
    SELECT 
        # Datos generales de la póliza
        p.CODIGO_COMPANIA, p.CODIGO_RAMO_EMISION, p.NOMBRE_RAMO_EMISION,
        p.CODIGO_PRODUCTO, p.NOMBRE_PRODUCTO, p.CLAVE_AGENTE,
        p.CODIGO_LOCALIDAD, p.NOMBRE_LOCALIDAD, p.CODIGO_CANAL, p.NOMBRE_CANAL,
        p.NUMERO_POLIZA, p.NUMERO_POLIZA_MADRE, p.TIPO_DOCUMENTO_TOMADOR,
        p.KEY_ID_TOMADOR, p.FECHA_INICIO_POLIZA, p.FECHA_FIN_POLIZA,
        p.FECHA_CORTE, p.FECHA_EMISION_ENDOSO, p.FECHA_EMISION_ORIGINAL,

        # Datos de lista restrictiva
        l.NOMBRES, l.OBSERVACIONES, l.CODIGO_LISTA, l.NOMBRE_LISTA,

        # Marca si es PEP
        tcn.PUBLICAMENTE_EXPUESTA,

        # Número de fila para seleccionar la más reciente por tomador
        ROW_NUMBER() OVER (
            PARTITION BY CAST(p.KEY_ID_TOMADOR AS STRING), CAST(p.TIPO_DOCUMENTO_TOMADOR AS STRING)
            ORDER BY p.FECHA_EMISION_ENDOSO DESC
        ) AS fila,

        # Metadatos de fecha
        FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES, 
        CURRENT_DATE() AS FECHA_ALERTA

    FROM 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas` p
    
    INNER JOIN 
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_lista_restrictivas` l
        ON p.TIPO_DOCUMENTO_TOMADOR = l.TIPO_DOCUMENTO
        AND p.KEY_ID_TOMADOR = l.KEY_ID
        AND l.CODIGO_LISTA = '23'
    
    INNER JOIN (
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales
    
    UNION ALL
    
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos) tcn
        ON p.TIPO_DOCUMENTO_TOMADOR = tcn.TIPO_DOCUMENTO
        AND p.KEY_ID_TOMADOR = tcn.KEY_ID
    
    WHERE 
        p.FECHA_FIN_POLIZA > CURRENT_TIMESTAMP()   # Vigentes
        AND p.CODIGO_COMPANIA = 2                  # Solo compañía 2
        AND p.FECHA_INICIO_POLIZA >= "2025-01-01" 
        AND tcn.PUBLICAMENTE_EXPUESTA != 'S'     # Clientes recientes
)

# ---------------------------
# Selección final para la tabla
# Incluye unión de personas naturales y jurídicas para validar PEPs
# ---------------------------
SELECT 
    p.CODIGO_COMPANIA, p.CODIGO_RAMO_EMISION, p.NOMBRE_RAMO_EMISION,
    p.CODIGO_PRODUCTO, p.NOMBRE_PRODUCTO, p.CLAVE_AGENTE,
    p.CODIGO_LOCALIDAD, p.NOMBRE_LOCALIDAD, p.CODIGO_CANAL, p.NOMBRE_CANAL,
    p.NUMERO_POLIZA, p.NUMERO_POLIZA_MADRE, p.TIPO_DOCUMENTO_TOMADOR,
    p.KEY_ID_TOMADOR, p.FECHA_INICIO_POLIZA, p.FECHA_FIN_POLIZA,
    p.FECHA_CORTE, p.FECHA_EMISION_ENDOSO, p.FECHA_EMISION_ORIGINAL,
    l.NOMBRES, l.OBSERVACIONES, l.CODIGO_LISTA, l.NOMBRE_LISTA,
    tcn.PUBLICAMENTE_EXPUESTA,
    FECHA_ALERTA_MES,
    p.FECHA_ALERTA

FROM 
    PolizasConFila p

# Unión con personas naturales y jurídicas
INNER JOIN (
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales
   
    UNION ALL
    
    SELECT KEY_ID, TIPO_DOCUMENTO, PUBLICAMENTE_EXPUESTA
    FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos) tcn
    ON p.TIPO_DOCUMENTO_TOMADOR = tcn.TIPO_DOCUMENTO
    AND p.KEY_ID_TOMADOR = tcn.KEY_ID

INNER JOIN 
    `sb-ecosistemaanalitico-lago.seguros_bolivar.t_lista_restrictivas` l
    ON p.TIPO_DOCUMENTO_TOMADOR = l.TIPO_DOCUMENTO
    AND p.KEY_ID_TOMADOR = l.KEY_ID

WHERE 
    p.fila = 1                             # Solo la última póliza por tomador
    AND l.CODIGO_LISTA = '23'              # Lista restrictiva 23
    AND tcn.PUBLICAMENTE_EXPUESTA != 'S'   # Excluir PEPs
    AND p.FECHA_FIN_POLIZA > CURRENT_TIMESTAMP()
    AND p.CODIGO_COMPANIA = 2
    AND p.FECHA_INICIO_POLIZA >= "2025-01-01"  

ORDER BY 
    p.FECHA_CORTE DESC;                    # Más reciente primero
