
-- Crear o reemplazar la tabla SEG_0070_VISOR_REPO con la fecha de alerta
CREATE OR REPLACE TABLE sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0070_VISOR_REPO AS
WITH CTE AS (
    SELECT distinct
        a.CODIGO_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.CODIGO_LOCALIDAD,
        a.CLAVE_AGENTE,
        a.NUMERO_POLIZA,
        a.NUMERO_POLIZA_ANTERIOR,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.ESTADO_NEGOCIO,
        a.FORMA_COBRO,
        a.CANAL_DESCUENTO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.NOMBRE_TOMADOR,
        a.CODIGO_ACTIVIDAD_ECONOMICA_TOMADOR,
        c.PUBLICAMENTE_EXPUESTA,
        a.VALOR_AHORRO_EXTRA,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR,a.TIPO_DOCUMENTO_TOMADOR,a.VALOR_RECAUDO_MES ORDER BY a.FECHA_RECAUDO DESC) AS rn
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-sandbox-usuarios.sandbox_cumplimiento.t_terceros_clientes` b
    ON 
        a.TIPO_DOCUMENTO_TOMADOR = b.TIPO_DOCUMENTO
        AND a.NUMERO_DOCUMENTO_TOMADOR = b.NUMERO_DOCUMENTO
    LEFT JOIN
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales` c
    ON 
        b.TIPO_DOCUMENTO = c.TIPO_DOCUMENTO
        AND b.KEY_ID = c.KEY_ID
    WHERE 
        ABS(a.VALOR_AHORRO_EXTRA) > 653223       
        AND a.FECHA_VIGENCIA_POLIZA >= "2024-01-01"
        AND a.FECHA_RECAUDO >= "2024-01-01"        
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        AND a.TIPO_REGISTRO = 'RECAUDO'
        AND c.PUBLICAMENTE_EXPUESTA = 'S'
)
SELECT distinct
    CODIGO_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    CODIGO_LOCALIDAD,
    CLAVE_AGENTE,
    NUMERO_POLIZA,
    NUMERO_POLIZA_ANTERIOR,
    FECHA_EMISION_POLIZA,
    FECHA_VIGENCIA_POLIZA,
    FECHA_VENCIMIENTO_POLIZA,
    FECHA_CANCELACION_POLIZA,
    FECHA_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    ESTADO_NEGOCIO,
    FORMA_COBRO,
    CANAL_DESCUENTO,
    TIPO_DOCUMENTO_TOMADOR,
    NUMERO_DOCUMENTO_TOMADOR,
    NOMBRE_TOMADOR,
    CODIGO_ACTIVIDAD_ECONOMICA_TOMADOR,
    PUBLICAMENTE_EXPUESTA,
    VALOR_AHORRO_EXTRA,
     FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA  -- Agregar la fecha de alerta
FROM 
    CTE
WHERE 
    rn = 1;



INSERT ---
-- Insertar solo registros nuevos en la tabla SEG_0070_VISOR_REPO
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0070_VISOR_REPO
WITH CTE AS (
    SELECT distinct
        a.CODIGO_COMPANIA,
        a.CODIGO_RAMO_EMISION,
        a.NOMBRE_RAMO_EMISION,
        a.CODIGO_PRODUCTO,
        a.NOMBRE_PRODUCTO,
        a.CODIGO_LOCALIDAD,
        a.CLAVE_AGENTE,
        a.NUMERO_POLIZA,
        a.NUMERO_POLIZA_ANTERIOR,
        a.FECHA_EMISION_POLIZA,
        a.FECHA_VIGENCIA_POLIZA,
        a.FECHA_VENCIMIENTO_POLIZA,
        a.FECHA_CANCELACION_POLIZA,
        a.FECHA_VIGENCIA_ENDOSO,
        a.FECHA_VENCIMIENTO_ENDOSO,
        a.ESTADO_NEGOCIO,
        a.FORMA_COBRO,
        a.CANAL_DESCUENTO,
        a.TIPO_DOCUMENTO_TOMADOR,
        a.NUMERO_DOCUMENTO_TOMADOR,
        a.NOMBRE_TOMADOR,
        a.CODIGO_ACTIVIDAD_ECONOMICA_TOMADOR,
        c.PUBLICAMENTE_EXPUESTA,
        a.VALOR_AHORRO_EXTRA,
        ROW_NUMBER() OVER (PARTITION BY a.NUMERO_DOCUMENTO_TOMADOR,a.TIPO_DOCUMENTO_TOMADOR,a.VALOR_RECAUDO_MES ORDER BY a.FECHA_RECAUDO DESC) AS rn
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_produccion_recaudo_diario` a
    LEFT JOIN 
        `sb-sandbox-usuarios.sandbox_cumplimiento.t_terceros_clientes` b
    ON 
        a.TIPO_DOCUMENTO_TOMADOR = b.TIPO_DOCUMENTO
        AND a.NUMERO_DOCUMENTO_TOMADOR = b.NUMERO_DOCUMENTO
    LEFT JOIN
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales` c
    ON 
        b.TIPO_DOCUMENTO = c.TIPO_DOCUMENTO
        AND b.KEY_ID = c.KEY_ID
    WHERE 
        ABS(a.VALOR_AHORRO_EXTRA) > 653223     
        AND a.FECHA_VIGENCIA_POLIZA >= "2024-01-01"
        AND a.FECHA_RECAUDO >= "2024-01-01"        
        AND a.CODIGO_RAMO_EMISION IN (46,47,48,49)
        AND a.TIPO_REGISTRO = 'RECAUDO'
        AND c.PUBLICAMENTE_EXPUESTA = 'S'
)
SELECT distinct
    CODIGO_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    CODIGO_LOCALIDAD,
    CLAVE_AGENTE,
    NUMERO_POLIZA,
    NUMERO_POLIZA_ANTERIOR,
    FECHA_EMISION_POLIZA,
    FECHA_VIGENCIA_POLIZA,
    FECHA_VENCIMIENTO_POLIZA,
    FECHA_CANCELACION_POLIZA,
    FECHA_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    ESTADO_NEGOCIO,
    FORMA_COBRO,
    CANAL_DESCUENTO,
    TIPO_DOCUMENTO_TOMADOR,
    NUMERO_DOCUMENTO_TOMADOR,
    NOMBRE_TOMADOR,
    CODIGO_ACTIVIDAD_ECONOMICA_TOMADOR,
    PUBLICAMENTE_EXPUESTA,
    VALOR_AHORRO_EXTRA,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA  -- Agregar la fecha de alerta
FROM 
    CTE
WHERE 
    rn = 1
    AND NOT EXISTS (
        SELECT 1
        FROM sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0070_VISOR_REPO existing
        WHERE existing.NUMERO_DOCUMENTO_TOMADOR = CTE.NUMERO_DOCUMENTO_TOMADOR
          AND existing.NUMERO_POLIZA = CTE.NUMERO_POLIZA
    );

