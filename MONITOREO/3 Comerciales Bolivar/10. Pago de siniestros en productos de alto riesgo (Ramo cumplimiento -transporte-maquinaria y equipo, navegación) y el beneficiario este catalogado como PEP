WITH registros_ordenados AS (
    SELECT 
        s.CODIGO_COMPANIA,
        s.CODIGO_RAMO_CONTABLE,
        s.NOMBRE_RAMO_CONTABLE,
        s.CODIGO_PRODUCTO,
        s.NOMBRE_PRODUCTO,
        s.NUMERO_POLIZA,
        s.TIPO_DOCUMENTO_TOMADOR,
        s.KEY_ID_TOMADOR,
        s.TIPO_DOCUMENTO_ASEGURADO,
        s.KEY_ID_ASEGURADO,
        s.KEY_ID_BENEFICIARIO,
        s.FECHA_SUSCRIPCION,
        s.FECHA_SINIESTRO,
        s.FECHA_AVISO,
        s.FECHA_EQUIPO,
        s.FECHA_MOVIMIENTO,
        s.LIQUIDADO_BOLIVAR,
        s.ESTADO_SINIESTRO,
        s.ESTADO_RESERVA,
        s.DESCRIPCION_SINIESTRO,
        s.CODIGO_CAUSA_OBJECION,
        s.DESCRIPCION_CAUSA_OBJECION,
        s.CODIGO_GESTOR,
        s.CODIGO_CANAL,
        s.FECHA_ORDEN_PAGO,
        s.FECHA_PROCESO,
        t.CODIGO_RESTRICCION,
        t.DESCRIPCION,
        ROW_NUMBER() OVER (PARTITION BY s.KEY_ID_TOMADOR ORDER BY s.FECHA_ORDEN_PAGO DESC) AS fila
    FROM
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros` s
    JOIN
        `sb-ecosistemaanalitico-lago.seguros_bolivar.t_terceros_restringidos` t
        ON s.TIPO_DOCUMENTO_TOMADOR = t.TIPO_DOCUMENTO_TERCERO
        AND s.KEY_ID_TOMADOR = t.KEY_ID
    WHERE 
        t.CODIGO_RESTRICCION = 23 
        AND s.CODIGO_RAMO_CONTABLE IN (4, 8, 15, 9) 
        AND s.LIQUIDADO_BOLIVAR > 0 
        AND s.FECHA_ORDEN_PAGO >= '2024-01-01'
)
SELECT 
    CODIGO_COMPANIA,
    CODIGO_RAMO_CONTABLE,
    NOMBRE_RAMO_CONTABLE,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    TIPO_DOCUMENTO_ASEGURADO,
    KEY_ID_ASEGURADO,
    KEY_ID_BENEFICIARIO,
    FECHA_SUSCRIPCION,
    FECHA_SINIESTRO,
    FECHA_AVISO,
    FECHA_EQUIPO,
    FECHA_MOVIMIENTO,
    LIQUIDADO_BOLIVAR,
    ESTADO_SINIESTRO,
    ESTADO_RESERVA,
    DESCRIPCION_SINIESTRO,
    CODIGO_CAUSA_OBJECION,
    DESCRIPCION_CAUSA_OBJECION,
    CODIGO_GESTOR,
    CODIGO_CANAL,
    FECHA_ORDEN_PAGO,
    FECHA_PROCESO,
    CODIGO_RESTRICCION,
    DESCRIPCION
FROM 
    registros_ordenados
WHERE 
    fila = 1
ORDER BY 
    FECHA_ORDEN_PAGO DESC;
