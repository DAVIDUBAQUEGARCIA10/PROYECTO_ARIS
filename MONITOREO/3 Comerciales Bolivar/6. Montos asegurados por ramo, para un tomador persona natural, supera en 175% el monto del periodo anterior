SELECT 
    t1.CODIGO_COMPANIA,
    t1.CODIGO_RAMO_EMISION,
    t1.NOMBRE_RAMO_EMISION,
    t1.CODIGO_PRODUCTO,
    t1.NOMBRE_PRODUCTO,
    t1.CODIGO_SUBPRODUCTO,
    t1.NOMBRE_SUBPRODUCTO,
    t1.NUMERO_POLIZA_ANTERIOR,
    t1.NUMERO_POLIZA,
    t1.TIPO_DOCUMENTO_TOMADOR,
    t1.KEY_ID_TOMADOR,
    t1.TIPO_DOCUMENTO_ASEGURADO,
    t1.KEY_ID_ASEGURADO,
    t1.FECHA_FIN_ENDOSO,  -- Si ya es DATE, no es necesario el CAST
    t1.FECHA_FIN_POLIZA,  -- Igual para esta columna
    t1.VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA,
    t1.COD_MOTIVO_CANCELACION_POLIZA,
    t1.DES_MOTIVO_CANCELACION_POLIZA,
    t2.VALOR_ASEGURADO AS VALOR_ASEGURADO_POLIZA_ANTERIOR,
    t2.NUMERO_POLIZA_ANTERIOR AS NUMERO_POLIZA_ANTERIOR
FROM 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t1
INNER JOIN 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t2
    ON t1.NUMERO_POLIZA_ANTERIOR = t2.NUMERO_POLIZA
WHERE 
    t1.NUMERO_POLIZA_ANTERIOR IS NOT NULL  -- Filtra registros que no tengan NUMERO_POLIZA_ANTERIOR
    AND t1.VALOR_ASEGURADO > 1.75 * t2.VALOR_ASEGURADO
    AND t1.CODIGO_COMPANIA = 3
    AND DATE(t1.FECHA_FIN_ENDOSO) > CURRENT_DATE()  -- Convertir FECHA_FIN_ENDOSO a DATE
    AND DATE(t1.FECHA_FIN_POLIZA) > CURRENT_DATE()  -- Convertir FECHA_FIN_POLIZA a DATE
    AND EXISTS (
        SELECT 1
        FROM sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos t3
        WHERE t3.NUMERO_POLIZA = t1.NUMERO_POLIZA_ANTERIOR
    );
