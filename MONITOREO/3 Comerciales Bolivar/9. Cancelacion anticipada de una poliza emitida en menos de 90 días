WITH Filtrado AS (
    SELECT 
        p.CODIGO_COMPANIA,
        p.CODIGO_RAMO_EMISION,
        p.NOMBRE_RAMO_EMISION,
        p.CODIGO_PRODUCTO,
        p.NOMBRE_PRODUCTO,
        p.NOMBRE_CANAL,
        p.NUMERO_POLIZA_ANTERIOR,
        p.NUMERO_POLIZA,
        p.NUMERO_POLIZA_SIGUIENTE,
        p.TIPO_DOCUMENTO_TOMADOR,
        p.KEY_ID_TOMADOR,
        p.TIPO_DOCUMENTO_ASEGURADO,
        p.KEY_ID_ASEGURADO,
        CAST(p.FECHA_EMISION_ENDOSO AS DATE) AS FECHA_EMISION_ENDOSO,
        CAST(p.FECHA_INICIO_ENDOSO AS DATE) AS FECHA_INICIO_ENDOSO,
        CAST(p.FECHA_FIN_ENDOSO AS DATE) AS FECHA_FIN_ENDOSO,
        CAST(p.FECHA_INICIO_POLIZA AS DATE) AS FECHA_INICIO_POLIZA,
        CAST(p.FECHA_FIN_POLIZA AS DATE) AS FECHA_FIN_POLIZA,
        p.COD_MOTIVO_CANCELACION_POLIZA,
        p.DES_MOTIVO_CANCELACION_POLIZA,
        CAST(p.FECHA_PROCESO AS DATE) AS FECHA_PROCESO,

        -- Calcular la diferencia en días entre FECHA_INICIO_POLIZA y FECHA_PROCESO usando DATE_DIFF con 'DAY'
        DATE_DIFF(CAST(p.FECHA_PROCESO AS DATE), CAST(p.FECHA_INICIO_POLIZA AS DATE), DAY) AS DIAS_DESDE_INICIO_POLIZA,

        -- Filtrar solo aquellos registros donde la diferencia no supere los 90 días
        CASE 
            WHEN DATE_DIFF(CAST(p.FECHA_PROCESO AS DATE), CAST(p.FECHA_INICIO_POLIZA AS DATE), DAY) <= 90 THEN 'Dentro de 90 días'
            ELSE 'Fuera de 90 días'
        END AS ESTATUS_90_DIAS,

        -- Calcular la diferencia entre FECHA_PROCESO y FECHA_FIN_POLIZA usando DATE_DIFF con 'DAY'
        DATE_DIFF(CAST(p.FECHA_PROCESO AS DATE), CAST(p.FECHA_FIN_POLIZA AS DATE), DAY) AS DIFERENCIA_FECHA_PROCESO_FIN_POLIZA,

        ROW_NUMBER() OVER (PARTITION BY p.KEY_ID_TOMADOR ORDER BY p.FECHA_PROCESO DESC) AS rn  -- Asignamos un número de fila para cada KEY_ID_TOMADOR
    FROM 
        sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos p
    WHERE 
        p.FECHA_EMISION_ENDOSO > '2024-01-01' 
        AND p.FECHA_INICIO_ENDOSO > '2024-01-01'
        AND p.FECHA_INICIO_POLIZA > '2024-01-01'
        AND p.COD_MOTIVO_CANCELACION_POLIZA IS NOT NULL 
        AND p.KEY_ID_TOMADOR NOT IN ('860034313', '830053700')
        AND p.DES_MOTIVO_CANCELACION_POLIZA NOT IN (
            'TERMINACION DEL CONTRATO',
            'POR BAJAS COBERTURAS',
            'CANCELACION POR PENSION DE ASEGURADO',
            'DAVIVIENDA CREDITO EN MORA',
            'FONDOS INSUFICIENTES (CONVENIO)',
            'CUENTA CANCELADA CONVENIO',
            'CAMBIO DE VEHICULO',
            'INCLUSION ASEGURADO COLECTIVA SALUD X GRUPO FAMILIAR',
            'CANCELACION DE CREDITO DAVIVIENDA',
            'DAVIVIENDA TERMINACION DE CREDITO',
            'POR TRASLADO DE ADMINISTRADORA DE RIESGOS PROFESIONALES',
            'ANULACION SOAT',
            'CHATARRIZACION VEHICULO',
            'POR PRIMAS O FACTURAS PENDIENTES DE PAGO',
            'NEGOCIACION'
        )
        -- Filtrar registros donde la diferencia de días desde la FECHA_INICIO_POLIZA no supere los 90 días
        AND DATE_DIFF(CAST(p.FECHA_PROCESO AS DATE), CAST(p.FECHA_INICIO_POLIZA AS DATE), DAY) <= 90 
        AND DATE_DIFF(CAST(p.FECHA_PROCESO AS DATE), CAST(p.FECHA_INICIO_POLIZA AS DATE), DAY) >= 0 
        AND p.CODIGO_COMPANIA = 3
)
SELECT 
    CODIGO_COMPANIA,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    NOMBRE_CANAL,
    NUMERO_POLIZA_ANTERIOR,
    NUMERO_POLIZA,
    NUMERO_POLIZA_SIGUIENTE,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    TIPO_DOCUMENTO_ASEGURADO,
    KEY_ID_ASEGURADO,
    FECHA_EMISION_ENDOSO,
    FECHA_INICIO_ENDOSO,
    FECHA_FIN_ENDOSO,
    FECHA_INICIO_POLIZA,
    FECHA_FIN_POLIZA,
    COD_MOTIVO_CANCELACION_POLIZA,
    DES_MOTIVO_CANCELACION_POLIZA,
    FECHA_PROCESO,
    DIAS_DESDE_INICIO_POLIZA,
    ESTATUS_90_DIAS,
    DIFERENCIA_FECHA_PROCESO_FIN_POLIZA
FROM Filtrado
WHERE rn = 1 AND CODIGO_RAMO_EMISION NOT IN (1,37,23,5,15);  -- Seleccionamos solo las primeras filas para cada KEY_ID_TOMADOR, eliminando duplicados
