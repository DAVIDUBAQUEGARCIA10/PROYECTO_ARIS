--create or replace table sb-sandbox-usuarios.sandbox_cumplimiento.COM_0067_VISOR_REPO AS
create or replace table sb-sandbox-usuarios.sandbox_cumplimiento.COM_0067_VISOR_REPO AS
WITH RankedData AS (
    SELECT distinct
        FECHA_EMISION_ENDOSO_CANCELACION,
        FECHA_INICIO_VIGENCIA_ENDOSO,
        FECHA_VENCIMIENTO_ENDOSO,
        FECHA_INICIO_VIGENCIA_POLIZA,
        FECHA_FIN_VIGENCIA_POLIZA,
        FECHA_ANULACION_POLIZA,
        CODIGO_COMPANIA,
        CODIGO_LOCALIDAD,
        CODIGO_RAMO_EMISION,
        CODIGO_PRODUCTO,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        DOCUMENTO_TOMADOR,
        NUMERO_ENDOSO,
        CODIGO_ENDOSO,
        SUB_CODIGO_ENDOSO,
        FECHA_CANCELACION_DEF,
        DESCRIPCION_ENDOSO,
        RANK() OVER (PARTITION BY DOCUMENTO_TOMADOR,TIPO_DOCUMENTO_TOMADOR,NUMERO_POLIZA ORDER BY FECHA_EMISION_ENDOSO_CANCELACION) AS rank
    FROM 
        `sb-ecosistemaanalitico-lago.datamart.t_cancelaciones`
    WHERE
        DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_POLIZA), DAY) <= 90
        AND DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_POLIZA), DAY) >= 3
        AND RIGHT(CAST(NUMERO_POLIZA AS STRING), 2) = '01'
        AND FECHA_INICIO_VIGENCIA_POLIZA >= "2025-01-01"
        AND FECHA_INICIO_VIGENCIA_ENDOSO >= "2025-01-01"
        AND DOCUMENTO_TOMADOR NOT IN (860034313, 830053700)
        AND MARCA_CANCELACION_DEFINITIVA = "S"
        AND CODIGO_COMPANIA = '3'
        AND CODIGO_RAMO_EMISION NOT IN (33, 34,23,21)
        AND FORMA_COBRO NOT IN ('DB', 'DB')
        AND ALTURA_POLIZA IN ('01', '01')
        AND AGRUPACION_DESCRIPCION_ENDOSO_CANCELACION != 'CANCELACION MUERTE'
        AND DESCRIPCION_ENDOSO IN (
    'CANCELACION POLIZA (SOAT)',
    'ANULACION O CANCELACION DE POLIZA',
    'CANCELACION POLIZA SIN TRABAJADORES',
    'CANCELACION POR TRASLADO',
    'EXCLUSION DE RIESGOS',
    'ANULACION TOTAL CON DEVOLUCION INDEMIZACIONES',
    'ANULACION CON DEVOLUCION PRIMA X CONVERSION SIN AHORRO',
    'REHABILITACION POLIZAS DESAFILIADAS A.R.P',
    'ANULACION',
    'ANULACION TOTAL',
    'PROTECCION FAMILIAR     ANULACION',
    'CANCELACION POLIZA',
    'ANULACION TOTAL EN LINEA',
    'ANULACION DE POLIZAS',
    'ANULACION POLIZA CON DEVOLUCION PRIMA',
    'CANCELACION POR MULTIAFILIACION',
    'ANULACION POLIZA SIN DEVOLUCION PRIMA',
    'INCLUSION DE RIESGOS',
    'EXCLUSION DE RIEGOS',
    'CANCELACION DE POLIZA POR FUSION',
    'ANULACION CON DEVOLUCION X MUERTE',
    'ACTUALIZACION TIPO DE ENVIO',
    'ANULACION POR CLAUSULA DE GARANTIA',
    'CANCELACION DE POLIZA POR LIQUIDACION DE LA EMPRESA',
    'CANCELACION DE POLIZA POR DECISION DEL ASEGURADO',
    'ANULACION MASIVA',
    'ANULACION POLIZA',
    'EMISION',
    'CASTIGO DE CARTERA',
    'ANULACION SIN DEVOLUCION X INVALIDEZ',
    'ANULACION SIN DEVOLUCION INDEMNIZACION',
    'CAMBIO DATOS BASICOS',
    'ANULACION SIN DEVOLUCION  DE PRIMA',
    'ENDOSO GENERAL',
    'A DATOS GENERALES-NO CAUSA PRIMA-',
    'ANULACION DE POLIZA',
    'ANULACION TOTAL POLIZA',
    'AMPARO  DE  EXPLOSION',
    'ANULACION POR MUERTE',
    'PROTECCION FAMILIAR     CAMBIOS EN VALORES ASEGURADOS',
    'EXCLUSION DE RIESGOS WEB',
    'ANULACION CON DEVOLUCION DE PRIMA SIN AHORRO',
    'INCLUSION DE VEHICULOS',
    'ANULACION TOTAL POR ERROR EN LA DIGITACION',
    'ANULACION CON DEVOLUCION PRIMA POR CONVERSION',
    'ANULACION POR CANCELACION FINANSEGURO',
    'ANULACION CON DEVOLUCION DE PRIMA',
    'CANCELACION VOLUNTARIA',
    'ANULACION SIN DEVOLUCION X MUERTE',
    'POLIZA SEGUROS FAMILIAR  CANCELACION TOTAL',
    'CANCELACION POR NO CUMPLIMIENTO DE LOS REQUISITOS',
    'CERTIFICADO DE CANCELACION POLIZA'
  )
  --OR DESCRIPCION_ENDOSO IS NULL
  --OR TRIM(DESCRIPCION_ENDOSO) = ''
  )
SELECT
    FECHA_EMISION_ENDOSO_CANCELACION,
    FECHA_INICIO_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    FECHA_INICIO_VIGENCIA_POLIZA,
    FECHA_FIN_VIGENCIA_POLIZA,
    FECHA_ANULACION_POLIZA,
    CODIGO_COMPANIA,
    CODIGO_LOCALIDAD,
    CODIGO_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    DOCUMENTO_TOMADOR,
    NUMERO_ENDOSO,
    CODIGO_ENDOSO,
    SUB_CODIGO_ENDOSO,
    FECHA_CANCELACION_DEF,
    DESCRIPCION_ENDOSO,
    FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
    CURRENT_DATE() AS FECHA_ALERTA
FROM RankedData
WHERE rank = 1;




INSERT ----
-- Insertar solo registros nuevos en la tabla COM_0067_VISOR_REPO (cancelaciones recientes)
INSERT INTO sb-sandbox-usuarios.sandbox_cumplimiento.COM_0067_VISOR_REPO (
    FECHA_EMISION_ENDOSO_CANCELACION,
    FECHA_INICIO_VIGENCIA_ENDOSO,
    FECHA_VENCIMIENTO_ENDOSO,
    FECHA_INICIO_VIGENCIA_POLIZA,
    FECHA_FIN_VIGENCIA_POLIZA,
    FECHA_ANULACION_POLIZA,
    CODIGO_COMPANIA,
    CODIGO_LOCALIDAD,
    CODIGO_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    DOCUMENTO_TOMADOR,
    NUMERO_ENDOSO,
    CODIGO_ENDOSO,
    SUB_CODIGO_ENDOSO,
    FECHA_CANCELACION_DEF,
    DESCRIPCION_ENDOSO,
    FECHA_ALERTA_MES,
    FECHA_ALERTA
)

-- -------------------------------
-- CTE: RankedData
-- Selecciona cancelaciones válidas (no muerte) dentro de los primeros 90 días de la póliza
-- -------------------------------
WITH RankedData AS (
    SELECT
        FECHA_EMISION_ENDOSO_CANCELACION,
        FECHA_INICIO_VIGENCIA_ENDOSO,
        FECHA_VENCIMIENTO_ENDOSO,
        FECHA_INICIO_VIGENCIA_POLIZA,
        FECHA_FIN_VIGENCIA_POLIZA,
        FECHA_ANULACION_POLIZA,
        CODIGO_COMPANIA,
        CODIGO_LOCALIDAD,
        CODIGO_RAMO_EMISION,
        CODIGO_PRODUCTO,
        NUMERO_POLIZA,
        TIPO_DOCUMENTO_TOMADOR,
        DOCUMENTO_TOMADOR,
        NUMERO_ENDOSO,
        CODIGO_ENDOSO,
        SUB_CODIGO_ENDOSO,
        FECHA_CANCELACION_DEF,
        DESCRIPCION_ENDOSO,
        FORMAT_DATE('%Y-%m', CURRENT_DATE()) AS FECHA_ALERTA_MES,
        CURRENT_DATE() AS FECHA_ALERTA,

        -- Número de fila para conservar solo un registro por póliza/tomador
        RANK() OVER (
            PARTITION BY DOCUMENTO_TOMADOR, TIPO_DOCUMENTO_TOMADOR, NUMERO_POLIZA
            ORDER BY FECHA_EMISION_ENDOSO_CANCELACION
        ) AS rank

    FROM `sb-ecosistemaanalitico-lago.datamart.t_cancelaciones`

    WHERE
        -- Rango de días entre inicio y cancelación: mínimo 3 días, máximo 90
        DATE_DIFF(DATE(FECHA_CANCELACION_DEF), DATE(FECHA_INICIO_VIGENCIA_POLIZA), DAY) BETWEEN 3 AND 90

        -- Solo finalizaciones con sufijo 01 (renovación o nueva emisión)
        AND RIGHT(CAST(NUMERO_POLIZA AS STRING), 2) = '01'

        -- Pólizas emitidas desde 2025
        AND FECHA_INICIO_VIGENCIA_POLIZA >= "2025-01-01"
        AND FECHA_INICIO_VIGENCIA_ENDOSO >= "2025-01-01"

        -- Se excluyen ciertos clientes
        AND DOCUMENTO_TOMADOR NOT IN (860034313, 830053700)

        -- Solo cancelaciones definitivas
        AND MARCA_CANCELACION_DEFINITIVA = "S"

        -- Solo compañía específica
        AND CODIGO_COMPANIA = '3'

        -- Se excluyen ciertos ramos
        AND CODIGO_RAMO_EMISION NOT IN (33, 34, 23, 21)

        -- Se excluyen cobros por débito automático
        AND FORMA_COBRO NOT IN ('DB', 'DB')

        -- Solo primera capa
        AND ALTURA_POLIZA IN ('01', '01')

        -- Se excluye cancelación por muerte
        AND AGRUPACION_DESCRIPCION_ENDOSO_CANCELACION != 'CANCELACION MUERTE'

        -- Se filtra por tipos de cancelación relevantes (evita anulaciones administrativas o neutras)
        AND DESCRIPCION_ENDOSO IN (
            'CANCELACION POLIZA (SOAT)',
            'ANULACION O CANCELACION DE POLIZA',
            'CANCELACION POLIZA SIN TRABAJADORES',
            'CANCELACION POR TRASLADO',
            'EXCLUSION DE RIESGOS',
            'ANULACION TOTAL CON DEVOLUCION INDEMIZACIONES',
            'ANULACION CON DEVOLUCION PRIMA X CONVERSION SIN AHORRO',
            'REHABILITACION POLIZAS DESAFILIADAS A.R.P',
            'ANULACION',
            'ANULACION TOTAL',
            'PROTECCION FAMILIAR     ANULACION',
            'CANCELACION POLIZA',
            'ANULACION TOTAL EN LINEA',
            'ANULACION DE POLIZAS',
            'ANULACION POLIZA CON DEVOLUCION PRIMA',
            'CANCELACION POR MULTIAFILIACION',
            'ANULACION POLIZA SIN DEVOLUCION PRIMA',
            'INCLUSION DE RIESGOS',
            'EXCLUSION DE RIEGOS',
            'CANCELACION DE POLIZA POR FUSION',
            'ANULACION CON DEVOLUCION X MUERTE',
            'ACTUALIZACION TIPO DE ENVIO',
            'ANULACION POR CLAUSULA DE GARANTIA',
            'CANCELACION DE POLIZA POR LIQUIDACION DE LA EMPRESA',
            'CANCELACION DE POLIZA POR DECISION DEL ASEGURADO',
            'ANULACION MASIVA',
            'ANULACION POLIZA',
            'EMISION',
            'CASTIGO DE CARTERA',
            'ANULACION SIN DEVOLUCION X INVALIDEZ',
            'ANULACION SIN DEVOLUCION INDEMNIZACION',
            'CAMBIO DATOS BASICOS',
            'ANULACION SIN DEVOLUCION  DE PRIMA',
            'ENDOSO GENERAL',
            'A DATOS GENERALES-NO CAUSA PRIMA-',
            'ANULACION DE POLIZA',
            'ANULACION TOTAL POLIZA',
            'AMPARO  DE  EXPLOSION',
            'ANULACION POR MUERTE',
            'PROTECCION FAMILIAR     CAMBIOS EN VALORES ASEGURADOS',
            'EXCLUSION DE RIESGOS WEB',
            'ANULACION CON DEVOLUCION DE PRIMA SIN AHORRO',
            'INCLUSION DE VEHICULOS',
            'ANULACION TOTAL POR ERROR EN LA DIGITACION',
            'ANULACION CON DEVOLUCION PRIMA POR CONVERSION',
            'ANULACION POR CANCELACION FINANSEGURO',
            'ANULACION CON DEVOLUCION DE PRIMA',
            'CANCELACION VOLUNTARIA',
            'ANULACION SIN DEVOLUCION X MUERTE',
            'POLIZA SEGUROS FAMILIAR  CANCELACION TOTAL',
            'CANCELACION POR NO CUMPLIMIENTO DE LOS REQUISITOS',
            'CERTIFICADO DE CANCELACION POLIZA'
        )
)

-- -------------------------------
-- Selección final: insertar solo si no existe ya en la tabla
-- -------------------------------
SELECT
    f.FECHA_EMISION_ENDOSO_CANCELACION,
    f.FECHA_INICIO_VIGENCIA_ENDOSO,
    f.FECHA_VENCIMIENTO_ENDOSO,
    f.FECHA_INICIO_VIGENCIA_POLIZA,
    f.FECHA_FIN_VIGENCIA_POLIZA,
    f.FECHA_ANULACION_POLIZA,
    f.CODIGO_COMPANIA,
    f.CODIGO_LOCALIDAD,
    f.CODIGO_RAMO_EMISION,
    f.CODIGO_PRODUCTO,
    f.NUMERO_POLIZA,
    f.TIPO_DOCUMENTO_TOMADOR,
    f.DOCUMENTO_TOMADOR,
    f.NUMERO_ENDOSO,
    f.CODIGO_ENDOSO,
    f.SUB_CODIGO_ENDOSO,
    f.FECHA_CANCELACION_DEF,
    f.DESCRIPCION_ENDOSO,
    f.FECHA_ALERTA_MES,
    f.FECHA_ALERTA
FROM RankedData f
LEFT JOIN sb-sandbox-usuarios.sandbox_cumplimiento.COM_0067_VISOR_REPO existing
    ON f.NUMERO_POLIZA = existing.NUMERO_POLIZA
    AND f.NUMERO_ENDOSO = existing.NUMERO_ENDOSO
    AND f.DOCUMENTO_TOMADOR = existing.DOCUMENTO_TOMADOR
WHERE f.rank = 1                          -- Solo el primer registro por combinación
  AND existing.NUMERO_POLIZA IS NULL     -- Verifica que no exista aún
  AND existing.NUMERO_ENDOSO IS NULL;
