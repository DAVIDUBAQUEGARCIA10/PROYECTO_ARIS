CREATE OR REPLACE TABLE sb-ecosistemaanalitico-lago.cumplimiento_normativo_prod.Resultado_Alertamiento_ARIS AS 
WITH bloque_estructura AS (
select distinct
c.TIPO_DOCUMENTO,
c.KEY_ID_BENEFICIARIO,
c.TITULO,
c.ALERTA,
c.DESCRIPCION_ALERTA,
c.COMPANIA,
c.FECHA_ALERTA_MES,
c.FECHA_ALERTA,

p.NUMERO_DOCUMENTO, 
c.FECHA_TRANSACCION,
c.VALOR_TRANSACCION,
c.FORMA_PAGO_CANAL,
c.CODIGO_RAMO,
c.CODIGO_PRODUCTO,

datos.FECHA_NACIMIENTO,
datos.NACIONALIDAD,
datos.FECHA_ACTUALIZACION,
datos.VALOR_INGRESOS,
datos.VALOR_EGRESOS,
datos.VALOR_ACTIVO,
datos.VALOR_PASIVO,
datos.CODIGO_CIIU,
datos.ACTIVIDAD_ECONOMICA,
datos.PUBLICAMENTE_EXPUESTA,
datos.VINCULO_PERSONA_RECONOCIDA,
datos.CODIGO_LUGAR_REGISTRO,
datos.NOMBRE_LUGAR_REGISTRO,
datos.CODIGO_LUGAR_NACIMIENTO,
datos.NOMBRE_LUGAR_NACIMIENTO,
datos.MANEJA_MONEDA_EXTRANJERA,
datos.OPERACIONES_INTERNACIONALES,
datos.CODIGO_CODAZZI_DIRECCION_1,
datos.MUNICIPIO_DIRECCION_1,
datos.COD_PROFESION,
list.CODIGO_RESTRICCION,
list.DESCRIPCION


from (

----------------------- CAPITALIZADORA BOLIVAR
SELECT DISTINCT
    TIPO_DOCUMENTO,
    KEY_ID_BENEFICIARIO,
    TITULO,
    'CAP_0304' AS ALERTA, 
    'Cliente este calificado como pep en listas consultables pero no registra marcación en terceros' AS DESCRIPCION_ALERTA , 
    1 AS COMPANIA,
    FECHA_ALERTA_MES,
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST(SALDO_PESOS AS STRING) AS VALOR_TRANSACCION,
     CAST('' AS STRING) AS FORMA_PAGO_CANAL,
     801 AS CODIGO_RAMO,
     51 AS CODIGO_PRODUCTO
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0304_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO,
    KEY_ID AS KEY_ID_TOMADOR,
    NUMERO_TITULO,
    'CAP_0069' AS ALERTA,
    'Pep realiza pago de cuotas en el titulo de capitalización por un valor  mayor  a  $1.000.000' AS DESCRIPCION_ALERTA,    
    1 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_TRANSACCION AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_TRANSACCION AS STRING) AS VALOR_TRANSACCION,
     CAST(DESCRIPCION_TIPO_MOVIMIENTO AS STRING) AS FORMA_PAGO_CANAL,
     801 AS CODIGO_RAMO,
     51 AS CODIGO_PRODUCTO     
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0069_VISOR_TRANS`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO as TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_TITULO,
    'CAP_0009' AS ALERTA,
    'Pagos de cuotas por valor estrictamente mayor al pactado inicialmente y en menos de 90 dias de aperturado el titulo.' AS DESCRIPCION_ALERTA ,     
    1 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION,     
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL ,
     801 AS CODIGO_RAMO,
     51 AS CODIGO_PRODUCTO
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.CAP_0009_VISOR_TRANS`


UNION ALL




----------------------- SEGUROS BOLIVAR



SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0311' AS ALERTA,
    'Cliente este calificado como pep en listas consultables pero no registra marcación en terceros' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(NOMBRE_LISTA AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO     
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0311_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA_ACTUAL,
    'SEG_0101' AS ALERTA,
    'Montos asegurados por ramo, para un tomador persona natural, supera en 175% el monto del periodo anterior' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_ASEGURADO_POLIZA_ANTERIOR AS STRING) AS VALOR_TRANSACCION, 
     CAST(CODIGO_COBERTURA AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0101_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO as TIPO_DOCUMENTO_TOMADOR,
    KEY_ID,
    NUMERO_POLIZA,
    'SEG_0103' AS ALERTA,
    'Persona Jurídica tiene un valor asegurado estrictamente mayor a $16,500,000 y su fecha de constitución es menor a dos años.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ACTUALIZACION AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_ASEGURADO AS STRING) AS VALOR_TRANSACCION,    
     CAST(VALOR_ASEGURADO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO             
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0103_VISOR_REPO`


UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO as TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0002' AS ALERTA,
    'Retiro del fondo de ahorro por un monto estrictamente mayor a $25.000.000 o 15.000 usd y la poliza aun no ha vencido ' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_RETIRO AS STRING) AS VALOR_TRANSACCION,  
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0002_VISOR_REPO`


UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(DOCUMENTO_TOMADOR AS STRING) AS KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0003' AS ALERTA,
    'Cancelacion anticipada de una poliza  emitida en menos de 90 días' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_CANCELACION_DEF AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(DESCRIPCION_ENDOSO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO             
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0003_VISOR_REPO`

UNION ALL
---------------------------
SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0004' AS ALERTA,
    'Tomador solicita cambiar de beneficiario 90 dias antes de la cancelacion del seguro' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_CANCELACION_DEF AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION,   
     CAST(DESCRIPCION_ENDOSO_B AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO         
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0004_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0005' AS ALERTA,
    'Cambio de beneficiaro y en menos de 90 dias se presenta el pago de siniestro.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,
     CAST(DESCRIPCION_ENDOSO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO           
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0005_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0007' AS ALERTA,
    'Pago de siniestro en un tiempo estrictamente menor a 3 meses de emitida la poliza.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,   
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO         
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0007_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0014' AS ALERTA,
    'Pago de siniestro a algun tercero diferente al tomador, beneficiario o relacionado en la poliza.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,  
     CAST(CODIGO_CANAL AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO            
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0014_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(KEY_ID_TOMADOR AS STRING) AS NUMERO_DOCUMENTO_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0061' AS ALERTA,
    'Reciben mas de 2 aportes extraordinarios en un periodo inferior a 90 dias de emitida la poliza al fondo de ahorro y el monto de la operación es superior a $500.000' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_EMISION_POLIZA AS DATE) AS FECHA_TRANSACCION,
     CAST(SUM_VALOR_AHORRO_EXTRA AS STRING) AS VALOR_TRANSACCION,  
     CAST(CANAL_DESCUENTO AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO         
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0061_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(KEY_ID_TOMADOR AS STRING) AS NUMERO_DOCUMENTO_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0062' AS ALERTA,
    'Pagos al fondo de ahorro por valor estrictamente mayor al pactado inicialmente.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_RECAUDO AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_RECAUDO_MES AS STRING) AS VALOR_TRANSACCION,   
     CAST(FORMA_COBRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO            
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0062_VISOR_REPO`    


    
UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(KEY_ID_TOMADOR AS STRING) AS NUMERO_DOCUMENTO_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0070' AS ALERTA,
    'Tomador cliente PEP realiza pagos por aportes extraordinarios a los seguros de vida con componente de ahorro por valor mayor a $653.223.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_RECAUDO AS DATE) AS FECHA_TRANSACCION,
     CAST(VALOR_AHORRO_EXTRA AS STRING) AS VALOR_TRANSACCION,     
     CAST(CANAL_DESCUENTO AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0070_VISOR_REPO`   

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(KEY_ID_TOMADOR AS STRING) AS NUMERO_DOCUMENTO_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0071' AS ALERTA,
    'Cliente PEP realiza el pago de la prima en más de dos seguros de vida con componente de ahorro.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION,  
     CAST(NUMERO_POLIZAS_PAGADAS AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               

FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0071_VISOR_REPO`  

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0101B' AS ALERTA,
    'Pago de siniestro a una persona natural,  por un valor  mayor a $50.000.000,   en  menos de 3 meses de emitida la poliza.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,  
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,   
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0101B_VISOR_REPO`  

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0102B' AS ALERTA,
    'Pago de siniestro a una persona juridica, por un valor mayor a $100.000.000, en  menos de 3 meses de emitida la poliza.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION, 
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,  
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO                
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0102B_VISOR_REPO`          




UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0103Z' AS ALERTA,
    'Cliente PN con mas de 3 Productos del mismo ramo activos.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,    
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0103Z_VISOR_REPO`          




UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0104' AS ALERTA,
    'Cliente PJ con mas de 5 Productos del mismo ramo activos.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,    
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0104_VISOR_REPO`          



UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0105' AS ALERTA,
    'Tomador se encuentra en una jurisdiccion de alto riesgo por transaccionalidad o residencia y su actividad economica es de alto riesgo.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,    
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(municipio_direccion_1 AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0105_VISOR_REPO`          


UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0106' AS ALERTA,
    'Terceros que hacen  pagos por caja a mas de 3 polizas.' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_RECAUDO AS DATE) AS FECHA_TRANSACCION,  
     CAST(VALOR_RECAUDO_MES AS STRING) AS VALOR_TRANSACCION, 
     CAST(FORMA_COBRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0106_VISOR_REPO`          

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'SEG_0107' AS ALERTA,
    'El pais de nacionalidad o residencia pertenece a una jurisdicción calificada como de alto riesgo .' AS DESCRIPCION_ALERTA ,     
    2 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(NACIONALIDAD AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.SEG_0107_VISOR_REPO`          




----------------------- COMERCIALES BOLIVAR

UNION ALL


SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0312' AS ALERTA,
    'Cliente este calificado como pep en listas consultables pero no registra marcación en terceros' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,    
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0312_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0106' AS ALERTA,
    'Producto de alto riesgo y el tomador  tiene nacionalidad o residencia a una Jurisdicción de alto riesgo.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,    
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(municipio_direccion_1 AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0106_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA_ACTUAL,
    'COM_0115' AS ALERTA,
    'Montos asegurados, para un tomador persona natural, supera en 175% el monto del periodo anterior' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_INICIO_POLIZA AS DATE) AS FECHA_TRANSACCION,       
     CAST(VALOR_ASEGURADO_POLIZA_ANTERIOR AS STRING) AS VALOR_TRANSACCION,
     CAST(CODIGO_COBERTURA AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0115_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO,
    KEY_ID as KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0116' AS ALERTA,
    'Persona Jurídica tiene un valor asegurado estrictamente mayor a $16,500,000 y su fecha de constitución es menor a dos años.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ACTUALIZACION AS DATE) AS FECHA_TRANSACCION, 
     CAST(VALOR_ASEGURADO AS STRING) AS VALOR_TRANSACCION,  
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               

FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0116_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0050' AS ALERTA,
    'Ramo 14 (Equipo y Maquinaria de contratistas) y tiene una actividad economica de alto riesgo' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_EMISION_ENDOSO AS DATE) AS FECHA_TRANSACCION,        
     CAST('0' AS STRING) AS VALOR_TRANSACCION,     
     CAST(ACTIVIDAD_ECONOMICA AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0050_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0063' AS ALERTA,
    'Pago de siniestro en un tiempo estrictamente menor a 3 meses de emitida la poliza' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,     
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0063_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0064' AS ALERTA,
    'Pago de siniestro a una persona juridica, por un valor mayor a $100.000.000,   en  menos de 3 meses de emitida la poliza' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION,
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION, 
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0064_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0065' AS ALERTA,
    'Pago de siniestro a una persona natural,  por un valor  mayor a $50.000.000,   en  menos de 3 meses de emitida la poliza' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ORDEN_PAGO AS DATE) AS FECHA_TRANSACCION, 
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION, 
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0065_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0066' AS ALERTA,
    'Pago de siniestro a algun tercero diferente al tomador, beneficiario o relacionado en la poliza.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_SINIESTRO AS DATE) AS FECHA_TRANSACCION, 
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0066_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    CAST(DOCUMENTO_TOMADOR AS STRING) AS KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0067' AS ALERTA,
    'Cancelacion anticipada de una poliza emitida en menos de 90 días' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_CANCELACION_DEF AS DATE) AS FECHA_TRANSACCION,     
     CAST('0' AS STRING) AS VALOR_TRANSACCION,
     CAST(DESCRIPCION_ENDOSO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0067_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0068' AS ALERTA,
    'Cambio de beneficiaro y en menos de 90 dias se presenta el pago de siniestro.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_SINIESTRO AS DATE) AS FECHA_TRANSACCION,    
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION,     
     CAST(DESCRIPCION_ENDOSO AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0068_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0072' AS ALERTA,
    'Pago de siniestros en productos de alto riesgo y el beneficiario este catalogado como PEP' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_SINIESTRO AS DATE) AS FECHA_TRANSACCION,     
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION, 
     CAST(CODIGO_CANAL AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0072_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0100' AS ALERTA,
    'Pago de un siniestro a una persona natural y durante el mes ya se ha presentado mas de 2 siniestros.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_SINIESTRO AS DATE) AS FECHA_TRANSACCION,     
     CAST(LIQUIDADO_BOLIVAR AS STRING) AS VALOR_TRANSACCION, 
     CAST(ESTADO_SINIESTRO AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_CONTABLE AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0100_VISOR_REPO`


UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0101' AS ALERTA,
    'Cliente PJ con mas de 5 Productos del mismo ramo activos.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,  
     CAST('0' AS STRING) AS VALOR_TRANSACCION,     
     CAST('0' AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              

FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0101_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0102' AS ALERTA,
    'Tomador se encuentra en una jurisdiccion de alto riesgo por transaccionalidad o residencia y su actividad economica es de alto riesgo para manejar flujos de dinero corriente.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,     
     CAST('0' AS STRING) AS VALOR_TRANSACCION, 
     CAST(municipio_direccion_1 AS STRING) AS FORMA_PAGO_CANAL,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO               
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0102_VISOR_REPO`

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0103' AS ALERTA,
    'Terceros que hacen  pagos por caja a mas de 3 polizas.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_RECAUDO AS DATE) AS FECHA_TRANSACCION,    
     CAST(VALOR_RECAUDO_MES AS STRING) AS VALOR_TRANSACCION,    
     CAST(FORMA_COBRO AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0103_VISOR_REPO`  

UNION ALL

SELECT DISTINCT
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    'COM_0104' AS ALERTA,
    'El pais de nacionalidad o residencia pertenece a una jurisdicción calificada como de alto riesgo.' AS DESCRIPCION_ALERTA,     
    3 AS COMPANIA,
    FECHA_ALERTA_MES,    
    FECHA_ALERTA,
     CAST(FECHA_ALERTA AS DATE) AS FECHA_TRANSACCION,
     CAST('0' AS STRING) AS VALOR_TRANSACCION,     
     CAST(NACIONALIDAD AS STRING) AS FORMA_PAGO_CANAL ,
     CODIGO_RAMO_EMISION AS CODIGO_RAMO,
     CODIGO_PRODUCTO AS CODIGO_PRODUCTO              
FROM
    `sb-sandbox-usuarios.sandbox_cumplimiento.COM_0104_VISOR_REPO`  ) as c



LEFT JOIN sb-sandbox-usuarios.sandbox_cumplimiento.t_terceros_clientes AS p
ON  p.KEY_ID = c.KEY_ID_BENEFICIARIO

LEFT JOIN 
(

    SELECT DISTINCT
    KEY_ID_TOMADOR,
    numero_poliza,
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    CODIGO_PRODUCTO,
    NOMBRE_PRODUCTO,
    CLAVE_AGENTE,
    NOMBRE_LOCALIDAD,
    NOMBRE_CANAL
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_tom_ase_vigentes`

) AS pol
ON  c.TITULO = pol.numero_poliza
and c.KEY_ID_BENEFICIARIO = pol.KEY_ID_TOMADOR

LEFT JOIN(

SELECT 
    TIPO_DOCUMENTO,
    KEY_ID,
    CAST(FEC_NACIMIENTO AS DATE) AS FECHA_NACIMIENTO,
    NACIONALIDAD,
    FECHA_ACTUALIZACION,
    VALOR_INGRESOS,
    VALOR_EGRESOS,
    VALOR_ACTIVO,
    VALOR_PASIVO,
    CODIGO_CIIU,
    ACTIVIDAD_ECONOMICA,
    PUBLICAMENTE_EXPUESTA,
    VINCULO_PERSONA_RECONOCIDA,
    CODIGO_LUGAR_REGISTRO,
    NOMBRE_LUGAR_REGISTRO,
    CODIGO_LUGAR_NACIMIENTO,
    NOMBRE_LUGAR_NACIMIENTO,
    MANEJA_MONEDA_EXTRANJERA,
    CAST(OPERACIONES_INTERNACIONALES AS STRING) AS OPERACIONES_INTERNACIONALES,
    CAST(CODIGO_CODAZZI_DIRECCION_1 AS STRING) AS CODIGO_CODAZZI_DIRECCION_1,
    MUNICIPIO_DIRECCION_1,
    CAST(COD_PROFESION AS STRING) AS COD_PROFESION
FROM 
    `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales`

UNION ALL

SELECT 
    TIPO_DOCUMENTO,
    KEY_ID,
    CAST(FECHA_NACIMIENTO AS DATE) AS FECHA_NACIMIENTO,
    NACIONALIDAD,
    FECHA_ACTUALIZACION,
    VALOR_INGRESOS,
    VALOR_EGRESOS,
    VALOR_ACTIVO,
    VALOR_PASIVO,
    CODIGO_CIIU,
    ACTIVIDAD_ECONOMICA,
    PUBLICAMENTE_EXPUESTA,
    VINCULO_PERSONA_RECONOCIDA,
    CODIGO_LUGAR_REGISTRO,
    NOMBRE_LUGAR_REGISTRO,
    CODIGO_LUGAR_NACIMIENTO,
    NOMBRE_LUGAR_NACIMIENTO,
    MANEJA_MONEDA_EXTRANJERA,
    CAST(OPERACIONES_INTERNACIONALES AS STRING) AS OPERACIONES_INTERNACIONALES,
    CAST(CODIGO_CODAZZI_DIRECCION_1 AS STRING) AS CODIGO_CODAZZI_DIRECCION_1,
    CAST(0 AS STRING) AS MUNICIPIO_DIRECCION_1,  
    CAST(0 AS STRING) AS COD_PROFESION              
FROM 
    `sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_juridicos`

) AS datos

ON    c.KEY_ID_BENEFICIARIO = datos.KEY_ID
AND   c.TIPO_DOCUMENTO = datos.TIPO_DOCUMENTO

LEFT JOIN sb-ecosistemaanalitico-lago.seguros_bolivar.t_terceros_restringidos as list
ON    c.KEY_ID_BENEFICIARIO = list.KEY_ID
AND   c.TIPO_DOCUMENTO = list.TIPO_DOCUMENTO_TERCERO
) 

SELECT 
TIPO_DOCUMENTO,
KEY_ID_BENEFICIARIO,
TITULO,
ALERTA,
DESCRIPCION_ALERTA,
COMPANIA,
FECHA_ALERTA_MES,
FECHA_ALERTA,
  '' AS ESTADO_IDENTIFICACION,
  '' AS OBSERVACIONES_DE_ANALISIS,
  '' AS FECHA_DE_CIERRE_DE_LA_ALERTA,
  '' AS ESTADO_CIERRE,
  '' AS COMENTARIOS_FINALES,
  '' AS ES_ROS,
  '' AS EVIDENCIA_DE_ANALISIS,
  '' AS FECHA_ULTIMA_MODIFICACION,
  '' AS GESTOR,
  '' AS ESTADO_DE_REGISTRO,
  '' AS ID_DUPLICADO_EN_DIFERENTE_CONDICION,
  '' AS ID_DUPLICADO_EN_CONDICION,
  '' AS ID_DUPLICADO_PERO_CON_CATEGORIA_DIFERENTE,
  '' AS ID_ALERTADO_EN_MONITOR,
  '' AS SUBCATEGORIA,
NUMERO_DOCUMENTO,
FECHA_TRANSACCION,
VALOR_TRANSACCION,
FORMA_PAGO_CANAL,
CODIGO_RAMO,
CODIGO_PRODUCTO,
FECHA_NACIMIENTO,
NACIONALIDAD,
FECHA_ACTUALIZACION,
VALOR_INGRESOS,
VALOR_EGRESOS,
VALOR_ACTIVO,
VALOR_PASIVO,
CODIGO_CIIU,
ACTIVIDAD_ECONOMICA,
PUBLICAMENTE_EXPUESTA,
VINCULO_PERSONA_RECONOCIDA,
CODIGO_LUGAR_REGISTRO,
NOMBRE_LUGAR_REGISTRO,
CODIGO_LUGAR_NACIMIENTO,
NOMBRE_LUGAR_NACIMIENTO,
MANEJA_MONEDA_EXTRANJERA,
OPERACIONES_INTERNACIONALES,
CODIGO_CODAZZI_DIRECCION_1,
MUNICIPIO_DIRECCION_1,
COD_PROFESION,
CODIGO_RESTRICCION,
DESCRIPCION
FROM bloque_estructura
