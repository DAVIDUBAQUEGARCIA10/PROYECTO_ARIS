SELECT 
    -- Columnas de la primera consulta
    c.TIPO_DOCUMENTO,
    c.KEY_ID,
    c.FECHA_EXPEDICION,
    c.SEXO,
    c.FEC_NACIMIENTO,
    c.NACIONALIDAD,
    c.ESTADO_CIVIL,
    c.VINCULACION_LABORAL,
    c.ESTRATO_SOCIAL,
    c.EMPRESA_TRABAJA,
    c.CARGO,
    c.FECHA_ACTUALIZACION,
    c.VALOR_EGRESOS,
    c.VALOR_INGRESOS,
    c.VALOR_ACTIVO,
    c.VALOR_PASIVO,
    c.VALOR_PATRIMONIO,
    c.CODIGO_CIIU,
    c.ACTIVIDAD_ECONOMICA,
    c.PUBLICAMENTE_EXPUESTA,
    
    -- Columnas de la segunda consulta
    p.CODIGO_COMPANIA,
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,
    p.CODIGO_PRODUCTO,
    p.NOMBRE_PRODUCTO,
    p.NUMERO_POLIZA,
    
    -- Suma de VALOR_ASEGURADO por NUMERO_POLIZA
    SUM(p.VALOR_ASEGURADO) AS VALOR_ASEGURADO_TOTAL,

    p.COD_MOTIVO_CANCELACION_POLIZA,
    p.DES_MOTIVO_CANCELACION_POLIZA,
    
    -- Funciones de agregaciÃ³n para las fechas
    MAX(CAST(p.FECHA_EMISION_ENDOSO AS DATE)) AS FECHA_EMISION_ENDOSO,
    MAX(CAST(p.FECHA_INICIO_ENDOSO AS DATE)) AS FECHA_INICIO_ENDOSO,
    MAX(CAST(p.FECHA_FIN_ENDOSO AS DATE)) AS FECHA_FIN_ENDOSO,
    MAX(CAST(p.FECHA_INICIO_POLIZA AS DATE)) AS FECHA_INICIO_POLIZA,
    MAX(CAST(p.FECHA_FIN_POLIZA AS DATE)) AS FECHA_FIN_POLIZA
FROM 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_clientes_naturales c
INNER JOIN 
    sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos p
    ON c.TIPO_DOCUMENTO = p.TIPO_DOCUMENTO_TOMADOR
    AND c.KEY_ID = p.KEY_ID_TOMADOR
WHERE 
    c.PUBLICAMENTE_EXPUESTA = 'S' 
    AND p.FECHA_FIN_POLIZA > '2024-11-01'
    AND p.FECHA_FIN_ENDOSO > '2024-11-01'
    AND p.VALOR_ASEGURADO > 0
GROUP BY
    c.TIPO_DOCUMENTO,
    c.KEY_ID,
    c.FECHA_EXPEDICION,
    c.SEXO,
    c.FEC_NACIMIENTO,
    c.NACIONALIDAD,
    c.ESTADO_CIVIL,
    c.VINCULACION_LABORAL,
    c.ESTRATO_SOCIAL,
    c.EMPRESA_TRABAJA,
    c.CARGO,
    c.FECHA_ACTUALIZACION,
    c.VALOR_EGRESOS,
    c.VALOR_INGRESOS,
    c.VALOR_ACTIVO,
    c.VALOR_PASIVO,
    c.VALOR_PATRIMONIO,
    c.CODIGO_CIIU,
    c.ACTIVIDAD_ECONOMICA,
    c.PUBLICAMENTE_EXPUESTA,
    p.CODIGO_COMPANIA,
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,
    p.CODIGO_PRODUCTO,
    p.NOMBRE_PRODUCTO,
    p.NUMERO_POLIZA,
    p.COD_MOTIVO_CANCELACION_POLIZA,
    p.DES_MOTIVO_CANCELACION_POLIZA
ORDER BY 
    p.NUMERO_POLIZA;
