DECLARE periodo_max_primas DATE;
DECLARE periodo_max_siniestros TIMESTAMP;

-- 1) Último periodo disponible por FECHA_PROCESO en primas
SET periodo_max_primas = (
  SELECT MAX(DATE(FECHA_PROCESO))
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
);

-- 2) Último periodo disponible para siniestros pagados
SET periodo_max_siniestros = (
  SELECT MAX(FECHA_PROCESO)
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
  WHERE ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
    AND LIQUIDADO_BOLIVAR > 0
);

-- 3) Query principal: PRIMAS + SINIESTROS agrupado por RAMO
WITH datos_base AS (
  SELECT
    -- Llave de agregación
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,

    -- Métricas de PRIMAS
    SUM(p.PRIMA_ANUAL_TOTAL) AS PRIMA_ANUAL_TOTAL,
    SUM(p.CANTIDAD_POLIZAS) AS CANTIDAD_POLIZAS,
    p.PERIODO_CONSULTADO AS PERIODO_PRIMAS,

    -- Métricas de SINIESTROS
    SUM(IFNULL(s.SINIESTRO_LIQUIDADO_TOTAL, 0)) AS SINIESTRO_LIQUIDADO_TOTAL,
    SUM(IFNULL(s.CANTIDAD_SINIESTROS, 0)) AS CANTIDAD_SINIESTROS,
    periodo_max_siniestros AS PERIODO_SINIESTROS,

    -- Exposición LAFT
    CASE p.CODIGO_RAMO_EMISION
      -- EXPOSICIÓN BAJA (1)
        WHEN 1   THEN 1  -- AUTOMOVILES
        WHEN 3   THEN 1  -- CORRIENTE DEBIL
        WHEN 4   THEN 1  -- CUMPLIMIENTO
        WHEN 5   THEN 1  -- INCENDIO
        WHEN 8   THEN 1  -- ROTURA DE MAQUINARIA
        WHEN 9   THEN 1  -- NAVEGACION
        WHEN 10  THEN 1  -- RESPONSABILIDAD CIVIL
        WHEN 12  THEN 1  -- SUSTRACCION
        WHEN 14  THEN 1  -- TODO RIESGO
        WHEN 18  THEN 1  -- ACCIDENTES PERSONALES
        WHEN 26  THEN 1  -- ACCIDENTES ESCOLARES
        WHEN 30  THEN 1  -- ACCIDENTES PERSONALES
        WHEN 34  THEN 1  -- SALUD
        WHEN 37  THEN 1  -- ARRENDAMIENTO
        WHEN 39  THEN 1  -- SEGURO AGRICOLA
        WHEN 56  THEN 1  -- HOTELERO
        WHEN 66  THEN 1  -- MULTIRRIESGO INDUSTRIAL
        WHEN 70  THEN 1  -- ADMINISTRADORA DE RIESGOS PROF
        WHEN 118 THEN 1  -- ACCIDENTES PERSONALES INDIVID.
        WHEN 310 THEN 1  -- SOAT
        WHEN 923 THEN 1  -- OFERTAS DE PROTECCION GENERAL

        -- EXPOSICIÓN MEDIA (2)
        WHEN 7   THEN 2  -- MANEJO
        WHEN 15  THEN 2  -- TRANSPORTES
        WHEN 20  THEN 2  -- GRUPO
        WHEN 21  THEN 2  -- GRUPO PLAN CRECIENTE
        WHEN 22  THEN 2  -- DEUDORES
        WHEN 23  THEN 2  -- HOGAR
        WHEN 24  THEN 2  -- GRUPO EDUCATIVO
        WHEN 25  THEN 2  -- ULTIMOS GASTOS
        WHEN 29  THEN 2  -- GRUPO - PLAN NIVELADO
        WHEN 32  THEN 2  -- GRUPO TRADICIONAL
        WHEN 33  THEN 2  -- DESEMPLEO
        WHEN 48  THEN 2  -- VIDA CONJUNTO
        WHEN 922 THEN 2  -- OFERTAS DE PROTECCION PERSONAS

        -- EXPOSICIÓN ALTA (3)
        WHEN 40  THEN 3  -- VIDA INDIVIDUAL
        WHEN 42  THEN 3  -- VIDA INDIVIDUAL BANCASEGUROS
        WHEN 46  THEN 3  -- VIDA INDIVIDUAL
        WHEN 47  THEN 3  -- VIDA INDIVIDUAL
        WHEN 50  THEN 3  -- VIDA INDIVIDUAL MIGRACION
        WHEN 68  THEN 3  -- RAMOS PREVISIONALES
        WHEN 69  THEN 3  -- PENSIONES LEY 100
        WHEN 72  THEN 3  -- RENTAS VOLUNTARIAS
        WHEN 801 THEN 3  -- TITULOS DE CAPITALIZACION
        WHEN 140 THEN 3  -- SEGUROS DE VIDA (ANTIGUOS)

        -- NO DOCUMENTADO / CONSERVADOR
        WHEN 81  THEN 1  -- NO DOCUMENTADO EN LISTADO

        ELSE 1  -- Default conservador: exposición baja
    END AS EXPOSICION_LAFT,

    -- Tipologías Aplicadas
    CASE p.CODIGO_RAMO_EMISION
        -- EXPOSICIÓN BAJA (1)
        WHEN 1   THEN 0  -- AUTOMOVILES
        WHEN 3   THEN 0  -- CORRIENTE DEBIL
        WHEN 4   THEN 1  -- CUMPLIMIENTO
        WHEN 5   THEN 1  -- INCENDIO
        WHEN 8   THEN 1  -- ROTURA DE MAQUINARIA
        WHEN 9   THEN 1  -- NAVEGACION
        WHEN 10  THEN 1  -- RESPONSABILIDAD CIVIL
        WHEN 12  THEN 1  -- SUSTRACCION
        WHEN 14  THEN 1  -- TODO RIESGO
        WHEN 18  THEN 1  -- ACCIDENTES PERSONALES
        WHEN 26  THEN 1  -- ACCIDENTES ESCOLARES
        WHEN 30  THEN 1  -- ACCIDENTES PERSONALES
        WHEN 34  THEN 0  -- SALUD
        WHEN 37  THEN 1  -- ARRENDAMIENTO
        WHEN 39  THEN 1  -- SEGURO AGRICOLA
        WHEN 56  THEN 1  -- HOTELERO
        WHEN 66  THEN 1  -- MULTIRRIESGO INDUSTRIAL
        WHEN 70  THEN 1  -- ADMINISTRADORA DE RIESGOS PROF
        WHEN 118 THEN 1  -- ACCIDENTES PERSONALES INDIVID.
        WHEN 310 THEN 1  -- SOAT
        WHEN 923 THEN 1  -- OFERTAS DE PROTECCION GENERAL

        -- EXPOSICIÓN MEDIA (2)
        WHEN 7   THEN 2  -- MANEJO
        WHEN 15  THEN 2  -- TRANSPORTES
        WHEN 20  THEN 2  -- GRUPO
        WHEN 21  THEN 2  -- GRUPO PLAN CRECIENTE
        WHEN 22  THEN 2  -- DEUDORES
        WHEN 23  THEN 2  -- HOGAR
        WHEN 24  THEN 2  -- GRUPO EDUCATIVO
        WHEN 25  THEN 2  -- ULTIMOS GASTOS
        WHEN 29  THEN 2  -- GRUPO - PLAN NIVELADO
        WHEN 32  THEN 2  -- GRUPO TRADICIONAL
        WHEN 33  THEN 2  -- DESEMPLEO
        WHEN 48  THEN 2  -- VIDA CONJUNTO
        WHEN 922 THEN 2  -- OFERTAS DE PROTECCION PERSONAS

        -- EXPOSICIÓN ALTA (3)
        WHEN 40  THEN 3  -- VIDA INDIVIDUAL
        WHEN 42  THEN 3  -- VIDA INDIVIDUAL BANCASEGUROS
        WHEN 46  THEN 3  -- VIDA INDIVIDUAL
        WHEN 47  THEN 3  -- VIDA INDIVIDUAL
        WHEN 50  THEN 3  -- VIDA INDIVIDUAL MIGRACION
        WHEN 68  THEN 3  -- RAMOS PREVISIONALES
        WHEN 69  THEN 3  -- PENSIONES LEY 100
        WHEN 72  THEN 3  -- RENTAS VOLUNTARIAS
        WHEN 801 THEN 3  -- TITULOS DE CAPITALIZACION
        WHEN 140 THEN 3  -- SEGUROS DE VIDA (ANTIGUOS)

        -- NO DOCUMENTADO / CONSERVADOR
        WHEN 81  THEN 1  -- NO DOCUMENTADO EN LISTADO

        ELSE 1  -- Default conservador: exposición baja

    END AS TIPOLOGIAS_APLICADAS

  FROM (
    -- Subquery de PRIMAS
    SELECT
      CODIGO_RAMO_EMISION,
      NOMBRE_RAMO_EMISION,
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR,
      SUM(PRIMA_ANUAL) AS PRIMA_ANUAL_TOTAL,
      COUNT(DISTINCT NUMERO_POLIZA) AS CANTIDAD_POLIZAS,
      periodo_max_primas AS PERIODO_CONSULTADO
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
    WHERE
      DATE(FECHA_PROCESO) = periodo_max_primas
      AND DATE(FECHA_FIN_ENDOSO) >= CURRENT_DATE()
      AND DATE(FECHA_FIN_POLIZA) >= CURRENT_DATE() and PRIMA_ANUAL > 0
    GROUP BY
      CODIGO_RAMO_EMISION,
      NOMBRE_RAMO_EMISION,
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR
  ) p

  LEFT JOIN (
    -- Subquery de SINIESTROS
    SELECT
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR,
      SUM(LIQUIDADO_BOLIVAR) AS SINIESTRO_LIQUIDADO_TOTAL,
      COUNT(DISTINCT NUMERO_SECUENCIA_POLIZA) AS CANTIDAD_SINIESTROS,
      periodo_max_siniestros AS PERIODO_CONSULTADO
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE
      FECHA_PROCESO = periodo_max_siniestros
      AND ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
      AND LIQUIDADO_BOLIVAR > 0
    GROUP BY
      KEY_ID_TOMADOR,
      NUMERO_POLIZA,
      NUMERO_SECUENCIA_POLIZA,
      TIPO_DOCUMENTO_TOMADOR
  ) s
    ON p.KEY_ID_TOMADOR = s.KEY_ID_TOMADOR
    AND p.TIPO_DOCUMENTO_TOMADOR = s.TIPO_DOCUMENTO_TOMADOR
    AND p.NUMERO_POLIZA = s.NUMERO_POLIZA
    AND p.NUMERO_SECUENCIA_POLIZA = s.NUMERO_SECUENCIA_POLIZA

  GROUP BY
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,
    p.PERIODO_CONSULTADO,
    periodo_max_siniestros
),

calculos_intermedios AS (
  SELECT
    *,
    -- Total de siniestros de todos los ramos
    SUM(SINIESTRO_LIQUIDADO_TOTAL) OVER() AS TOTAL_SINIESTROS_GLOBAL,
    
    -- pR = Siniestros del ramo / Total siniestros de todos los ramos
    SAFE_DIVIDE(SINIESTRO_LIQUIDADO_TOTAL, SUM(SINIESTRO_LIQUIDADO_TOTAL) OVER()) AS pR,
    
    -- sR = Siniestros pagados / Primas emitidas
    SAFE_DIVIDE(SINIESTRO_LIQUIDADO_TOTAL, PRIMA_ANUAL_TOTAL) AS sR,
    
    -- DR = Índice por tipologías (dicotómica: 1 si tiene tipología, 0 si no)
    CASE WHEN TIPOLOGIAS_APLICADAS > 0 THEN 1 ELSE 0 END AS DR
    
  FROM datos_base
),

calculos_finales AS (
  SELECT
    *,
    -- Riesgo Inherente = pR × sR × DR
    (pR * sR * DR) AS RIESGO_INHERENTE,
    
    -- Suma total de Riesgo Inherente para calcular el porcentaje
    SUM(pR * sR * DR) OVER() AS SUMA_TOTAL_RIESGO_INHERENTE
    
  FROM calculos_intermedios
)

SELECT
  CODIGO_RAMO_EMISION,
  NOMBRE_RAMO_EMISION,
  PRIMA_ANUAL_TOTAL,
  CANTIDAD_POLIZAS,
  PERIODO_PRIMAS,
  SINIESTRO_LIQUIDADO_TOTAL,
  CANTIDAD_SINIESTROS,
  PERIODO_SINIESTROS,
  EXPOSICION_LAFT,
  TIPOLOGIAS_APLICADAS,
  
  -- Nuevas columnas calculadas
  ROUND(pR * 100, 2) AS pR_PORCENTAJE,
  ROUND(sR * 100, 2) AS sR_PORCENTAJE,
  DR AS INDICE_TIPOLOGIAS,
  
  -- Quintil (Impacto) basado en sR
  CASE 
    WHEN sR <= 0.20 THEN 'Bajo'
    WHEN sR <= 0.40 THEN 'Medio Bajo'
    WHEN sR <= 0.60 THEN 'Medio'
    WHEN sR <= 0.80 THEN 'Medio Alto'
    ELSE 'Alto'
  END AS QUINTIL_IMPACTO,
  
  ROUND(RIESGO_INHERENTE, 6) AS RIESGO_INHERENTE,
  ROUND(SUMA_TOTAL_RIESGO_INHERENTE * 100, 2) AS RESULTADO_FINAL_PORCENTAJE

FROM calculos_finales

ORDER BY
  PRIMA_ANUAL_TOTAL DESC;
