DECLARE periodo_max_primas DATE;
DECLARE periodo_max_siniestros TIMESTAMP;

-- 1) 칔ltimo periodo disponible por FECHA_PROCESO en primas
SET periodo_max_primas = (
  SELECT MAX(DATE(FECHA_PROCESO))
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
);

-- 2) 칔ltimo periodo disponible para siniestros pagados
SET periodo_max_siniestros = (
  SELECT MAX(FECHA_PROCESO)
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
  WHERE ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
    AND LIQUIDADO_BOLIVAR > 0
);

-- 3) Query principal: PRIMAS + SINIESTROS agrupado por RAMO
WITH datos_base AS (
  SELECT
    -- Llave de agregaci칩n
    p.CODIGO_COMPANIA,
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,

    -- M칠tricas de PRIMAS
    SUM(p.PRIMA_ANUAL_TOTAL) AS PRIMA_ANUAL_TOTAL,
    SUM(p.CANTIDAD_POLIZAS) AS CANTIDAD_POLIZAS,
    p.PERIODO_CONSULTADO AS PERIODO_PRIMAS,

    -- M칠tricas de SINIESTROS
    SUM(IFNULL(s.SINIESTRO_LIQUIDADO_TOTAL, 0)) AS SINIESTRO_LIQUIDADO_TOTAL,
    SUM(IFNULL(s.CANTIDAD_SINIESTROS, 0)) AS CANTIDAD_SINIESTROS,
    periodo_max_siniestros AS PERIODO_SINIESTROS,

    -- Tipolog칤as Aplicadas
    CASE p.CODIGO_RAMO_EMISION
        -- EXPOSICI칍N BAJA (1)
        WHEN 1   THEN 1  -- AUTOMOVILES - Fraude en siniestros, Uso de testaferros, Cambio por activos de lujo, Empresas fachada, Sobrefacturaci칩n
        WHEN 3   THEN 1  -- CORRIENTE DEBIL - fRAUDE
        WHEN 4   THEN 1  -- CUMPLIMIENTO - Empresas fachada, Uso de testaferros
        WHEN 5   THEN 1  -- INCENDIO - Fraude en siniestros, Inversi칩n en bienes ra칤ces, Uso de testaferros
        WHEN 8   THEN 1  -- ROTURA DE MAQUINARIA - Fraude en siniestros, Empresas fachada
        WHEN 9   THEN 1  -- NAVEGACION - Fraude en siniestros, Exportaciones ficticias, Uso de testaferros
        WHEN 10  THEN 1  -- RESPONSABILIDAD CIVIL - Empresas fachada, Fraude en siniestros
        WHEN 12  THEN 1  -- SUSTRACCION - Fraude en siniestros, Uso de testaferros
        WHEN 14  THEN 1  -- TODO RIESGO - Fraude en siniestros, Cambio por activos de lujo
        WHEN 18  THEN 1  -- ACCIDENTES PERSONALES - Fraude en siniestros, Loter칤as ficticias
        WHEN 26  THEN 1  -- ACCIDENTES ESCOLARES - Fraude en siniestros
        WHEN 30  THEN 1  -- ACCIDENTES PERSONALES - Fraude en siniestros, Loter칤as ficticias
        WHEN 34  THEN 1  -- SALUD - Fraude
        WHEN 37  THEN 1  -- ARRENDAMIENTO - Inversi칩n en bienes ra칤ces, Uso de testaferros
        WHEN 39  THEN 1  -- SEGURO AGRICOLA - Empresas fachada, Fraude en siniestros
        WHEN 56  THEN 1  -- HOTELERO - Inversi칩n en bienes ra칤ces, Empresas fachada, Fraude en siniestros
        WHEN 66  THEN 1  -- MULTIRRIESGO INDUSTRIAL - Empresas fachada, Fraude en siniestros
        WHEN 70  THEN 1  -- ADMINISTRADORA DE RIESGOS PROF - Empresas fachada, Uso de intermediarios
        WHEN 118 THEN 1  -- ACCIDENTES PERSONALES INDIVID. - Fraude en siniestros, Loter칤as ficticias
        WHEN 310 THEN 1  -- SOAT - Fraude en siniestros, Pitufeo
        WHEN 923 THEN 1  -- OFERTAS DE PROTECCION GENERAL - Fraude en siniestros, Uso de intermediarios

        -- EXPOSICI칍N MEDIA (2)
        WHEN 7   THEN 2  -- MANEJO - Fraude en siniestros, Uso de testaferros, Empresas fachada
        WHEN 15  THEN 2  -- TRANSPORTES - Fraude en siniestros, Exportaciones ficticias, Sobrefacturaci칩n, Empresas fachada
        WHEN 20  THEN 2  -- GRUPO - Seguros colectivos/masivos, Uso de intermediarios, Pitufeo
        WHEN 21  THEN 2  -- GRUPO PLAN CRECIENTE - Seguros colectivos/masivos, Rescate anticipado, Uso de intermediarios
        WHEN 22  THEN 2  -- DEUDORES - Seguros colectivos/masivos, Empresas fachada, Uso de intermediarios
        WHEN 23  THEN 2  -- HOGAR - Fraude en siniestros, Inversi칩n en bienes ra칤ces, Cambio por activos de lujo
        WHEN 24  THEN 2  -- GRUPO EDUCATIVO - Seguros colectivos/masivos, Uso de intermediarios
        WHEN 25  THEN 2  -- ULTIMOS GASTOS - Fraude en siniestros, Loter칤as ficticias
        WHEN 29  THEN 2  -- GRUPO - PLAN NIVELADO - Seguros colectivos/masivos, Rescate anticipado, Uso de intermediarios
        WHEN 32  THEN 2  -- GRUPO TRADICIONAL - Seguros colectivos/masivos, Uso de intermediarios
        WHEN 33  THEN 2  -- DESEMPLEO - Fraude en siniestros, Loter칤as ficticias
        WHEN 48  THEN 2  -- VIDA CONJUNTO - Rescate anticipado, Fraude en siniestros, Uso de testaferros
        WHEN 922 THEN 2  -- OFERTAS DE PROTECCION PERSONAS - Fraude en siniestros, Uso de intermediarios

        -- EXPOSICI칍N ALTA (3)
        WHEN 40  THEN 3  -- VIDA INDIVIDUAL - Compra con recursos il칤citos, Rescate anticipado, Fraude en siniestros, Cambio por activos de lujo, Uso de testaferros
        WHEN 42  THEN 3  -- VIDA INDIVIDUAL BANCASEGUROS - Compra con recursos il칤citos, Rescate anticipado, Pitufeo, Uso de testaferros, Para칤sos fiscales
        WHEN 46  THEN 3  -- VIDA INDIVIDUAL - Compra con recursos il칤citos, Rescate anticipado, Fraude en siniestros, Cambio por activos de lujo, Uso de testaferros
        WHEN 47  THEN 3  -- VIDA INDIVIDUAL - Compra con recursos il칤citos, Rescate anticipado, Fraude en siniestros, Cambio por activos de lujo, Uso de testaferros
        WHEN 50  THEN 3  -- VIDA INDIVIDUAL MIGRACION - Compra con recursos il칤citos, Rescate anticipado, Para칤sos fiscales, Uso de testaferros
        WHEN 68  THEN 3  -- RAMOS PREVISIONALES - Compra con recursos il칤citos, Rescate anticipado, Empresas fachada, Uso de testaferros, Fideicomisos
        WHEN 69  THEN 3  -- PENSIONES LEY 100 - Compra con recursos il칤citos, Rescate anticipado, Empresas fachada, Fideicomisos
        WHEN 72  THEN 3  -- RENTAS VOLUNTARIAS - Compra con recursos il칤citos, Rescate anticipado, Para칤sos fiscales, Empresas fachada
        WHEN 801 THEN 3  -- TITULOS DE CAPITALIZACION - Compra con recursos il칤citos, Rescate anticipado, Cambio por activos de lujo, Loter칤as ficticias, Para칤sos fiscales
        WHEN 140 THEN 3  -- SEGUROS DE VIDA (ANTIGUOS) - Compra con recursos il칤citos, Rescate anticipado, Fraude en siniestros, Uso de testaferros

        -- NO DOCUMENTADO / CONSERVADOR
        WHEN 81  THEN 1  -- NO DOCUMENTADO EN LISTADO - Fraude en siniestros
        ELSE 1  -- Default conservador: exposici칩n baja
    END AS TIPOLOGIAS_APLICADAS

  FROM (
    -- Subquery de PRIMAS
    SELECT
      CODIGO_COMPANIA,
      CODIGO_RAMO_EMISION,
      NOMBRE_RAMO_EMISION,
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR,
      SUM(PRIMA_ANUAL) AS PRIMA_ANUAL_TOTAL,
      COUNT(DISTINCT NUMERO_POLIZA) AS CANTIDAD_POLIZAS,
      periodo_max_primas AS PERIODO_CONSULTADO
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
    WHERE
      DATE(FECHA_PROCESO) = periodo_max_primas
      AND DATE(FECHA_FIN_ENDOSO) >= CURRENT_DATE()
      AND DATE(FECHA_FIN_POLIZA) >= CURRENT_DATE() 
      AND PRIMA_ANUAL > 0
    GROUP BY
      CODIGO_COMPANIA,
      CODIGO_RAMO_EMISION,
      NOMBRE_RAMO_EMISION,
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR
  ) p

  LEFT JOIN (
    -- Subquery de SINIESTROS
    SELECT
      CODIGO_COMPANIA,
      NUMERO_SECUENCIA_POLIZA,
      NUMERO_POLIZA,
      TIPO_DOCUMENTO_TOMADOR,
      KEY_ID_TOMADOR,
      SUM(LIQUIDADO_BOLIVAR) AS SINIESTRO_LIQUIDADO_TOTAL,
      COUNT(DISTINCT NUMERO_SECUENCIA_POLIZA) AS CANTIDAD_SINIESTROS,
      periodo_max_siniestros AS PERIODO_CONSULTADO
    FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
    WHERE
      FECHA_PROCESO = periodo_max_siniestros
      AND ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
      AND LIQUIDADO_BOLIVAR > 0
    GROUP BY
      CODIGO_COMPANIA,
      KEY_ID_TOMADOR,
      NUMERO_POLIZA,
      NUMERO_SECUENCIA_POLIZA,
      TIPO_DOCUMENTO_TOMADOR
  ) s
    ON p.KEY_ID_TOMADOR = s.KEY_ID_TOMADOR
    AND p.TIPO_DOCUMENTO_TOMADOR = s.TIPO_DOCUMENTO_TOMADOR
    AND p.NUMERO_POLIZA = s.NUMERO_POLIZA
    AND p.NUMERO_SECUENCIA_POLIZA = s.NUMERO_SECUENCIA_POLIZA

  GROUP BY
    p.CODIGO_COMPANIA,
    p.CODIGO_RAMO_EMISION,
    p.NOMBRE_RAMO_EMISION,
    p.PERIODO_CONSULTADO,
    periodo_max_siniestros
),

calculos_intermedios AS (
  SELECT
    *,
    -- Total de siniestros POR COMPA칌칈A (PARTITION BY CODIGO_COMPANIA)
    SUM(SINIESTRO_LIQUIDADO_TOTAL) OVER(PARTITION BY CODIGO_COMPANIA) AS TOTAL_SINIESTROS_POR_COMPANIA,
    
    -- pR = Siniestros del ramo / Total siniestros de la compa침칤a
    SAFE_DIVIDE(
      SINIESTRO_LIQUIDADO_TOTAL, 
      SUM(SINIESTRO_LIQUIDADO_TOTAL) OVER(PARTITION BY CODIGO_COMPANIA)
    ) AS pR,
    
    -- sR = Siniestros pagados / Primas emitidas
    SAFE_DIVIDE(SINIESTRO_LIQUIDADO_TOTAL, PRIMA_ANUAL_TOTAL) AS sR,
    
    -- DR = 칈ndice por tipolog칤as (dicot칩mica: 1 si tiene tipolog칤a, 0 si no)
    CASE WHEN TIPOLOGIAS_APLICADAS > 0 THEN 1 ELSE 0 END AS DR
    
  FROM datos_base
),

calculos_finales AS (
  SELECT
    *,
    -- Riesgo Inherente = pR 칑 sR 칑 DR
    (pR * sR * DR) AS RIESGO_INHERENTE,
    
    -- Suma total de Riesgo Inherente POR COMPA칌칈A (PARTITION BY CODIGO_COMPANIA)
    SUM(pR * sR * DR) OVER(PARTITION BY CODIGO_COMPANIA) AS SUMA_TOTAL_RIESGO_INHERENTE_COMPANIA
    
  FROM calculos_intermedios
)

SELECT
  CODIGO_COMPANIA,
  CODIGO_RAMO_EMISION,
  NOMBRE_RAMO_EMISION,
  PRIMA_ANUAL_TOTAL,
  CANTIDAD_POLIZAS,
  PERIODO_PRIMAS,
  SINIESTRO_LIQUIDADO_TOTAL,
  CANTIDAD_SINIESTROS,
  PERIODO_SINIESTROS,
  TIPOLOGIAS_APLICADAS,
  
  -- Total de siniestros de la compa침칤a (para validaci칩n)
  TOTAL_SINIESTROS_POR_COMPANIA,
  
  -- Nuevas columnas calculadas
  ROUND(pR * 100, 2) AS pR_PORCENTAJE,
  ROUND(sR * 100, 2) AS sR_PORCENTAJE,
  DR AS INDICE_TIPOLOGIAS,
  
  -- Quintil (Impacto) basado en sR
  CASE 
    WHEN sR <= 0.20 THEN '游릭 Bajo'
    WHEN sR <= 0.40 THEN '游릭 Medio Bajo'
    WHEN sR <= 0.60 THEN '游리  Medio'
    WHEN sR <= 0.80 THEN '游리  Medio Alto'
    ELSE '游댮 Alto'
  END AS QUINTIL_IMPACTO,
  
  ROUND(RIESGO_INHERENTE, 6) AS RIESGO_INHERENTE,
  
  -- RESULTADO FINAL POR COMPA칌칈A (se repite el mismo valor para todos los ramos de la misma compa침칤a)
  ROUND(SUMA_TOTAL_RIESGO_INHERENTE_COMPANIA * 100, 2) AS RESULTADO_FINAL_PORCENTAJE

FROM calculos_finales

ORDER BY
  CODIGO_COMPANIA,
  PRIMA_ANUAL_TOTAL DESC;
