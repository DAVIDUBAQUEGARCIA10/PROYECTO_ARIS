DECLARE periodo_max_primas DATE;
DECLARE periodo_max_siniestros TIMESTAMP;

-- 1) Último periodo disponible por FECHA_PROCESO en primas
SET periodo_max_primas = (
  SELECT MAX(DATE(FECHA_PROCESO))
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
);

-- 2) Último periodo disponible para siniestros pagados
SET periodo_max_siniestros = (
  SELECT MAX(FECHA_PROCESO)
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
  WHERE ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
    AND LIQUIDADO_BOLIVAR > 0
);

-- 3) Query principal: PRIMAS + SINIESTROS agrupado por RAMO
SELECT
  -- Llave de agregación
  p.CODIGO_RAMO_EMISION,
  p.NOMBRE_RAMO_EMISION,

  -- Métricas de PRIMAS
  SUM(p.PRIMA_ANUAL_TOTAL) AS PRIMA_ANUAL_TOTAL,
  SUM(p.CANTIDAD_POLIZAS) AS CANTIDAD_POLIZAS,
  p.PERIODO_CONSULTADO AS PERIODO_PRIMAS,

  -- Métricas de SINIESTROS
  SUM(IFNULL(s.SINIESTRO_LIQUIDADO_TOTAL, 0)) AS SINIESTRO_LIQUIDADO_TOTAL,
  SUM(IFNULL(s.CANTIDAD_SINIESTROS, 0)) AS CANTIDAD_SINIESTROS,
  periodo_max_siniestros AS PERIODO_SINIESTROS

FROM (
  -- Subquery de PRIMAS
  SELECT
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    SUM(PRIMA_ANUAL) AS PRIMA_ANUAL_TOTAL,
    COUNT(DISTINCT NUMERO_POLIZA) AS CANTIDAD_POLIZAS,
    periodo_max_primas AS PERIODO_CONSULTADO
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_polizas_riesgos_endosos`
  WHERE
    DATE(FECHA_PROCESO) = periodo_max_primas
    AND DATE(FECHA_FIN_ENDOSO) >= CURRENT_DATE()
    AND DATE(FECHA_FIN_POLIZA) >= CURRENT_DATE()
  GROUP BY
    CODIGO_RAMO_EMISION,
    NOMBRE_RAMO_EMISION,
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR
) p

LEFT JOIN (
  -- Subquery de SINIESTROS
  SELECT
    NUMERO_SECUENCIA_POLIZA,
    NUMERO_POLIZA,
    TIPO_DOCUMENTO_TOMADOR,
    KEY_ID_TOMADOR,
    SUM(LIQUIDADO_BOLIVAR) AS SINIESTRO_LIQUIDADO_TOTAL,
    COUNT(DISTINCT NUMERO_SECUENCIA_POLIZA) AS CANTIDAD_SINIESTROS,
    periodo_max_siniestros AS PERIODO_CONSULTADO
  FROM `sb-ecosistemaanalitico-lago.seguros_bolivar.t_siniestros`
  WHERE
    FECHA_PROCESO = periodo_max_siniestros
    AND ESTADO_SINIESTRO_CALCULADO = 'PAGADO'
    AND LIQUIDADO_BOLIVAR > 0
  GROUP BY
    KEY_ID_TOMADOR,
    NUMERO_POLIZA,
    NUMERO_SECUENCIA_POLIZA,
    TIPO_DOCUMENTO_TOMADOR
) s
  ON p.KEY_ID_TOMADOR = s.KEY_ID_TOMADOR
  AND p.TIPO_DOCUMENTO_TOMADOR = s.TIPO_DOCUMENTO_TOMADOR
  AND p.NUMERO_POLIZA = s.NUMERO_POLIZA
  AND p.NUMERO_SECUENCIA_POLIZA = s.NUMERO_SECUENCIA_POLIZA

GROUP BY
  p.CODIGO_RAMO_EMISION,
  p.NOMBRE_RAMO_EMISION,
  p.PERIODO_CONSULTADO,
  periodo_max_siniestros

ORDER BY
  PRIMA_ANUAL_TOTAL DESC;
